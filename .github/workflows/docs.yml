# =============================================================================
# Deploy Website: build MkDocs site (RU/EN) and deploy to GitHub Pages
# =============================================================================
# Structure:
#   - docs/ (root) — documentation source files with YAML front matter
#   - website/ — build configuration (mkdocs.yml, hooks, overrides, etc.)
# 
# Workflow steps:
# 1. Copy docs/ → website/docs/, README as index per language
# 2. Build: mkdocs build → site/ (default RU at root /, EN at site/en/)
# 3. 404.html is generated by docs_hooks from site layout (same header/nav as site). Copy CNAME, robots.txt
# 4. Deploy ./site/ → gh-pages (GitHub Pages serves 404.html for any 404)
# 
# Result: https://coreness.tech (custom domain via CNAME)
# =============================================================================

name: Deploy Website

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'website/**'
      - 'README.md'
      - 'README_EN.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install MkDocs and plugins
        run: |
          pip install mkdocs "mkdocs-material>=9.5" "pymdown-extensions>=10" mkdocs-static-i18n

      - name: Copy documentation to website
        run: |
          cp -r docs website/docs
          
      - name: Use project README as site home
        run: |
          cp README_EN.md website/docs/en/index.md
          cp README.md website/docs/ru/index.md
          cp LICENSE website/docs/LICENSE.md
          sed -i 's|\](docs/en/|\](|g' website/docs/en/index.md
          sed -i 's|\](docs/ru/|\](|g' website/docs/ru/index.md
          sed -i 's|\](README\.md)|\](/)|g' website/docs/en/index.md
          sed -i 's|\](README_EN\.md)|\](/en/)|g' website/docs/ru/index.md
          sed -i 's|\](LICENSE)|\](../LICENSE.md)|g' website/docs/en/index.md
          sed -i 's|\](LICENSE)|\](../LICENSE.md)|g' website/docs/ru/index.md

      - name: Build MkDocs site
        run: |
          cd website
          mkdocs build

      - name: Copy additional files to site
        run: |
          cp website/404.html site/404.html
          cp website/CNAME site/CNAME
          cp website/robots.txt site/robots.txt

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          force_orphan: true
          cname: coreness.tech
