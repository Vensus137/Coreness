services:
  app-test:
    extends:
      file: docker-compose.yml
      service: app
    image: app-test:latest
    container_name: app-test
    environment:
      - ENVIRONMENT=test
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    # Inherits from base: volumes (..:/workspace + supervisord.conf) and command (supervisord).
    # Port forwarding for webhooks (GitHub and Telegram) - test environment
    ports:
      - "8443:8443"  # HTTPS server for webhooks (test) - port 8443 allowed by Telegram
    depends_on:
      postgres-test:
        condition: service_healthy

  postgres-test:
    extends:
      file: docker-compose.yml
      service: postgres
    container_name: postgres-test
    environment:
      POSTGRES_DB: ${POSTGRES_DB_TEST:-core_db}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD_TEST:-coreness1234}
      PGDATA: /var/lib/postgresql/data
    volumes:
      # Override volumes for mounting test config
      - ../data/postgresql:/var/lib/postgresql/data
      # Initialization script for automatic pgvector extension installation
      - ./init-pgvector.sql:/docker-entrypoint-initdb.d/01-init-pgvector.sql:ro
      - ./postgresql.test.conf:/etc/postgresql/postgresql.conf:ro
      - ./pg_hba.test.conf:/etc/postgresql/pg_hba.conf:ro
    ports:
      - "5433:5432"  # Test environment uses port 5433

