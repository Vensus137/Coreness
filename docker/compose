#!/bin/bash

# –ü—Ä–æ—Å—Ç–∞—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è docker-compose
# –†–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º docker-compose.yml + docker-compose.override.yml (–µ—Å–ª–∏ –µ—Å—Ç—å)
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./docker/compose [–∫–æ–º–∞–Ω–¥–∞] [—Å–µ—Ä–≤–∏—Å]

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –ø—Ä–æ–µ–∫—Ç–∞
DC_ENVIRONMENT=""
DC_PROJECT_ROOT=""

# –ü—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É
DC_CONFIG_FILE="${HOME}/.dc_config"

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–∞–ø–∫–∞ –¥–ª—è Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
DC_GLOBAL_CONFIG_DIR="${HOME}/.docker-compose"

# –°–ø–∏—Å–æ–∫ –±–∞–∑–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (–±–µ–∑ —É—á–µ—Ç–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
DC_SERVICES=("app" "postgres")

# –ü—É—Ç–∏ –¥–ª—è Supervisor (—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã)
SUPERVISOR_CONFIG="/etc/supervisor/conf.d/supervisord.conf"
SUPERVISOR_SOCKET="/var/run/supervisor.sock"
SUPERVISOR_LOG_DIR="/var/log/supervisor"
SUPERVISOR_SOCKET_PATHS="/var/run/supervisor.sock /tmp/supervisor.sock /var/run/supervisord.sock"

# –ü—É—Ç–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã dc
DC_INSTALL_DIR_ROOT="/usr/local/bin"
DC_INSTALL_DIR_USER="$HOME/.local/bin"

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
get_config_value() {
    local key="$1"
    if [ ! -f "$DC_CONFIG_FILE" ]; then
        return 1
    fi
    
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏, –∏—â–µ–º KEY=VALUE
    grep -v '^#' "$DC_CONFIG_FILE" | grep -v '^[[:space:]]*$' | grep "^${key}=" | cut -d'=' -f2- | head -1
}

# –ü–æ–ª—É—á–∏—Ç—å –ø—É—Ç—å –∫ –æ–∫—Ä—É–∂–µ–Ω–∏—é –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
get_env_path_from_config() {
    local env_alias="$1"
    local path_key="${env_alias}_path"
    local path=$(get_config_value "$path_key")
    
    if [ -n "$path" ]; then
        echo "$path"
        return 0
    fi
    
    return 1
}

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ñ–∏–≥
set_config_value() {
    local key="$1"
    local value="$2"
    
    # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if [ ! -f "$DC_CONFIG_FILE" ]; then
        touch "$DC_CONFIG_FILE"
        chmod 600 "$DC_CONFIG_FILE"
    fi
    
    # –ï—Å–ª–∏ –∫–ª—é—á —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –∑–∞–º–µ–Ω—è–µ–º, –∏–Ω–∞—á–µ –¥–æ–±–∞–≤–ª—è–µ–º
    if grep -q "^${key}=" "$DC_CONFIG_FILE" 2>/dev/null; then
        # –ó–∞–º–µ–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥—Ä—É–≥–æ–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å sed
            sed -i '' "s|^${key}=.*|${key}=${value}|" "$DC_CONFIG_FILE"
        else
            # Linux
            sed -i "s|^${key}=.*|${key}=${value}|" "$DC_CONFIG_FILE"
        fi
    else
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        echo "${key}=${value}" >> "$DC_CONFIG_FILE"
    fi
}

# –£–¥–∞–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
remove_config_value() {
    local key="$1"
    
    if [ ! -f "$DC_CONFIG_FILE" ]; then
        return 0
    fi
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–ª—é—á–æ–º
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥—Ä—É–≥–æ–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å sed
        sed -i '' "/^${key}=/d" "$DC_CONFIG_FILE"
    else
        # Linux
        sed -i "/^${key}=/d" "$DC_CONFIG_FILE"
    fi
}

# –ù–∞–π—Ç–∏ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤–≤–µ—Ä—Ö –ø–æ –¥–µ—Ä–µ–≤—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
find_project_root() {
    local start_dir="${1:-$(pwd)}"
    local current_dir="$start_dir"
    
    while [ "$current_dir" != "/" ]; do
        if [ -d "$current_dir/docker" ] && [ -f "$current_dir/docker/docker-compose.yml" ]; then
            echo "$current_dir"
            return 0
        fi
        current_dir="$(dirname "$current_dir")"
    done
    
    return 1
}

# –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø–æ compose —Ñ–∞–π–ª–∞–º
detect_environment() {
    local project_root="$1"
    
    if [ -f "$project_root/docker/docker-compose.test.yml" ]; then
        echo "test"
        return 0
    fi
    
    if [ -f "$project_root/docker/docker-compose.prod.yml" ]; then
        echo "prod"
        return 0
    fi
    
    # –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–π —Ñ–∞–π–ª - —Å—á–∏—Ç–∞–µ–º dev
    if [ -f "$project_root/docker/docker-compose.yml" ]; then
        echo "dev"
        return 0
    fi
    
    return 1
}

# –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
determine_project_and_env() {
    local first_arg="$1"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç –∞–ª–∏–∞—Å–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏—è (test/prod)
    if [ "$first_arg" = "test" ] || [ "$first_arg" = "prod" ]; then
        DC_ENVIRONMENT="$first_arg"
        # project_root –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        # –ù–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
        local env_path=$(get_env_path_from_config "$first_arg")
        if [ -n "$env_path" ] && [ -d "$env_path" ]; then
            DC_PROJECT_ROOT="$env_path"
        else
            # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø—Ä–æ–µ–∫—Ç –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            DC_PROJECT_ROOT=$(find_project_root)
        fi
        return 0
    fi
    
    # –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –∏—â–µ–º –ø—Ä–æ–µ–∫—Ç –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏ –≤—ã—à–µ
    local found_root=$(find_project_root)
    
    if [ -n "$found_root" ]; then
        DC_PROJECT_ROOT="$found_root"
        DC_ENVIRONMENT=$(detect_environment "$found_root")
        return 0
    fi
    
    return 1
}

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É docker-compose
get_compose_cmd() {
    # –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (–¥–ª—è —Ç–µ—Å—Ç–æ–≤), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
    if [ -n "$COMPOSE_CMD_MOCK" ]; then
        echo "$COMPOSE_CMD_MOCK"
        return 0
    fi
    
    if docker compose version &>/dev/null; then
        echo "docker compose"
    elif docker-compose version &>/dev/null; then
        echo "docker-compose"
    else
        echo -e "${RED}‚ùå docker-compose –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}" >&2
        exit 1
    fi
}

# –õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è COMPOSE_CMD (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏)
_get_compose_cmd_cached() {
    if [ -z "$COMPOSE_CMD" ]; then
        COMPOSE_CMD=$(get_compose_cmd)
    fi
    echo "$COMPOSE_CMD"
}

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –≤ compose —Ñ–∞–π–ª–∞—Ö
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: 0 –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, 1 –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
check_service_exists() {
    local project_root="${1:-$DC_PROJECT_ROOT}"
    local service_name="${2:-}"
    local env="${3:-$DC_ENVIRONMENT}"
    
    if [ -z "$service_name" ] || [ -z "$env" ]; then
        return 1
    fi
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ compose —Ñ–∞–π–ª—ã
    local base_config="${DC_GLOBAL_CONFIG_DIR}/docker-compose.yml"
    local env_config="${DC_GLOBAL_CONFIG_DIR}/docker-compose.${env}.yml"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –±–∞–∑–æ–≤–æ–º —Ñ–∞–π–ª–µ
    if [ -f "$base_config" ] && grep -q "^[[:space:]]*${service_name}:" "$base_config" 2>/dev/null; then
        return 0
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ —Ñ–∞–π–ª–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    if [ "$env" != "dev" ] && [ -f "$env_config" ] && grep -q "^[[:space:]]*${service_name}:" "$env_config" 2>/dev/null; then
        return 0
    fi
    
    # Fallback: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ docker compose config
    if [ -f "$base_config" ]; then
        local compose_cmd_base="$(_get_compose_cmd_cached) -f $base_config"
        if [ "$env" != "dev" ] && [ -f "$env_config" ]; then
            compose_cmd_base="$compose_cmd_base -f $env_config"
        fi
        local available_services=$($compose_cmd_base config --services 2>/dev/null | tr '\n' ' ')
        if echo "$available_services" | grep -q "\b${service_name}\b"; then
            return 0
        fi
    fi
    
    return 1
}

# –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å override —Ñ–∞–π–ª –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
generate_override_file() {
    local env="$1"
    local project_root="${2:-$DC_PROJECT_ROOT}"
    local service_name="${3:-}"  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∏–º—è —Å–µ—Ä–≤–∏—Å–∞
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è override —Ñ–∞–π–ª–∞
    local override_file="${DC_GLOBAL_CONFIG_DIR}/docker-compose.override-${env}.yml"
    
    # –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    mkdir -p "${DC_GLOBAL_CONFIG_DIR}"
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è —Å–µ—Ä–≤–∏—Å–∞: –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ - –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ –æ–∫—Ä—É–∂–µ–Ω–∏—é
    if [ -z "$service_name" ]; then
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–º–µ–Ω–∏ app —Å–µ—Ä–≤–∏—Å–∞
        service_name=$(get_service_name "app" "$env")
    fi
    
    # –ò–º—è —Å–µ—Ä–≤–∏—Å–∞ = –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ø–æ –Ω–∞—à–µ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É)
    local container_name="$service_name"
    
    # –ß–∏—Ç–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –ø–æ –∏–º–µ–Ω–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    local cpus=$(get_config_value "${container_name}.cpus")
    local memory=$(get_config_value "${container_name}.memory")
    local cpus_reserve=$(get_config_value "${container_name}.cpus_reserve")
    local memory_reserve=$(get_config_value "${container_name}.memory_reserve")
    
    # –ï—Å–ª–∏ —Ä–µ—Å—É—Ä—Å—ã –Ω–µ –∑–∞–¥–∞–Ω—ã - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å (–Ω–æ –Ω–µ —É–¥–∞–ª—è–µ–º —Ñ–∞–π–ª, –º–æ–≥—É—Ç –±—ã—Ç—å –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã)
    if [ -z "$cpus" ] && [ -z "$memory" ] && [ -z "$cpus_reserve" ] && [ -z "$memory_reserve" ]; then
        return 0
    fi
    
    # –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - —Å–æ–∑–¥–∞–µ–º —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
    if [ ! -f "$override_file" ]; then
        echo "services:" > "$override_file"
    fi
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å–µ–∫—Ü–∏—é –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    if grep -q "^[[:space:]]*${service_name}:" "$override_file" 2>/dev/null; then
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º sed –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–µ–∫—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–∞
        local temp_file=$(mktemp)
        local in_service=false
        local indent_level=0
        
        while IFS= read -r line || [ -n "$line" ]; do
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª–æ —Å–µ–∫—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–∞
            if [[ "$line" =~ ^[[:space:]]*${service_name}: ]]; then
                in_service=true
                indent_level=$(echo "$line" | sed 's/[^ ].*//' | wc -c)
                continue
            fi
            
            if [ "$in_service" = true ]; then
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –æ—Ç—Å—Ç—É–ø–∞
                local current_indent=$(echo "$line" | sed 's/[^ ].*//' | wc -c)
                # –ï—Å–ª–∏ –æ—Ç—Å—Ç—É–ø –º–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–µ–Ω —É—Ä–æ–≤–Ω—é —Å–µ—Ä–≤–∏—Å–∞ –∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –ø—É—Å—Ç–∞—è - –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Å–µ–∫—Ü–∏–∏
                if [ "$current_indent" -le "$indent_level" ] && [[ "$line" =~ [^[:space:]] ]]; then
                    in_service=false
                    echo "$line" >> "$temp_file"
                fi
            else
                echo "$line" >> "$temp_file"
            fi
        done < "$override_file"
        mv "$temp_file" "$override_file"
    fi
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—Ü–∏—é –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞
    cat >> "$override_file" <<EOF
  $service_name:
    deploy:
      resources:
EOF
    
    # –î–æ–±–∞–≤–ª—è–µ–º limits –µ—Å–ª–∏ –µ—Å—Ç—å
    if [ -n "$cpus" ] || [ -n "$memory" ]; then
        echo "        limits:" >> "$override_file"
        if [ -n "$cpus" ]; then
            echo "          cpus: '$cpus'" >> "$override_file"
        fi
        if [ -n "$memory" ]; then
            echo "          memory: '$memory'" >> "$override_file"
        fi
    fi
    
    # –î–æ–±–∞–≤–ª—è–µ–º reservations –µ—Å–ª–∏ –µ—Å—Ç—å
    if [ -n "$cpus_reserve" ] || [ -n "$memory_reserve" ]; then
        echo "        reservations:" >> "$override_file"
        if [ -n "$cpus_reserve" ]; then
            echo "          cpus: '$cpus_reserve'" >> "$override_file"
        fi
        if [ -n "$memory_reserve" ]; then
            echo "          memory: '$memory_reserve'" >> "$override_file"
        fi
    fi
}

# –ü–æ–ª—É—á–∏—Ç—å –∫–æ–º–∞–Ω–¥—É docker-compose —Å —Ñ–∞–π–ª–∞–º–∏ –¥–ª—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
get_compose_cmd_with_files() {
    local env="${1:-$DC_ENVIRONMENT}"
    local project_root="${2:-$DC_PROJECT_ROOT}"
    
    if [ -z "$env" ]; then
        echo -e "${RED}‚ùå –û–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ${NC}" >&2
        exit 1
    fi
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º override —Ñ–∞–π–ª –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
    if [ "$env" != "dev" ]; then
        # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏–∑ —Å–ø–∏—Å–∫–∞ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º override –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
        for service_type in "${DC_SERVICES[@]}"; do
            local service_name=$(get_service_name "$service_type" "$env")
            generate_override_file "$env" "$project_root" "$service_name"
        done
    fi
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ compose —Ñ–∞–π–ª—ã
    local base_config="${DC_GLOBAL_CONFIG_DIR}/docker-compose.yml"
    local env_config="${DC_GLOBAL_CONFIG_DIR}/docker-compose.${env}.yml"
    local override_config="${DC_GLOBAL_CONFIG_DIR}/docker-compose.override-${env}.yml"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
    if [ ! -f "$base_config" ]; then
        echo -e "${RED}‚ùå –ë–∞–∑–æ–≤—ã–π compose —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $base_config${NC}" >&2
        echo -e "${YELLOW}üí° –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏${NC}" >&2
        exit 1
    fi
    
    if [ "$env" != "dev" ] && [ ! -f "$env_config" ]; then
        echo -e "${RED}‚ùå Compose —Ñ–∞–π–ª –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω: $env_config${NC}" >&2
        echo -e "${YELLOW}üí° –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏${NC}" >&2
        exit 1
    fi
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É docker compose —Å —Ñ–∞–π–ª–∞–º–∏
    # project-name –Ω–µ –Ω—É–∂–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º —è–≤–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ –∫–æ–º–∞–Ω–¥–∞—Ö
    local cmd="$(_get_compose_cmd_cached) -f $base_config"
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –æ–∫—Ä—É–∂–µ–Ω–∏—è –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
    if [ "$env" != "dev" ] && [ -f "$env_config" ]; then
        cmd="$cmd -f $env_config"
    fi
    
    # –î–æ–±–∞–≤–ª—è–µ–º override –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if [ -f "$override_config" ]; then
        cmd="$cmd -f $override_config"
    fi
    
    echo "$cmd"
}

# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–º–µ–Ω–∏ —Å–µ—Ä–≤–∏—Å–∞ –ø–æ —Ç–∏–ø—É –∏ –æ–∫—Ä—É–∂–µ–Ω–∏—é
get_service_name() {
    local service_type="${1:-app}"
    local env="${2:-$DC_ENVIRONMENT}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –≤ —Å–ø–∏—Å–∫–µ (–¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –æ–ø–µ—á–∞—Ç–æ–∫)
    local found=false
    for svc in "${DC_SERVICES[@]}"; do
        if [ "$svc" = "$service_type" ]; then
            found=true
            break
        fi
    done
    
    # –ï—Å–ª–∏ –Ω–µ –≤ —Å–ø–∏—Å–∫–µ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    if [ "$found" = false ]; then
        if [ "$env" = "test" ]; then
            echo "${service_type}-test"
        else
            echo "$service_type"
        fi
        return 0
    fi
    
    # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ: test –æ–∫—Ä—É–∂–µ–Ω–∏–µ = –ø–æ—Å—Ç—Ñ–∏–∫—Å -test, –∏–Ω–∞—á–µ –±–µ–∑ –ø–æ—Å—Ç—Ñ–∏–∫—Å–∞
    if [ "$env" = "test" ]; then
        echo "${service_type}-test"
    else
        echo "$service_type"
    fi
}

# –ü–æ–ª—É—á–∏—Ç—å –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–∏–º—è —Å–µ—Ä–≤–∏—Å–∞ = –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ –Ω–∞—à–µ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É)
get_container_name() {
    local service="$1"
    local env="${2:-${DC_ENVIRONMENT:-dev}}"
    
    # –°–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω —è–≤–Ω–æ (fallback —É–±—Ä–∞–Ω –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç–∏)
    if [ -z "$service" ]; then
        echo ""  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
        return 1
    fi
    
    # –ü–æ –Ω–∞—à–µ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É –∏–º—è —Å–µ—Ä–≤–∏—Å–∞ –≤—Å–µ–≥–¥–∞ —Ä–∞–≤–Ω–æ –∏–º–µ–Ω–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    # test: app-test ‚Üí app-test, postgres-test ‚Üí postgres-test
    # prod: app ‚Üí app, postgres ‚Üí postgres
    echo "$service"
}

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—É—é –∫–æ–º–∞–Ω–¥—É dc
install_dc() {
    local install_dir=""
    
    if [ "$EUID" -eq 0 ]; then
        install_dir="$DC_INSTALL_DIR_ROOT"
    else
        install_dir="$DC_INSTALL_DIR_USER"
        mkdir -p "$install_dir"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ PATH –µ—Å–ª–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω
        if ! echo "$PATH" | grep -q "$install_dir"; then
            echo -e "${YELLOW}üí° –î–æ–±–∞–≤–ª—è–µ–º $install_dir –≤ PATH...${NC}"
            echo "export PATH=\"\$PATH:$install_dir\"" >> "$HOME/.bashrc"
            echo "export PATH=\"\$PATH:$install_dir\"" >> "$HOME/.profile"
            echo -e "${GREEN}‚úÖ PATH –æ–±–Ω–æ–≤–ª–µ–Ω. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: source ~/.bashrc${NC}"
        fi
    fi
    
    local script_path="${BASH_SOURCE[0]}"
    local target="$install_dir/dc"
    
    if cp "$script_path" "$target"; then
        chmod +x "$target"
        echo -e "${GREEN}‚úÖ –ö–æ–º–∞–Ω–¥–∞ 'dc' —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ $target${NC}"
        echo -e "${CYAN}üí° –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: dc test start, dc test stop, dc test sv status –∏ —Ç.–¥.${NC}"
    else
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã${NC}"
        exit 1
    fi
}

# –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
show_help() {
    echo -e "${BLUE}üê≥ Docker Compose Manager${NC}"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
    echo "  dc [–∫–æ–º–∞–Ω–¥–∞] [container] [–æ–ø—Ü–∏–∏]"
    echo ""
    echo -e "${CYAN}–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:${NC}"
    echo "  logs [container] [–æ–ø—Ü–∏–∏]    –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 + follow)"
    echo "                                  –û–ø—Ü–∏–∏: -n/--tail N, --no-follow"
    echo "  start [container]           –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
    echo "  stop [container]            –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
    echo "  restart [container]         –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
    echo "  shell [container]           –û—Ç–∫—Ä—ã—Ç—å shell –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ"
    echo "  exec [container] [cmd]      –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ"
    echo ""
    echo -e "${CYAN}–ü—Ä–æ—Å–º–æ—Ç—Ä:${NC}"
    echo "  ps [container]              –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
    echo "  stats [container]           –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤"
    echo ""
    echo -e "${CYAN}Supervisor (—Ç–æ–ª—å–∫–æ –¥–ª—è app –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤):${NC}"
    echo "  sv status [container]       –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–∞"
    echo "  sv restart [container]      –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å"
    echo "  sv stop [container]         –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å"
    echo "  sv start [container]        –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å"
    echo ""
    echo -e "${CYAN}–†–µ—Å—É—Ä—Å—ã:${NC}"
    echo "  resources show [container]          –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã"
    echo "  resources set [container] [opts]    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã"
    echo "  resources reset [container]         –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤"
    echo "    --cpus X                  CPU (1, 1.5, 2, 2.5)"
    echo "    --memory SIZE             –ü–∞–º—è—Ç—å (512m, 1G, 2GB)"
    echo "    --cpus-reserve X          –†–µ–∑–µ—Ä–≤ CPU"
    echo "    --memory-reserve SIZE     –†–µ–∑–µ—Ä–≤ –ø–∞–º—è—Ç–∏"
    echo ""
    echo -e "${YELLOW}üí° –ò–º–µ–Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:${NC}"
    echo "    test: app-test, postgres-test"
    echo "    prod: app, postgres"
    echo ""
    echo -e "${CYAN}–£—Ç–∏–ª–∏—Ç—ã:${NC}"
    echo "  install                      –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—É—é –∫–æ–º–∞–Ω–¥—É 'dc'"
    echo ""
    echo -e "${GREEN}–ü—Ä–∏–º–µ—Ä—ã:${NC}"
    echo "  dc stats                            # –†–µ—Å—É—Ä—Å—ã –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
    echo "  dc logs app-test                    # –õ–æ–≥–∏ app-test (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 + follow)"
    echo "  dc logs app --no-follow             # –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫"
    echo "  dc start app-test                   # –ó–∞–ø—É—Å—Ç–∏—Ç—å app-test"
    echo "  dc restart app                      # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å app (prod)"
    echo "  dc sv status app-test               # –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ app-test"
    echo "  dc sv restart app                   # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –≤ app"
    echo "  dc resources set app-test --cpus 0.5 --memory 512m"
}

# –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
detect_env_from_container() {
    local container="$1"
    if [[ "$container" =~ -test$ ]]; then
        echo "test"
    else
        echo "prod"
    fi
}

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏
manage_resources() {
    local action="$1"
    shift
    
    case "$action" in
        show)
            local container="$1"
            
            if [ -z "$container" ]; then
                echo -e "${YELLOW}‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ—Å—É—Ä—Å–æ–≤${NC}"
                echo ""
                echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: dc resources show [container]"
                echo ""
                echo -e "${CYAN}–ü—Ä–∏–º–µ—Ä—ã:${NC}"
                echo "  dc resources show app-test"
                echo "  dc resources show app"
                exit 1
            fi
            
            echo -e "${BLUE}üìä –¢–µ–∫—É—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: $container${NC}"
            
            local cpus=$(get_config_value "${container}.cpus")
            local memory=$(get_config_value "${container}.memory")
            local cpus_reserve=$(get_config_value "${container}.cpus_reserve")
            local memory_reserve=$(get_config_value "${container}.memory_reserve")
            
            if [ -n "$cpus" ] || [ -n "$memory" ] || [ -n "$cpus_reserve" ] || [ -n "$memory_reserve" ]; then
                if [ -n "$cpus" ]; then
                    echo -e "  CPU: ${GREEN}$cpus${NC}"
                fi
                if [ -n "$memory" ]; then
                    echo -e "  Memory: ${GREEN}$memory${NC}"
                fi
                if [ -n "$cpus_reserve" ]; then
                    echo -e "  CPU Reserve: ${GREEN}$cpus_reserve${NC}"
                fi
                if [ -n "$memory_reserve" ]; then
                    echo -e "  Memory Reserve: ${GREEN}$memory_reserve${NC}"
                fi
            else
                echo -e "${YELLOW}‚ö†Ô∏è –†–µ—Å—É—Ä—Å—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ '$container'${NC}"
                echo -e "${CYAN}üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: dc resources set $container --cpus X --memory SIZE${NC}"
            fi
            ;;
        set)
            local container="$1"
            shift
            
            if [ -z "$container" ]; then
                echo -e "${RED}‚ùå –£–∫–∞–∂–∏—Ç–µ –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!${NC}"
                echo ""
                echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: dc resources set [container] [–æ–ø—Ü–∏–∏]"
                echo ""
                echo "–û–ø—Ü–∏–∏:"
                echo "  --cpus X              CPU (—á–∏—Å–ª–æ –∏–ª–∏ –¥—Ä–æ–±–Ω–æ–µ: 1, 1.5, 2)"
                echo "  --memory SIZE         –ü–∞–º—è—Ç—å: 512m, 1G, 2GB (—Ä–µ–≥–∏—Å—Ç—Ä –Ω–µ –≤–∞–∂–µ–Ω)"
                echo "  --cpus-reserve X      –†–µ–∑–µ—Ä–≤ CPU"
                echo "  --memory-reserve SIZE –†–µ–∑–µ—Ä–≤ –ø–∞–º—è—Ç–∏"
                echo ""
                echo -e "${CYAN}–ü—Ä–∏–º–µ—Ä—ã:${NC}"
                echo "  dc resources set app-test --cpus 0.5 --memory 512m"
                echo "  dc resources set app --cpus 2 --memory 2G"
                exit 1
            fi
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            local env=$(detect_env_from_container "$container")
            local project_root=$(find_project_root 2>/dev/null || echo "")
            
            local cpus=""
            local memory=""
            local cpus_reserve=""
            local memory_reserve=""
            
            # –ü–∞—Ä—Å–∏–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
            while [ $# -gt 0 ]; do
                case "$1" in
                    --cpus)
                        cpus="$2"
                        shift 2
                        ;;
                    --memory)
                        memory="$2"
                        shift 2
                        ;;
                    --cpus-reserve)
                        cpus_reserve="$2"
                        shift 2
                        ;;
                    --memory-reserve)
                        memory_reserve="$2"
                        shift 2
                        ;;
                    *)
                        echo -e "${RED}‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä: $1${NC}"
                        exit 1
                        ;;
                esac
            done
            
            if [ -z "$cpus" ] && [ -z "$memory" ] && [ -z "$cpus_reserve" ] && [ -z "$memory_reserve" ]; then
                echo -e "${RED}‚ùå –£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä${NC}"
                echo ""
                echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:"
                echo "  --cpus X              CPU (—á–∏—Å–ª–æ –∏–ª–∏ –¥—Ä–æ–±–Ω–æ–µ: 1, 1.5, 2)"
                echo "  --memory SIZE         –ü–∞–º—è—Ç—å: 512m, 1G, 2GB (—Ä–µ–≥–∏—Å—Ç—Ä –Ω–µ –≤–∞–∂–µ–Ω)"
                echo "  --cpus-reserve X      –†–µ–∑–µ—Ä–≤ CPU"
                echo "  --memory-reserve SIZE –†–µ–∑–µ—Ä–≤ –ø–∞–º—è—Ç–∏"
                exit 1
            fi
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–æ–Ω—Ñ–∏–≥ –ø–æ –∏–º–µ–Ω–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            if [ -n "$cpus" ]; then
                set_config_value "${container}.cpus" "$cpus"
            fi
            if [ -n "$memory" ]; then
                set_config_value "${container}.memory" "$memory"
            fi
            if [ -n "$cpus_reserve" ]; then
                set_config_value "${container}.cpus_reserve" "$cpus_reserve"
            fi
            if [ -n "$memory_reserve" ]; then
                set_config_value "${container}.memory_reserve" "$memory_reserve"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –≤ compose —Ñ–∞–π–ª–∞—Ö
            if [ -n "$project_root" ] && [ -d "$project_root" ]; then
                if ! check_service_exists "$project_root" "$container" "$env"; then
                    echo -e "${YELLOW}‚ö†Ô∏è –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä '$container' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ compose —Ñ–∞–π–ª–∞—Ö, –Ω–æ —Ä–µ—Å—É—Ä—Å—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫–æ–Ω—Ñ–∏–≥${NC}"
                fi
                
                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º override —Ñ–∞–π–ª
                if ! generate_override_file "$env" "$project_root" "$container"; then
                    echo -e "${YELLOW}‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å override —Ñ–∞–π–ª (–≤–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω)${NC}"
                fi
            else
                echo -e "${YELLOW}‚ö†Ô∏è –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Ä–µ—Å—É—Ä—Å—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —Ç–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Ñ–∏–≥${NC}"
            fi
            
            echo -e "${GREEN}‚úÖ –†–µ—Å—É—Ä—Å—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫–æ–Ω—Ñ–∏–≥${NC}"
            echo -e "${CYAN}   –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: $container${NC}"
            if [ -n "$cpus" ]; then
                echo -e "${CYAN}   CPU: $cpus${NC}"
            fi
            if [ -n "$memory" ]; then
                echo -e "${CYAN}   Memory: $memory${NC}"
            fi
            if [ -n "$cpus_reserve" ]; then
                echo -e "${CYAN}   CPU Reserve: $cpus_reserve${NC}"
            fi
            if [ -n "$memory_reserve" ]; then
                echo -e "${CYAN}   Memory Reserve: $memory_reserve${NC}"
            fi
            echo -e "${YELLOW}üîÑ –î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: dc restart $container${NC}"
            ;;
        reset)
            local container="$1"
            
            if [ -z "$container" ]; then
                echo -e "${RED}‚ùå –£–∫–∞–∂–∏—Ç–µ –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!${NC}"
                echo ""
                echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: dc resources reset [container]"
                echo ""
                echo -e "${CYAN}–ü—Ä–∏–º–µ—Ä—ã:${NC}"
                echo "  dc resources reset app-test"
                echo "  dc resources reset app"
                exit 1
            fi
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            local env=$(detect_env_from_container "$container")
            local project_root=$(find_project_root 2>/dev/null || echo "")
            
            # –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
            remove_config_value "${container}.cpus"
            remove_config_value "${container}.memory"
            remove_config_value "${container}.cpus_reserve"
            remove_config_value "${container}.memory_reserve"
            
            # –û–±–Ω–æ–≤–ª—è–µ–º override —Ñ–∞–π–ª (—É–¥–∞–ª–∏—Ç —Å–µ–∫—Ü–∏—é –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —Ç.–∫. —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–µ—Ç)
            if [ -n "$project_root" ] && [ -d "$project_root" ]; then
                if ! generate_override_file "$env" "$project_root" "$container"; then
                    echo -e "${YELLOW}‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å override —Ñ–∞–π–ª${NC}"
                fi
            fi
            
            echo -e "${GREEN}‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ '$container' —Å–±—Ä–æ—à–µ–Ω—ã${NC}"
            echo -e "${YELLOW}üîÑ –î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: dc restart $container${NC}"
            ;;
        *)
            echo -e "${RED}‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: $action${NC}"
            echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: dc resources [show|set|reset] [container]"
            exit 1
            ;;
    esac
}

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ supervisor
# –í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å —Å –∏–º–µ–Ω–µ–º "main"
manage_supervisor() {
    local action="$1"
    local container="$2"
    local proc="main"  # –í—Å–µ–≥–¥–∞ –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
    
    # –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
    if [ -z "$container" ]; then
        echo -e "${RED}‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä!${NC}"
        echo ""
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: dc sv [status|restart|stop|start] [container]"
        echo ""
        echo -e "${CYAN}–ü—Ä–∏–º–µ—Ä—ã:${NC}"
        echo "  dc sv status app-test"
        echo "  dc sv restart app"
        echo ""
        echo -e "${YELLOW}üí° Supervisor —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ app –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö (app-test, app)${NC}"
        exit 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ app –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    if [[ ! "$container" =~ ^app(-test)?$ ]]; then
        echo -e "${RED}‚ùå Supervisor —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ app –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö (app-test, app)${NC}"
        echo -e "${CYAN}üí° –£–∫–∞–∑–∞–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: $container${NC}"
        exit 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
    if ! docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
        echo -e "${RED}‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä $container –Ω–µ –∑–∞–ø—É—â–µ–Ω${NC}"
        echo -e "${CYAN}üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: dc start $container${NC}"
        exit 1
    fi
    
    case "$action" in
        status)
            echo -e "${BLUE}üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–∞ Supervisor –≤ $container${NC}"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ supervisor –ø—Ä–æ—Ü–µ—Å—Å
            if ! docker exec "$container" pgrep -x supervisord >/dev/null 2>&1; then
                echo -e "${YELLOW}‚ö†Ô∏è Supervisor –Ω–µ –∑–∞–ø—É—â–µ–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ${NC}"
                echo -e "${CYAN}üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: dc logs $container${NC}"
                exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å socket (–ø—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—É—Ç–µ–π)
            local socket_found=false
            for socket_path in $SUPERVISOR_SOCKET_PATHS; do
                if docker exec "$container" test -S "$socket_path" 2>/dev/null; then
                    socket_found=true
                    break
                fi
            done
            
            if [ "$socket_found" = false ]; then
                echo -e "${YELLOW}‚ö†Ô∏è Supervisor socket –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω${NC}"
                echo -e "${CYAN}üí° Supervisor –∑–∞–ø—É—â–µ–Ω, –Ω–æ socket –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: dc restart $container${NC}"
                exit 1
            fi
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é –æ—à–∏–±–∫—É –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
            local output
            local exit_code
            output=$(docker exec "$container" supervisorctl -c "$SUPERVISOR_CONFIG" status 2>&1)
            exit_code=$?
            
            if [ $exit_code -eq 0 ]; then
                echo "$output"
            else
                echo -e "${YELLOW}‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ supervisor:${NC}"
                echo "$output"
                exit 1
            fi
            ;;
        restart)
            echo -e "${YELLOW}üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ $container${NC}"
            if ! docker exec "$container" supervisorctl -c "$SUPERVISOR_CONFIG" restart "$proc" 2>&1; then
                echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞${NC}"
                exit 1
            fi
            echo -e "${GREEN}‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω${NC}"
            ;;
        stop)
            echo -e "${YELLOW}‚èπ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ $container${NC}"
            if ! docker exec "$container" supervisorctl -c "$SUPERVISOR_CONFIG" stop "$proc" 2>&1; then
                echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞${NC}"
                exit 1
            fi
            echo -e "${GREEN}‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"
            ;;
        start)
            echo -e "${GREEN}‚ñ∂ –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ $container${NC}"
            if ! docker exec "$container" supervisorctl -c "$SUPERVISOR_CONFIG" start "$proc" 2>&1; then
                echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞${NC}"
                exit 1
            fi
            echo -e "${GREEN}‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω${NC}"
            ;;
        *)
            echo -e "${RED}‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: $action${NC}"
            echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: dc sv [status|restart|stop|start] [container]"
            echo ""
            echo -e "${CYAN}–ü—Ä–∏–º–µ—Ä—ã:${NC}"
            echo "  dc sv status app-test"
            echo "  dc sv restart app"
            echo ""
            echo -e "${YELLOW}üí° Supervisor —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ app –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö (app-test, app)${NC}"
            exit 1
            ;;
    esac
}

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
init_config() {
    if [ -f "$DC_CONFIG_FILE" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: $DC_CONFIG_FILE${NC}"
        read -p "–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å? (yes/no): " confirm
        if [ "$confirm" != "yes" ]; then
            echo "–û—Ç–º–µ–Ω–µ–Ω–æ"
            return 1
        fi
    fi
    
    cat > "$DC_CONFIG_FILE" <<EOF
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –∫–æ–º–∞–Ω–¥—ã dc
# –§–æ—Ä–º–∞—Ç: <container-name>.<parameter>=<value>
#
# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: —Ä–µ—Å—É—Ä—Å—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –ø–æ –∏–º–µ–Ω–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
# –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ —Ç–∏–ø–∞ —Å–µ—Ä–≤–∏—Å–∞
#
# –†–µ—Å—É—Ä—Å—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É: dc <env> resources set <container> --cpus X --memory SIZE
# –í–ê–ñ–ù–û: —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –æ–∫—Ä—É–∂–µ–Ω–∏—è!
# –§–æ—Ä–º–∞—Ç—ã: --cpus 1.5, --memory 2G, --memory 512m (—Ä–µ–≥–∏—Å—Ç—Ä –Ω–µ –≤–∞–∂–µ–Ω)
#
# –ò–º–µ–Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:
#   test: app-test, postgres-test
#   prod: app, postgres
#
# –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
# app-test.cpus=0.1
# app-test.memory=200m
# postgres-test.cpus=0.2
# postgres-test.memory=256m
# app.cpus=0.4
# app.memory=600m
# postgres.cpus=0.5
# postgres.memory=512m
#
# –ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥:
# dc test resources set app-test --cpus 0.1 --memory 200m
# dc test resources set postgres-test --cpus 0.2 --memory 256m
# dc prod resources set app --cpus 0.4 --memory 600m
# dc prod resources set postgres --cpus 0.5 --memory 512m
EOF
    
    chmod 600 "$DC_CONFIG_FILE"
    echo -e "${GREEN}‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω: $DC_CONFIG_FILE${NC}"
    echo -e "${CYAN}üí° –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª, —É–∫–∞–∑–∞–≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—É—Ç–∏ –∏ —Ä–µ—Å—É—Ä—Å—ã${NC}"
    return 0
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
main() {
    local command="${1:-help}"
    
    # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
    case "$command" in
        install)
            install_dc
            return $?
            ;;
        help|--help|-h|"")
            show_help
            return 0
            ;;
    esac
    
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∞—Ä–≥—É–º–µ–Ω—Ç—É
    shift
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É
    case "$command" in
        start)
            local container="$1"
            
            if [ -z "$container" ]; then
                echo -e "${RED}‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä!${NC}"
                echo ""
                echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: dc start [container]"
                echo ""
                echo -e "${CYAN}–ü—Ä–∏–º–µ—Ä—ã:${NC}"
                echo "  dc start app-test"
                echo "  dc start app"
                echo "  dc start postgres-test"
                exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
            if ! docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
                echo -e "${RED}‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä '$container' –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
                exit 1
            fi
            
            echo -e "${GREEN}üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: $container${NC}"
            docker start "$container"
            ;;
        stop)
            local container="$1"
            
            if [ -z "$container" ]; then
                echo -e "${RED}‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä!${NC}"
                echo ""
                echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: dc stop [container]"
                echo ""
                echo -e "${CYAN}–ü—Ä–∏–º–µ—Ä—ã:${NC}"
                echo "  dc stop app-test"
                echo "  dc stop app"
                exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            if ! docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
                echo -e "${YELLOW}‚ö†Ô∏è –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä '$container' –Ω–µ –∑–∞–ø—É—â–µ–Ω${NC}"
                exit 1
            fi
            
            echo -e "${YELLOW}‚èπ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: $container${NC}"
            docker stop "$container"
            ;;
        restart)
            local container="$1"
            
            if [ -z "$container" ]; then
                echo -e "${RED}‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä!${NC}"
                echo ""
                echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: dc restart [container]"
                echo ""
                echo -e "${CYAN}–ü—Ä–∏–º–µ—Ä—ã:${NC}"
                echo "  dc restart app-test"
                echo "  dc restart app"
                exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            if ! docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
                echo -e "${RED}‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä '$container' –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
                exit 1
            fi
            
            echo -e "${YELLOW}üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: $container${NC}"
            docker restart "$container"
            ;;
        ps)
            local container="$1"
            
            if [ -n "$container" ]; then
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                echo -e "${BLUE}üìã –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: $container${NC}"
                docker ps --filter "name=^${container}$" --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
            else
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞ (app, postgres, app-test, postgres-test)
                echo -e "${BLUE}üìã –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤${NC}"
                docker ps --filter "name=^(app|postgres|app-test|postgres-test)$" --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
            fi
            ;;
        logs)
            local container="$1"
            shift
            
            # –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
            if [ -z "$container" ]; then
                echo -e "${YELLOW}‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä!${NC}"
                echo ""
                echo -e "${CYAN}–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:${NC}"
                docker ps --format "  {{.Names}}" | grep -E "(app|postgres)" || echo "  (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã)"
                exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            if ! docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
                echo -e "${RED}‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä '$container' –Ω–µ –∑–∞–ø—É—â–µ–Ω${NC}"
                exit 1
            fi
            
            # –ü–∞—Ä—Å–∏–º –æ–ø—Ü–∏–∏
            local follow=true  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é follow –≤–∫–ª—é—á–µ–Ω
            local tail_lines=100  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫
            
            while [ $# -gt 0 ]; do
                case "$1" in
                    -f|--follow)
                        follow=true
                        shift
                        ;;
                    --no-follow)
                        follow=false
                        shift
                        ;;
                    -n|--tail)
                        tail_lines="$2"
                        shift 2
                        ;;
                    --tail=*)
                        tail_lines="${1#*=}"
                        shift
                        ;;
                    *)
                        echo -e "${RED}‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø—Ü–∏—è: $1${NC}"
                        exit 1
                        ;;
                esac
            done
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏
            if [ "$follow" = true ]; then
                docker logs -f --tail "$tail_lines" "$container"
            else
                docker logs --tail "$tail_lines" "$container"
            fi
            ;;
        shell)
            local container="$1"
            
            if [ -z "$container" ]; then
                echo -e "${RED}‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä!${NC}"
                echo ""
                echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: dc shell [container]"
                echo ""
                echo -e "${CYAN}–ü—Ä–∏–º–µ—Ä—ã:${NC}"
                echo "  dc shell app-test"
                echo "  dc shell app"
                exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            if ! docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
                echo -e "${RED}‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä '$container' –Ω–µ –∑–∞–ø—É—â–µ–Ω${NC}"
                exit 1
            fi
            
            echo -e "${CYAN}üêö –û—Ç–∫—Ä—ã—Ç–∏–µ shell –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ: $container${NC}"
            docker exec -it "$container" bash
            ;;
        exec)
            local container="$1"
            shift
            
            if [ -z "$container" ]; then
                echo -e "${RED}‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –∫–æ–º–∞–Ω–¥—É!${NC}"
                echo ""
                echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: dc exec [container] [command]"
                echo ""
                echo -e "${CYAN}–ü—Ä–∏–º–µ—Ä—ã:${NC}"
                echo "  dc exec app-test python main.py"
                echo "  dc exec app ls -la"
                exit 1
            fi
            
            if [ $# -eq 0 ]; then
                echo -e "${RED}‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è!${NC}"
                exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            if ! docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
                echo -e "${RED}‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä '$container' –Ω–µ –∑–∞–ø—É—â–µ–Ω${NC}"
                exit 1
            fi
            
            docker exec "$container" "$@"
            ;;
        supervisor|sv)
            manage_supervisor "$@"
            ;;
        resources)
            manage_resources "$@"
            ;;
        stats)
            local container="$1"
            
            if [ -n "$container" ]; then
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                if ! docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
                    echo -e "${RED}‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä '$container' –Ω–µ –∑–∞–ø—É—â–µ–Ω${NC}"
                    exit 1
                fi
                echo -e "${BLUE}üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤: $container${NC}"
                docker stats --no-stream "$container" 2>/dev/null || {
                    echo -e "${YELLOW}‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É${NC}"
                }
            else
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
                echo -e "${BLUE}üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤${NC}"
                local container_names=$(docker ps --filter "name=^(app|postgres|app-test|postgres-test)$" --format "{{.Names}}" 2>/dev/null)
                
                if [ -z "$container_names" ]; then
                    echo -e "${YELLOW}‚ö†Ô∏è –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã${NC}"
                else
                    docker stats --no-stream $container_names 2>/dev/null || {
                        echo -e "${YELLOW}‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É${NC}"
                    }
                fi
            fi
            ;;
        *)
            echo -e "${RED}‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: $command${NC}"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# –ó–∞–ø—É—Å–∫–∞–µ–º main —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é, –∞ –Ω–µ —á–µ—Ä–µ–∑ source
if [ "${BASH_SOURCE[0]}" == "${0}" ]; then
    main "$@"
fi
