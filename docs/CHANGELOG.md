# Changelog

Все важные изменения в проекте документируются в этом файле.

---

## [0.21.0] - 2025-12-30

### Added

- Добавлено действие `save_embedding` для сохранения текста в векторное хранилище с автоматическим разбиением на чанки и генерацией embeddings
- Добавлено действие `search_embedding` для семантического поиска похожих чанков по тексту или вектору с поддержкой фильтрации по типу документа, дате и метаданным
- Добавлено действие `get_recent_chunks` для получения последних N чанков по дате с поддержкой фильтрации
- Добавлено действие `delete_embedding` для удаления данных из векторного хранилища по document_id или дате
- Добавлен параметр `rag_chunks` в действие `completion` — массив чанков из RAG поиска для автоматического формирования messages с группировкой по типам (chat_history, knowledge, other)
- Добавлены форматы плейсхолдеров `format:date_postgres` (YYYY-MM-DD) и `format:datetime_postgres` (YYYY-MM-DD HH:MM:SS) для корректного сохранения дат в PostgreSQL

### Changed

- Переработана механика формирования запросов в действии `completion` — структурированное разделение на system сообщение, диалог (chat_history) и финальный user с контекстом (knowledge + other + кастомный context в блоке ДОП. КОНТЕКСТ)
- Дополнена документация примерами работы с RAG хранилищем — добавлен раздел в EXAMPLES_GUIDE.md с практическими примерами использования действий `save_embedding`, `search_embedding`, `get_recent_chunks`, `delete_embedding` и параметра `rag_chunks` в `completion`
- Обновлен гайд моделей AI (AI_MODELS_GUIDE.md) — изменен набор отображаемых параметров: добавлен параметр `top_p`, убраны `structured_outputs`,`tool_choice`, `max_tokens`, `presence_penalty` и `repetition_penalty` из таблицы параметров

### ⚠️ BREAKING CHANGES

- Переименовано действие `ai_completion` → `completion` — необходимо обновить все сценарии, использующие это действие

### Technical Improvements

- Добавлена поддержка векторного хранилища для RAG (Retrieval-Augmented Generation) — интеграция с pgvector для PostgreSQL, создана таблица `vector_storage` с поддержкой векторных embeddings размерностью 1024
- Реализован HNSW индекс для быстрого векторного поиска — оптимизирован поиск похожих документов даже на больших объемах данных
- Использован JSONB для метаданных векторных чанков — улучшена производительность работы с метаданными в PostgreSQL
- Реализована фильтрация по метаданным (JSONB) в действиях `search_embedding`, `delete_embedding`, `get_recent_chunks` — поддержка фильтрации по полям метаданных (например, `chat_id`, `username`) через параметр `metadata_filter`

---

## [0.20.4] - 2025-12-25

### Fixed
- Утилита деплоя: улучшена система создания и восстановления бэкапов БД — исправлены ошибки при работе с бэкапами, улучшена надежность операций

---

## [0.20.3] - 2025-12-25

### Added
- Добавлен сервис автоматических бэкапов базы данных (`backup_service`) — создает бэкапы БД в фоне с настраиваемым интервалом, хранит последние N бэкапов с автоматической ротацией, формат: plain SQL + gzip для PostgreSQL и .bak.gz для SQLite

---

## [0.20.2] - 2025-12-25

### Added
- Утилита деплоя: добавлена возможность автоматического создания тегов версий при деплое через настройку `create_tag: true` в конфигурации репозитория
- Утилита деплоя: добавлена возможность подмены файлов при деплое через настройку `file_replacements` в конфигурации репозитория (поддержка замены существующих файлов и добавления новых файлов, отсутствующих в списке деплоя)

### Fixed
- Утилита деплоя: исправлено создание и восстановление бэкапов БД для PostgreSQL — теперь используется `docker exec` вместо прямого вызова `psql`, что позволяет работать без установленного `psql` на хосте
- Утилита деплоя: исправлено удаление бэкапов после успешной миграции — бэкапы теперь корректно удаляются после завершения миграции

### Technical Improvements
- Улучшена обработка ошибок в модулях деплоя: убраны исключения RuntimeError, заменены на возврат None/False с логированием ошибок для более предсказуемого поведения
- Улучшено определение имен контейнеров и сервисов: теперь имена определяются только из docker-compose файлов без использования fallback значений, что повышает надежность и требует корректной конфигурации compose файлов
- Утилита деплоя: изменен путь сохранения бэкапов БД с `tools/deployment/migrations/backups/` на `data/backups/` (настраивается через `migration_settings.backup_dir` в конфиге)
- Утилита деплоя: унифицирована логика определения контейнера PostgreSQL — вынесена в отдельный метод для переиспользования при создании и восстановлении бэкапов

---

## [0.20.1] - 2025-12-24

### Changed
- Миграция с OpenRouter на Polza.ai как основной провайдер AI API
- Переименование переменной окружения `OPENROUTER_API_KEY` в `AI_API_KEY` для универсальности
- Переименование поля конфигурации тенанта `openrouter_token` в `ai_token`
- Обновлены сценарии управления конфигурацией тенанта для работы с универсальным AI токеном

### Added
- Создан гайд по моделям AI (`docs/AI_MODELS_GUIDE.md`) с информацией о поддерживаемых параметрах, модальностях и ценах
- Поддержка расширенного ценообразования (prompt/completion/image/request/web_search)
- Отображение модальностей моделей (текст, изображение, видео, аудио, файлы, embeddings)

### Removed
- Удален устаревший гайд по моделям OpenRouter (`docs/OPENROUTER_MODELS_GUIDE.md`) как неактуальный после миграции на Polza.ai

### Technical Improvements
- Улучшена система миграции БД: добавлено автоматическое удаление и пересоздание view перед изменением структуры таблиц для избежания ошибок зависимостей

---

## [0.20.0] - 2025-12-24

### ⚠️ BREAKING CHANGES

- Унификация именования полей в конфигурации сценариев — поля `steps:` и `transitions:` переименованы в единственное число `step:` и `transition:` для единообразия и упрощения использования (старый формат больше не поддерживается)

**Миграция:** Обновите все файлы сценариев в `config/tenant/*/scenarios/**/*.yaml`: `steps:` → `step:`, `transitions:` → `transition:`

---

## [0.19.1] - 2025-12-23

### Technical Improvements

- **Database Access Control Views**: Добавлена система автоматического создания PostgreSQL view для контроля доступа на уровне БД — создаются view для всех таблиц с tenant_id, позволяя администраторам БД настраивать доступ пользователей через таблицу `view_access` (login, tenant_id), пользователи видят только разрешенные данные через `current_user`

---

## [0.19.0] - 2025-12-23

### Technical Improvements

- **Database Migration**: Миграция базы данных с SQLite на PostgreSQL — улучшена производительность, масштабируемость и надежность хранения данных
- **Database Type Fixes**: Исправлены типы данных для Telegram ID (user_id, chat_id) — заменены с INTEGER на BIGINT для предотвращения переполнения при работе с большими ID пользователей и чатов
- **PostgreSQL Configuration**: Настройки PostgreSQL вынесены в отдельные конфигурационные файлы (postgresql.test.conf, postgresql.prod.conf) для управления через Docker Compose
- **Docker Compose**: Добавлена поддержка отдельных контейнеров PostgreSQL для test и production окружений с различными настройками памяти и портов
- **Tenant Synchronization**: Изменен порядок синхронизации блоков тенанта — пулинг/вебхуки запускаются только после полной синхронизации сценариев, storage и конфигурации, гарантируя корректную обработку событий с актуальными данными

---

## [0.18.0] - 2025-12-20

### Added
- Поддержка Telegram вебхуков — возможность использовать вебхуки вместо пулинга для получения обновлений от Telegram

### Technical Improvements
- Реализована поддержка Telegram вебхуков с автоматической генерацией самоподписанных SSL-сертификатов
- Унифицирована архитектура генерации SSL-сертификатов — перенесена в `http_server` для переиспользования
- Добавлена библиотека `cryptography` для генерации SSL-сертификатов

---

## [0.17.0] - 2025-12-18

### ⚠️ BREAKING CHANGES

- `ai_completion` теперь требует настройки конфигурации тенанта — необходимо добавить `openrouter_token` в файл `config.yaml` тенанта или установить через мастер-бота

### Added

- Конфигурация тенанта через `config.yaml` — новый файл для хранения атрибутов тенанта (например, `openrouter_token`)
- Поле `openrouter_token` в конфигурации тенанта для индивидуальных API ключей OpenRouter
- Словарь `_config` в событиях сценариев — автоматически доступен во всех сценариях тенанта для доступа к конфигурации через плейсхолдеры (например, `{_config.openrouter_token}`)

### Changed

- `ai_completion` теперь автоматически использует `openrouter_token` из конфигурации тенанта — параметр не нужно передавать явно, он берется из `_config.openrouter_token`
- Changed (документация): Обновлена документация по конфигурации тенантов (`TENANT_CONFIG_GUIDE.md`) и использованию `_config` в сценариях (`SCENARIO_CONFIG_GUIDE.md`)

### Fixed

- Исправлена обработка идентификаторов без кавычек в условиях — теперь плейсхолдеры в условиях (например, `{event_text|lower} == "null"`) корректно обрабатываются без необходимости оборачивать плейсхолдеры в кавычки

### Technical Improvements

- Реализована поддержка вебхуков GitHub для синхронизации тенантов — автоматическое обновление конфигураций при изменениях в репозитории без необходимости пулинга
- Создан HTTP API сервис для управления вебхуками и будущими API-эндпоинтами — улучшена архитектура для масштабируемости

---

## [0.16.0] - 2025-12-15

### Added

- **Установка токена бота через мастер-бота** — добавлена возможность установки токена бота не только через конфигурацию (`tg_bot.yaml`), но и через мастер-бота (приоритет у конфигурации при синхронизации)

### Changed

- **Унификация возвращаемых значений в set-действиях для сторейджей** — действия `set_storage` и `set_user_storage` теперь возвращают значения аналогично get-действиям: при установке одного значения возвращается только value, при установке группы/структуры возвращается соответствующая структура данных

---

## [0.15.0] - 2025-12-14

### Added

- **Автоматическое преобразование типов параметров** — система автоматически преобразует типы параметров действий при необходимости (например, `integer` ↔ `string`, `boolean` ↔ `string`). Для `boolean` принимаются только явные строковые значения `"true"` и `"false"` (регистр не важен)
- **Подмена возвращаемых значений storage через `_response_key`** — все get/set storage действия (`get_storage`, `set_storage`, `get_user_storage`, `set_user_storage`) теперь поддерживают подмену возвращаемого значения через параметр `_response_key`

### Changed

- **Централизованная валидация входных данных** — все действия теперь используют единую систему валидации входных параметров, что обеспечивает консистентность проверки данных и улучшенную обработку ошибок
- **Структурированные коды ошибок для `confirm_payment`** — действие `confirm_payment` теперь возвращает специфичные коды ошибок: `INVOICE_CANCELLED` (при result=failed - инвойс отменен), `INVOICE_ALREADY_PAID` (при result=failed - инвойс уже оплачен), `INTERNAL_ERROR` (при result=error - техническая ошибка). Коды можно использовать для обработки в сценариях через `validate` и `transitions`
- **Документация по работе с оплатами** — добавлен раздел "Работа с оплатами (Invoices)" в EXAMPLES_GUIDE.md с полным flow от создания инвойса до обработки успешной оплаты, включая примеры обработки `pre_checkout_query` и `payment_successful` событий

### Technical Improvements

- **Унификация системы кэширования** — все критичные кэши (боты, тенанты, сценарии, пользователи) мигрированы на единую утилиту `cache_manager`, что улучшило производительность, надежность и синхронизацию данных между сервисами

---

## [0.14.0] - 2025-12-03

### ⚠️ BREAKING CHANGES

- **Изменен формат `last_error`** — теперь это объект с полями `code`, `message`, `details` вместо строки. Для доступа к сообщению об ошибке используйте `{last_error.message}` вместо `{last_error}`. Для доступа к коду ошибки используйте `{last_error.code}`. Пример: `{last_error.message|fallback:Неизвестная ошибка}` или `Код ошибки: {last_error.code}`

### Added

- **Тестовый контур** — теперь доступно отдельное тестовое окружение для проверки новых функций и изменений перед их появлением в продакшене. Мастер бот для тестового контура: [@tg_alpha_bot](https://t.me/tg_alpha_bot). Тестовый контур позволяет вам протестировать изменения до выкатки в прод, подготовиться к важным изменениям (особенно breaking changes) и дать обратную связь

**Миграция сценариев:**

1. **Плейсхолдеры с `last_error`:**
   - Ранее: `{last_error|fallback:Неизвестная ошибка}` (возвращал строку)
   - Теперь: `{last_error.message|fallback:Неизвестная ошибка}` (доступ к полю `message`)
   - Для кода ошибки: `{last_error.code|fallback:UNKNOWN}`
   - Замените все использования `{last_error}` на `{last_error.message}` в текстах сообщений

2. **Условия с `last_error`:**
   - Ранее: `$last_error == 'Ошибка валидации'`
   - Теперь: `$last_error.message == 'Ошибка валидации'` или `$last_error.code == 'VALIDATION_ERROR'`

### Added

- **Новые форматы времени и даты-времени с секундами** — добавлены модификаторы `format:time_full` (hh:mm:ss, например: 15:30:45) и `format:datetime_full` (dd.mm.yyyy hh:mm:ss, например: 25.12.2024 15:30:45) для отображения полного формата с секундами. Существующие форматы `format:time` и `format:datetime` остаются без изменений (без секунд)

### Changed

- **Валидация входных данных действий** — добавлена централизованная валидация через утилиту `action_validator`. Все действия теперь автоматически валидируют входные параметры по схемам из `config.yaml` перед выполнением. Ошибки валидации возвращаются в структурированном формате с полями `code`, `message`, `details`
- **Формат ошибок действий** — все действия теперь возвращают ошибки в структурированном формате: объект с полями `code` (код ошибки, например `VALIDATION_ERROR`, `NOT_FOUND`), `message` (текстовое описание), `details` (опциональный массив деталей ошибки). Это позволяет более точно обрабатывать различные типы ошибок в сценариях
- **Документация** — улучшена структура и навигация документации: создан отдельный гайд "Быстрый старт" (GETTING_STARTED.md), README.md переработан в индекс с многоуровневым оглавлением и прямыми ссылками на ключевые разделы, добавлен гайд по моделям OpenRouter в общий индекс

### Infrastructure

- **GitHub Actions workflows** — создана система автоматических проверок и деплоя через GitHub Actions: автоматические тесты при push в ветки, автоматический merge между ветками (dev → main → test), создание PR для prod окружения
- **Деплой менеджер** — полностью переработана утилита управления деплоем (`tools/deployment/deployment_manager.py`): обновлен интерфейс меню, добавлена функция очистки старых Docker образов, улучшена интеграция с Docker и системами миграций БД

---

## [0.13.0] - 2025-11-20

### ⚠️ BREAKING CHANGES

- **Изменен способ кэширования результатов действий** — данные из `response_data` теперь сохраняются в `_cache` вместо плоского контекста `data`. Доступ: `{_cache.field}` вместо `{field}`
- **Унифицированы действия для работы с storage** — удалены специфичные действия (`get_storage_value`, `set_storage_value`, `delete_storage_value`, `get_storage_group`, `delete_storage_group` для tenant и аналогичные для user). Вместо них используются унифицированные `get_storage`, `set_storage`, `delete_storage` (для tenant) и `get_user_storage`, `set_user_storage`, `delete_user_storage` (для user)
- **Изменен формат условий в триггерах и валидаторах** — все поля в условиях теперь должны иметь маркер `$name` (например: `$event_type == 'message'` вместо `event_type == 'message'`)

**Миграция сценариев:**

1. **Кэширование данных действий:**
   - Ранее: `{field}` (в плоском контексте `data`)
   - Теперь: `{_cache.field}` (плоское кэширование) или `{_cache._namespace.field}` (если указан `_namespace`)
   - Замените все плейсхолдеры: `{field}` → `{_cache.field}` (где `field` — поле из `response_data` действия)

2. **Storage действия:**
   - Замените старые storage действия на унифицированные (см. документацию)
   - Замените `response_value` на `storage_values`/`user_storage_values` в плейсхолдерах

3. **Условия в триггерах и валидаторах:**
   - Ранее: `event_type == 'message'`
   - Теперь: `$event_type == 'message'`
   - Обновите все условия, добавив маркер `$` к полям

### Removed

- **Специфичные storage действия** — `get_storage_value`, `set_storage_value`, `delete_storage_value`, `get_storage_group`, `delete_storage_group` (для tenant и user)
- **Поле `response_value`** — в ответах storage действий (используйте `storage_values` или `user_storage_values`)

### Changed

- **Storage действия** — унифицированы для работы с группами, значениями и паттернами. `set_storage`/`set_user_storage` поддерживают смешанный подход: полная структура через `values` или частичная через `group_key`/`key`/`value`. `get_storage`/`get_user_storage` возвращают упрощенную структуру в зависимости от запроса: при запросе конкретного ключа возвращается только `value`, при запросе группы — структура группы `{key: value}`, при запросе всего storage — полная структура `{group_key: {key: value}}`
- **`generate_unique_id`** — параметр `seed` теперь опциональный. Если не указан, генерируется случайный UUID
- **Документация** — обновлены примеры условий для использования маркера `$name` для полей. Добавлены примеры доступа к элементам массивов в условиях (`$field[0].type`)
- **Меню управления storage** — переработано меню управления Tenant Storage и User Storage с упрощенным интерфейсом. Поддержка единого формата ввода: для Tenant Storage — `группа ключ значение`, для User Storage — `user_id ключ значение`. Автоматическое определение действий на основе количества введенных слов (просмотр, редактирование, удаление). Возможность перехода между данными без возврата в главное меню

### Added

- **Параметр `_namespace`** — опциональный параметр для всех действий, возвращающих `response_data`. Позволяет указать кастомный ключ для создания вложенности в `_cache` вместо плоского кэширования. Используется для контроля перезаписи при повторных вызовах одного действия. Доступ через `{_cache._namespace.field}`
- **Параметр `_response_key`** — опциональный системный параметр для действий, поддерживающих подмену ключа основного значения. Позволяет автоматически переименовать основное поле в `response_data` перед сохранением в `_cache` (например, `storage_values` → `api_key`). Работает для действий с полями, помеченными как поддерживающие подмену ключа.
- **Модификатор `code`** — оборачивание значений в `<code>...</code>` блок. Для списков каждый элемент оборачивается отдельно. Порядок модификаторов имеет значение: `{items|list|code}` оборачивает весь список, `{items|code|list}` оборачивает каждый элемент отдельно
- **Модификатор `is_null`** — проверка на null (возвращает `True` если значение `None`, пустая строка или строка "null", иначе `False`). Используется для замены обработки `is_null` в condition parser: `{field|is_null} == True`
- **Действие `get_storage_groups`** — получение списка уникальных ключей групп для тенанта. Возвращает массив `group_keys` и опциональный флаг `is_truncated` (если список был обрезан из-за превышения лимита).

---

## [0.12.0] - 2025-11-16

### ⚠️ BREAKING CHANGES

- **Изменен способ доступа к данным из действий** — данные из `response_data` теперь автоматически сохраняются в `_cache[action_name]` или `_cache[_cache_key]` вместо плоского слияния в контекст. Доступ к данным: `{_cache.action_name.field}` вместо `{field}`

**Миграция сценариев:** Для обновления существующих сценариев необходимо заменить все плейсхолдеры, которые обращаются к данным из `response_data`:
  - `{field}` → `{_cache.action_name.field}` (где `action_name` — имя действия, которое вернуло данные)
  - `{_cache.ключ}` (из `set_cache`) → `{_cache.set_cache.ключ}`
  - `{_cache.formatted_text}` (из `format_data_to_text`) → `{_cache.format_data_to_text.formatted_text}`
  - Данные из `wait_for_action` → `{_cache.wait_for_action.field}` вместо `{field}`
  
  Для упрощения миграции можно использовать параметр `_flat_cache: true` в действиях, чтобы сохранить плоский доступ через `{_cache.field}`, но это может привести к конфликтам имен между разными действиями

### Added

- **`_cache_key`** — опциональный параметр для всех действий, возвращающих `response_data`. Позволяет указать кастомный ключ для сохранения данных в `_cache` вместо имени действия
- **`_flat_cache`** — опциональный параметр (по умолчанию `false`) для всех действий, возвращающих `response_data`. При `true` данные мержатся напрямую в `_cache` без вложенности. ⚠️ Может привести к конфликтам имен между разными действиями

### Changed

- **Доступ к данным из действий** — все данные из `response_data` теперь доступны через `{_cache.action_name.field}` или `{_cache._cache_key.field}` (если указан `_cache_key`). Ранее данные были доступны напрямую по имени поля `{field}`
- **Действие `set_cache`** — данные теперь попадают в `_cache.set_cache` (или `_cache._cache_key` если указан `_cache_key`) вместо плоского `_cache`. Доступ: `{_cache.set_cache.ключ}` вместо `{_cache.ключ}`
- **Действие `format_data_to_text`** — данные теперь попадают в `_cache.format_data_to_text.{cache_key}` (или `_cache._cache_key.{cache_key}` если указан `_cache_key`) вместо `_cache.{cache_key}`
- **Действие `wait_for_action`** — результат основного действия теперь попадает в `_cache.wait_for_action` (или `_cache._cache_key` если указан `_cache_key`). Доступ: `{_cache.wait_for_action.field}` вместо `{field}`

---

## [0.11.3] - 2025-11-16

### Added
- **`set_cache`** — установка временных данных в кэш сценария. Принимает параметр `cache` (объект) с данными для кэширования. Все переданные данные доступны в последующих шагах через плейсхолдеры `{_cache.ключ}`. Данные автоматически очищаются после завершения выполнения сценария и изолированы в `_cache`, что предотвращает случайную перезапись системных полей
- **Параметр `return_cache` для `execute_scenario`** (по умолчанию `true`) — управляет возвратом `_cache` из выполненного сценария. Работает только для одиночных сценариев (строка), для массива сценариев игнорируется
- **Возврат `_cache` в `execute_scenario`** — кэш из выполненного сценария автоматически возвращается в `response_data` и доступен через `{_cache.ключ}` в последующих шагах. Кэш возвращается даже при ошибке выполнения, если он был частично накоплен. Кэш из сценариев, вызванных через `jump_to_scenario` внутри `execute_scenario`, также сохраняется и возвращается
- **`format_data_to_text`** — форматирование структурированных данных (массивов объектов) в текстовый формат для промптов и сообщений. Поддерживает два формата: `list` (простой список с шаблоном через `$`) и `structured` (структурированный формат с заголовками и параметрами). Результат автоматически сохраняется в `_cache` с ключом, заданным параметром `cache_key` (по умолчанию `formatted_text`)

### Changed (документация)
- **Плейсхолдеры в условиях `condition` триггеров** — добавлено важное предупреждение в ACTION_GUIDE.md: при использовании плейсхолдеров для сравнения строк в условиях триггеров необходимо оборачивать плейсхолдер в кавычки (например, `'{_cache.field}' == 'value'`), иначе плейсхолдер будет интерпретироваться как атрибут для поиска данных, а не как строковое значение. Для сравнения чисел и boolean значений кавычки не требуются

---

## [0.11.2] - 2025-11-15

### ⚠️ BREAKING CHANGES
- Changed: `exists` и `not exists` больше не являются операторами условий — теперь `exists` это модификатор плейсхолдера. Используйте `{field|exists} == True` или `{field|exists} == False` в условиях вместо `field exists` или `field not exists`

### Added
- Added: `last_result` — служебное поле для отладки, содержит результат последнего выполненного действия (success, error, timeout, not_found)
- Added: Модификатор `exists` для плейсхолдеров — проверка существования значения (возвращает True если значение не None и не пустая строка, иначе False). Использование: `{field|exists} == True` в условиях сценариев
- Added: Действие `scenario_helper.generate_unique_id` — генерация детерминированного уникального ID через автоинкремент в БД. Принимает параметр `seed` (строка), при одинаковых seed возвращает тот же ID. Возвращает `unique_id` в `response_data`

---

## [0.11.1] - 2025-11-15

### Added

- **Удаление по паттернам в storage** — добавлена поддержка удаления записей по паттернам (ILIKE) через опциональные параметры `group_key_pattern` и `key_pattern` для действий `delete_storage_value`, `delete_storage_group` и `delete_user_storage_value`
- **Проверка значения в массиве** — добавлено действие `check_value_in_array` в `scenario_helper` для проверки наличия значения в массиве с возвратом индекса первого вхождения (result: success/not_found)

### Fixed

- **Условия с `not is_null` и `not exists`** — исправлена обработка составных операторов `not is_null` и `not exists` в условиях сценариев, теперь они корректно проверяют наличие и отсутствие значений полей

---

## [0.11.0] - 2025-11-15

### ⚠️ BREAKING CHANGES

- **Удалены группы сценариев** — все сценарии теперь на уровне тенанта, уникальность названий в рамках всего тенанта (не в рамках группы)
- **Папка `scenario_group/` переименована в `scenarios/`** — необходимо переименовать папку в конфигурации тенантов
- **`jump_to_scenario` теперь глобальный** — сценарии могут переходить к любым другим сценариям тенанта независимо от расположения в папках
- **`execute_scenario`** — удален параметр `scenario_group_id` (теперь не требуется)
- **`sync_scenarios`** — изменен параметр `scenario_groups` на `scenarios` (массив сценариев вместо массива групп)

### Changed

- **Поля scheduled сценариев** — удалено поле `scenario_group_id` из событий scheduled сценариев
- **Организация сценариев** — все YAML-файлы из папки `scenarios/` (включая подпапки) автоматически загружаются рекурсивно
- **Документация** — обновлена документация по организации сценариев, удалены упоминания групп сценариев

### Technical Improvements

- **Упрощена структура триггеров** — условие триггера (`condition_expression`) теперь хранится напрямую в таблице `scenario_trigger`, удалена избыточная таблица `scenario_trigger_condition`

---

## [0.10.2] - 2025-11-15

### Added
- **`answer_callback_query`** — новое действие для ответа на callback query (всплывающие уведомления или простые уведомления при нажатии на inline-кнопку). Поддерживает параметры `text`, `show_alert` (всплывающее окно) и `cache_time`

### Fixed
- Исправлено сравнение дат в условиях — теперь корректно работает сравнение дат без кавычек при одинаковых форматах (например, `{date_str} == 2025-11-14`)
- Исправлено сравнение булевых значений в условиях — теперь корректно работает сравнение с `true`/`false` в нижнем регистре (например, `{bool_flag} == true`)

---

## [0.10.1] - 2025-11-15

### Added
- **Поле `inline_keyboard` в событиях** — добавлено поле `inline_keyboard` в события типа `message` и `callback` для доступа к inline-клавиатуре сообщения в формате проекта `[{"Текст кнопки": "callback_data"}]`

---

## [0.10.0] - 2025-11-14

### Added
- **События участников групп** — добавлены новые типы событий `member_joined` и `member_left` для отслеживания вступления и выхода участников из групп
- **`modify_array`** — новое действие в `scenario_helper` для модификации массивов: добавление, удаление элементов или очистка массива
- **Поле `is_group` в событиях** — добавлено булево поле для удобной проверки, является ли чат группой или супергруппой (вместо проверки `chat_type in ['group', 'supergroup']`)
- **События платежей** — добавлены новые типы событий `pre_checkout_query` и `payment_successful` для обработки платежей через Telegram Stars
- **Сервис `invoice_service`** — новый сервис для работы с инвойсами: создание, отправка, создание ссылок, подтверждение/отклонение платежей, получение информации об инвойсах, отмена инвойсов
- **`create_invoice`** — создание инвойса в БД с автоматической отправкой в чат или созданием ссылки
- **`confirm_payment`** — подтверждение платежа (ответ на `pre_checkout_query` с подтверждением)
- **`reject_payment`** — отклонение платежа (ответ на `pre_checkout_query` с отклонением)
- **`get_invoice`** — получение информации об инвойсе по ID
- **`get_user_invoices`** — получение списка всех инвойсов пользователя
- **`cancel_invoice`** — отмена инвойса (только неоплаченных)
- **`mark_invoice_as_paid`** — отметка инвойса как оплаченного (обработка события `payment_successful`)
- **JSON режимы в `ai_completion`** — добавлены параметры `json_mode` (`json_object` или `json_schema`) и `json_schema` для получения структурированных JSON-ответов от модели
- **Поле `response_dict` в `ai_completion`** — автоматически распарсенный словарь из JSON ответа (доступно при использовании `json_mode`)
- **Tool Calling в `ai_completion`** — добавлены параметры `tools` (список доступных функций) и `tool_choice` (управление выбором инструментов) для вызова внешних функций моделью
- **Поле `tool_calls` в `ai_completion`** — массив вызовов функций, которые модель решила выполнить (доступно при использовании `tools`)
- **Гайд по моделям OpenRouter** — добавлена документация OPENROUTER_MODELS_GUIDE.md с таблицей поддержки параметров моделей и описаниями параметров (включая поддержку `tools` и `tool_choice`)

### Changed
- **Оптимизация обработки событий** — улучшена производительность обработки событий при пуллинге
- **Changed (документация):** Обновлена документация по событиям в EVENT_GUIDE.md с описанием новых типов событий участников, поля `is_group` и событий платежей (`pre_checkout_query`, `payment_successful`)

---

## [0.9.0] - 2025-11-13

### Added
- **`get_users_by_storage_value`** — новое действие в `user_hub` для поиска пользователей по ключу и значению в storage (возвращает `user_ids` и `user_count` для рассылок и фильтрации)
- **Модификатор `keys` для плейсхолдеров** — извлечение ключей из объекта (словаря) в массив: `{storage_values|keys|list}` для получения списка групп или ключей
- **Master Bot: управление Tenant Storage** — добавлены сценарии для работы с хранилещем тенанта
- **Master Bot: управление User Storage** — добавлены сценарии для работы с хранилищем юзеров тенанта

### Changed
- **Синхронизация Tenant Storage** — оптимизирована: теперь удаляются только группы, которые присутствуют в конфигурации (группы, отсутствующие в конфиге, остаются нетронутыми)
- **Changed (документация):** Обновлена документация по синхронизации Tenant Storage в STORAGE_CONFIG_GUIDE.md с описанием нового механизма синхронизации
- **Master Bot** — улучшена структура сценариев: добавлено автоматическое удаление сообщений команд, универсальная обработка ошибок, реорганизованы сценарии управления тенантами
- **⚠️ BREAKING CHANGES: User Storage действия** — изменено возвращаемое поле: `storage_values` → `user_storage_values` в действиях `get_user_storage`, `get_user_storage_value` и `set_user_storage_value` для разграничения с Tenant Storage (который использует `storage_values`)

### Fixed
- **Обработка сценариев при обновлении кэша** — исправлена проблема, когда выполняющиеся сценарии могли использовать устаревший кэш во время синхронизации сценариев (например, при self-update тенанта)

---

## [0.8.0] - 2025-11-11

### Added
- Поддержка асинхронных действий в сценариях: добавлен флаг `async: true` и параметр `action_id` для шагов сценариев, позволяющий запускать долгие операции (например, запросы к LLM) в фоне и продолжать выполнение сценария
- Новое действие `wait_for_action`: ожидание завершения асинхронного действия по `action_id`, возвращает результат основного действия AS IS (как будто оно выполнилось напрямую)
- Новые модификаторы плейсхолдеров `ready` и `not_ready`: проверка готовности асинхронных действий через `{_async_action.action_id|ready}` и `{_async_action.action_id|not_ready}`
- Переименование перехода `skip_next` в `move_steps` для большей понятности (перемещение на N шагов вперед/назад)
- Добавлен новый переход `jump_to_step` для перехода к конкретному шагу по индексу (шаги нумеруются с 0)
- Поддержка отрицательных значений в переходе `move_steps`: возможность возвращаться к предыдущим шагам сценария (например, для создания циклов ожидания готовности async действий)
- Новый сервис `scenario_helper`: объединяет действия для генерации случайных чисел и задержек выполнения
- Новое действие `sleep` (scenario_helper): задержка выполнения на указанное количество секунд (поддерживает дробные значения, например 0.5 или 22.5)

### Changed
- Обновлена документация SCENARIO_CONFIG_GUIDE.md: добавлен раздел "Асинхронные действия (Async Actions)" с описанием механики работы, примерами использования и рекомендациями
- Обновлена документация SCENARIO_CONFIG_GUIDE.md: добавлено описание последовательного выполнения шагов и работы таймаутов в `wait_for_action`
- Действия `set_user_storage_value` и `set_storage_value`: теперь возвращают установленное значение в `response_data` (аналогично `get` действиям) и поддерживают опциональный параметр `format` для получения данных в формате YAML

---

## [0.7.0] - 2025-11-10

### Added
- **Scheduled сценарии** — поддержка запуска сценариев по расписанию через cron выражения (поле `schedule` в конфигурации сценария)
- Scheduled сценарии могут работать вместе с обычными триггерами событий (гибридный подход)
- В scheduled сценариях доступны специальные поля события: `scheduled_at` (время запуска), `scheduled_scenario_id`, `scheduled_scenario_name`
- **Динамические клавиатуры** — новое действие `build_keyboard` для создания клавиатур из массивов ID с использованием шаблонов (`text_template`, `callback_template`, параметр `buttons_per_row` для управления количеством кнопок в строке)
- **Получение списков тенантов и пользователей** — новые действия `get_tenants_list` (возвращает `tenant_ids`, `public_tenant_ids`, `system_tenant_ids`, `tenant_count`) и `get_tenant_users` (возвращает `user_ids`, `user_count` для указанного тенанта)
- **Модификатор `expand` для плейсхолдеров** — разворачивание массива массивов на один уровень при использовании в массивах (позволяет комбинировать динамически сгенерированные строки клавиатуры со статичными)

### Changed
- Оптимизирована синхронизация ботов: пулинг перезапускается только при изменении критичных полей (`bot_token`, `is_active`), изменение команд больше не вызывает перезапуск пуллинга
- Улучшено меню выбора тенанта в Master боте: вместо ручного ввода номера тенанта теперь используется динамическая клавиатура со списком доступных тенантов

### Changed (документация)
- Обновлена документация по scheduled сценариям: добавлены разделы в EVENT_GUIDE.md и SCENARIO_CONFIG_GUIDE.md с описанием полей событий, ограничений и рекомендаций по использованию
- Добавлена документация по модификатору `expand` в SCENARIO_CONFIG_GUIDE.md с примерами использования для динамических клавиатур

---

## [0.6.1] - 2025-11-09

### Fixed
- **`send_message`** — при некорректном `file_id` вложения теперь отправляется текстовое сообщение как fallback вместо полного отказа в отправке

---

## [0.6.0] - 2025-11-08

### ⚠️ BREAKING CHANGES
- **`set_user_state`**, **`get_user_state`**, **`clear_user_state`** — параметр `telegram_bot_id` заменен на `tenant_id` (пользователи теперь привязаны к тенанту, а не к боту)

### Added
- **User Storage** — хранилище данных пользователя (key-value) для хранения пользовательских настроек и данных
- **`get_user_storage`** — получение всех значений storage пользователя
- **`get_user_storage_value`** — получение значения атрибута пользователя из хранилища
- **`set_user_storage_value`** — установка значения атрибута пользователя
- **`delete_user_storage_value`** — удаление атрибута пользователя
- **`delete_storage_group`** — удаление всей группы из storage тенанта
- **`format` параметр** (boolean) для действий `get_storage`, `get_storage_group`, `get_storage_value`, `get_user_storage`, `get_user_storage_value` — возвращает дополнительное поле `formatted_text` с данными в формате YAML

### Changed (документация)
- Обновлен STORAGE_CONFIG_GUIDE.md: добавлена информация о User Storage, форматировании YAML, удалении групп и примерах использования обоих типов хранилищ

---

## [0.5.2] - 2025-11-05

### Added
- **`generate_int`** — генерация случайного целого числа в заданном диапазоне с поддержкой seed для детерминированной генерации
- **`generate_array`** — генерация массива случайных чисел в заданном диапазоне (по умолчанию без повторений, опция `allow_duplicates` для разрешения повторений)
- **`choose_from_array`** — выбор случайных элементов из массива без повторений с поддержкой seed
- Поддержка seed для детерминированной генерации во всех действиях генерации случайных чисел

### Changed (документация)
- Обновлен SCENARIO_CONFIG_GUIDE.md: добавлены примеры правильного использования данных из `response_data` действий, предупреждения о конфликтах имен полей и формате доступа к данным

---

## [0.5.1] - 2025-11-04

### Added
- **Storage: поддержка сложных структур данных** — теперь можно хранить JSON объекты (словари), массивы словарей и вложенные структуры в storage
- **Доступ к сложным структурам через плейсхолдеры** — поддержка точечной нотации для объектов (`{storage_values.settings.admin_config.name}`) и комбинации индексов массивов с объектами (`{storage_values.features.users[0].permissions[0]}`)

### Changed (документация)
- Обновлен STORAGE_CONFIG_GUIDE.md: добавлены примеры работы с JSON объектами, массивами словарей и вложенными структурами

---

## [0.5.0] - 2025-11-03

### Added
- **Storage** — хранилище атрибутов тенанта (key-value) для гибкого хранения настроек, лимитов и функций
- **`get_storage_value`**, **`set_storage_value`**, **`delete_storage_value`** — действия для работы с отдельными значениями storage
- **`get_storage_group`**, **`get_storage`** — действия для получения группы или всех значений storage
- Автоматическое преобразование типов значений из storage для использования в математических операциях плейсхолдеров
- Поддержка прямого указания типов в YAML конфигурации storage (int, float, bool вместо строк)

### Changed
- Обновлена документация: добавлен гайд по storage (STORAGE_CONFIG_GUIDE.md), обновлен TENANT_CONFIG_GUIDE.md
- Меню управления тенантом: объединена синхронизация данных — одна кнопка "Синхронизация данных" вместо раздельных кнопок для бота и сценариев
- Фильтр `length` в плейсхолдерах: теперь корректно возвращает количество элементов для массивов (вместо длины строки)

---

## [0.4.2] - 2025-10-30

### Added
- Автоматическая синхронизация тенантов с GitHub-репозиторием (проверка изменений происходит в фоновом режиме)
- Отображение статуса и метаданных обновления тенанта в мастер боте

### Changed
- Улучшен интерфейс и взаимодействие в мастер боте
- Повышена производительность платформы за счет оптимизаций и параллельной обработки

---

## [0.4.1] - 2025-10-29

### Added
- Боты теперь могут параллельно обрабатывать входящие события (ранее обработка была последовательной)

### Fixed
- Исправлена ошибка при удалении сообщений через действие `delete_message`

### Changed
- Улучшено меню мастер бота и меню управления тенантом в Telegram: добавлено отображение статуса бота и пулинга, оптимизированы тексты и кнопки, улучшены сценарии и UX бота
- Обновлена документация: прикрепление файлов к сообщениям через параметр `attachment`, пересылка через плейсхолдеры `{event_attachment[0].file_id}`, расширено описание групп сценариев (изоляция групп, уникальность названий в рамках группы), исправлены опечатки

---

## [0.4.0] - 2025-10-27

### Added
- **`target_chat_id`** — поддержка отправки сообщений в несколько чатов (массив ID чатов). Пример: `target_chat_id: [123456, 789012]` отправит в оба чата
- **`message_edit: boolean`** — управление редактированием через флаг (true = редактировать текущее, false = отправить новое)
- **`last_error`** — автоматическое сохранение ошибки действия в атрибут события. Используется в последующих шагах для отображения ошибок через плейсхолдеры. Пример: `{last_error|fallback:отсутствует}` покажет ошибку или "отсутствует" если её нет.

### Changed
- **`message_edit`** — унифицированный параметр для редактирования: integer (конкретный ID сообщения), boolean (true редактирует текущее из события, false отправляет новое) или не указан (по умолчанию редактирует текущее из события)
- **`text`** — может быть пустой строкой при наличии вложения

### Fixed
- При редактировании и отправке в несколько чатов — редактируется только первый чат из массива, остальные получают новое сообщение
- **`last_message_id`** — всегда возвращает ID сообщения первого чата (включая при массивной отправке)

### ⚠️ BREAKING CHANGES
- **`new_message` параметр удален** — используйте `message_edit: false` для отправки нового сообщения (без редактирования)

---