name: "telegram_polling"
description: "Утилита для пулинга множественных Telegram ботов"
description_en: "Utility for polling multiple Telegram bots"
singleton: true

dependencies:
  - "logger"
  - "settings_manager"
  - "action_hub"
  - "datetime_formatter"

settings:
  # Polling settings (standard for Telegram Bot API)
  polling_timeout:
    type: integer
    default: 20
    description: "Таймаут long polling в секундах (стандартный для Telegram Bot API)"
    description_en: "Long polling timeout in seconds (standard for Telegram Bot API)"
  
  polling_relax:
    type: float
    default: 0.1
    description: "Задержка между запросами в секундах (стандартная для Telegram Bot API)"
    description_en: "Delay between requests in seconds (standard for Telegram Bot API)"
  
  polling_limit:
    type: integer
    default: 100
    description: "Максимальное количество обновлений за запрос (стандартное для Telegram Bot API)"
    description_en: "Max updates per request (standard for Telegram Bot API)"
  
  polling_start_delay:
    type: float
    default: 0.1
    description: "Задержка перед запуском пулинга в секундах (для предотвращения конфликтов)"
    description_en: "Delay before starting polling in seconds (avoid conflicts)"
  
  # Update filtering
  allowed_updates:
    type: array
    default: ["message", "callback_query", "pre_checkout_query"]
    description: "Типы обновлений для получения от Telegram API. Будут установлены через setWebhook перед запуском пулинга"
    description_en: "Update types to receive from Telegram API. Set via setWebhook before polling"
  
  retry_delay:
    type: integer
    default: 5
    description: "Задержка между повторными попытками в секундах"
    description_en: "Delay between retries in seconds"

  retry_after_rate_limit:
    type: integer
    default: 30
    description: "Время ожидания при rate limit (если retry_after не указан в ответе)"
    description_en: "Wait time on rate limit (when retry_after not in response)"
  
  max_retries:
    type: integer
    default: 3
    description: "Максимальное количество повторных попыток"
    description_en: "Maximum number of retries"
  
  max_critical_errors:
    type: integer
    default: 3
    description: "Максимальное количество критических ошибок подряд перед отключением пулинга"
    description_en: "Max consecutive critical errors before stopping polling"
  
  critical_error_codes:
    type: array
    default: [401, 403, 404]
    description: "Коды ошибок Telegram API, считающиеся критическими (401=Unauthorized, 403=Forbidden, 404=Not Found - бот не найден или неверный токен)"
    description_en: "Telegram API error codes treated as critical (401, 403, 404)"
  
  request_timeout:
    type: integer
    default: 35
    description: "Таймаут HTTP запросов в секундах"
    description_en: "HTTP request timeout in seconds"
  
  stop_polling_timeout:
    type: float
    default: 2.0
    description: "Таймаут ожидания завершения основного цикла пулинга в секундах"
    description_en: "Timeout for main polling loop shutdown in seconds"
  
  stop_polling_manager_timeout:
    type: float
    default: 3.0
    description: "Таймаут ожидания остановки пулинга в PollingManager в секундах"
    description_en: "Timeout for PollingManager stop in seconds"
  
  session_close_timeout:
    type: float
    default: 0.5
    description: "Таймаут закрытия HTTP сессии в секундах"
    description_en: "HTTP session close timeout in seconds"

methods:
  start_bot_polling:
    description: "Запуск пулинга для конкретного бота (автоматически останавливает существующий)"
    description_en: "Start polling for a bot (stops existing one)"
    input:
      bot_id:
        type: integer
        description: "ID бота"
        description_en: "Bot ID"
      token:
        type: string
        description: "Токен бота"
        description_en: "Bot token"
      event_callback:
        type: callable
        description: "Callback функция для обработки событий"
        description_en: "Callback for processing events"
    output:
      type: boolean
      description: "Результат запуска пулинга"
      description_en: "Whether polling started"

  stop_bot_polling:
    description: "Остановка пулинга для конкретного бота"
    description_en: "Stop polling for a bot"
    input:
      bot_id:
        type: integer
        description: "ID бота"
        description_en: "Bot ID"
    output:
      type: boolean
      description: "Результат остановки пулинга"
      description_en: "Whether polling stopped"

  stop_all_polling:
    description: "Остановка пулинга всех ботов"
    description_en: "Stop polling for all bots"
    input: {}
    output:
      type: boolean
      description: "Результат остановки пулинга"
      description_en: "Whether polling stopped"

  start_all_polling:
    description: "Запуск пулинга для списка ботов"
    description_en: "Start polling for list of bots"
    input:
      bots_list:
        type: array
        description: "Список ботов для запуска"
        description_en: "List of bots to start"
        items:
          type: object
          properties:
            bot_id:
              type: integer
              description: "ID бота"
              description_en: "Bot ID"
            bot_token:
              type: string
              description: "Токен бота"
              description_en: "Bot token"
            is_active:
              type: boolean
              description: "Активен ли бот"
              description_en: "Whether bot is active"
    output:
      type: integer
      description: "Количество успешно запущенных ботов"
      description_en: "Number of bots started successfully"

features:
  - "Пулинг множественных Telegram ботов"
  - "API фильтрация обновлений (allowed_updates)"
  - "Настройки стандартные для Telegram Bot API (timeout=20, relax=0.1, limit=100)"
  - "Rate limiting и retry логика"
  - "Автоматическое отключение при критических ошибках (401, 403)"
  - "Graceful shutdown для каждого бота"
  - "Внутренние методы для использования в сервисах"
