name: "placeholder_processor"
description: "Высокопроизводительный процессор плейсхолдеров с оптимизациями для обработки шаблонов в действиях и поддержкой вложенных плейсхолдеров (включая параметры модификаторов)"
description_en: "High-performance placeholder processor with optimizations for template processing in actions and nested placeholder support (including modifier parameters)"
singleton: true
dependencies:
  - "logger"
  - "settings_manager"

settings:
  enable_fast_check:
    type: boolean
    default: true
    description: "Включить быструю проверку наличия плейсхолдеров без regex"
    description_en: "Enable fast placeholder check without regex"
  max_nesting_depth:
    type: integer
    default: 10
    description: "Максимальная глубина рекурсии при обработке вложенных плейсхолдеров (включая параметры модификаторов)"
    description_en: "Max recursion depth for nested placeholders (including modifier params)"
methods:
  process_placeholders:
    description: "Универсальный метод обработки плейсхолдеров с поддержкой вложенности и цепочек модификаторов"
    description_en: "Universal placeholder processing with nesting and modifier chains"
    input:
      data_with_placeholders:
        type: dict
        description: "Словарь с плейсхолдерами для обработки"
        description_en: "Dict with placeholders to process"
      values_dict:
        type: dict
        description: "Словарь с значениями для подстановки"
        description_en: "Dict with values for substitution"
      max_depth:
        type: integer
        optional: true
        description: "Максимальная глубина вложенности (по умолчанию из настройки max_nesting_depth)"
        description_en: "Max nesting depth (default from max_nesting_depth setting)"
    output:
      type: dict
      description: "Словарь с обработанными плейсхолдерами"
      description_en: "Dict with processed placeholders"

  process_placeholders_full:
    description: "Обрабатывает плейсхолдеры и возвращает ПОЛНЫЙ объект с обработанными плейсхолдерами"
    description_en: "Process placeholders and return full object with replaced placeholders"
    input:
      data_with_placeholders:
        type: dict
        description: "Словарь с плейсхолдерами для обработки"
        description_en: "Dict with placeholders to process"
      values_dict:
        type: dict
        description: "Словарь с значениями для подстановки"
        description_en: "Dict with values for substitution"
      max_depth:
        type: integer
        optional: true
        description: "Максимальная глубина вложенности (по умолчанию из настройки max_nesting_depth)"
        description_en: "Max nesting depth (default from max_nesting_depth setting)"
    output:
      type: dict
      description: "Полный исходный объект с замененными плейсхолдерами (включая все служебные поля)"
      description_en: "Full source object with replaced placeholders (including all internal fields)"

  process_text_placeholders:
    description: "Универсальный метод для обработки плейсхолдеров в строке"
    description_en: "Universal method for placeholders in string"
    input:
      text:
        type: string
        description: "Строка с плейсхолдерами для обработки"
        description_en: "String with placeholders to process"
      values_dict:
        type: dict
        description: "Словарь с значениями для подстановки"
        description_en: "Dict with values for substitution"
      max_depth:
        type: integer
        optional: true
        description: "Максимальная глубина вложенности (по умолчанию из настройки max_nesting_depth)"
        description_en: "Max nesting depth (default from max_nesting_depth setting)"
    output:
      type: string
      description: "Обработанная строка с замененными плейсхолдерами (поддерживает вложенные плейсхолдеры)"
      description_en: "Processed string with replaced placeholders (supports nested placeholders)"

details: |
  Синтаксис плейсхолдеров:
    - {field_name}
    - {field_name|modifier:param}
    - {field_name|modifier1:param1|modifier2:param2}
    - Вложенные плейсхолдеры в параметрах модификаторов: {field|modifier:{inner}}
    - Точечная нотация для доступа к вложенным полям: {object.field.subfield}
    - Доступ к элементам массивов по индексу: {array[0].field}, {array[-1].field}
    - Литеральные значения в кавычках: {'literal value'}, {"literal value"}
    - Литералы с модификаторами: {'hello'|upper}, {'100'|+50}, {'1d 2w'|seconds}
  
  Арифметические операции:
    - |+value - сложение
    - |-value - вычитание
    - |*value - умножение
    - |/value - деление
    - |%value - остаток от деления
  
  Преобразования:
    - |tags - преобразование в теги (@user)
    - |list - маркированный список (• item)
    - |comma - через запятую (item1, item2)
    - |code - оборачивание значения в code блок (<code>value</code>). Для списков каждый элемент оборачивается отдельно. Особенно полезно в комбинации с list: {items|list|code}
    - |upper - верхний регистр
    - |lower - нижний регистр
    - |title - заглавные буквы каждого слова
    - |capitalize - первая заглавная буква
    - |length - подсчет длины строки (количество символов) или массива (количество элементов)
    - |regex:pattern - извлечение данных по регулярному выражению
    - |seconds - преобразование временных строк в секунды (поддержка формата: Xw Yd Zh Km Ms)
    - |shift:±интервал - сдвиг даты на интервал (PostgreSQL style: +1 day, -2 hours, +1 year 2 months). Поддержка year/month/week/day/hour/minute/second (единственное/множественное число, case-insensitive)
    - |to_date - приведение даты к началу дня (00:00:00), возвращает ISO формат
    - |to_hour - приведение даты к началу часа (минуты и секунды = 0), возвращает ISO формат
    - |to_minute - приведение даты к началу минуты (секунды = 0), возвращает ISO формат
    - |to_second - приведение даты к началу секунды (микросекунды = 0), возвращает ISO формат
    - |to_week - приведение даты к началу недели (понедельник 00:00:00), возвращает ISO формат
    - |to_month - приведение даты к началу месяца (1 число, 00:00:00), возвращает ISO формат
    - |to_year - приведение даты к началу года (1 января, 00:00:00), возвращает ISO формат
    - |expand - разворачивание массива массивов на один уровень при использовании в массиве (для динамических клавиатур)
    - |keys - извлечение ключей из объекта (словаря) в массив
  
  Форматирование:
    - |truncate:length - обрезка текста с ...
    - |format:timestamp - преобразование в Unix timestamp (число секунд с 1970-01-01, например: 1735128000)
    - |format:date - формат даты (dd.mm.yyyy, например: 25.12.2024)
    - |format:time - формат времени (hh:mm, например: 15:30)
    - |format:time_full - формат времени с секундами (hh:mm:ss, например: 15:30:45)
    - |format:datetime - полный формат даты и времени (dd.mm.yyyy hh:mm, например: 25.12.2024 15:30)
    - |format:datetime_full - полный формат даты и времени с секундами (dd.mm.yyyy hh:mm:ss, например: 25.12.2024 15:30:45)
    - |format:pg_date - формат даты для PostgreSQL (YYYY-MM-DD, например: 2024-12-25)
    - |format:pg_datetime - формат даты и времени для PostgreSQL (YYYY-MM-DD HH:MM:SS, например: 2024-12-25 15:30:45)
    - |format:currency - форматирование валюты (1000.00 ₽)
    - |format:percent - форматирование процентов (25.5%)
    - |format:number - форматирование чисел (1234.56)
    - |case:type - преобразование регистра (upper/lower/title/capitalize)
  
  Условные модификаторы:
    - |equals:value - проверка равенства (строковое сравнение)
    - |in_list:item1,item2 - проверка вхождения в список
    - |true - проверка истинности (рекомендуется для boolean полей)
    - |exists - проверка существования значения (возвращает True если значение не None и не пустая строка, иначе False). Используется в условиях: {field|exists} == True
    - |is_null - проверка на null (возвращает True если значение None, пустая строка или строка "null", иначе False). Используется для замены обработки is_null в condition parser
    - |value:result - возврат значения при истинности
  
  Модификаторы для асинхронных действий:
    - |ready - проверка готовности асинхронного действия (True если завершено, False если выполняется)
    - |not_ready - проверка что действие еще выполняется (True если выполняется, False если готово)
  
  Fallback:
    - |fallback:value - замена при отсутствии значения
  
  Примеры использования:
    Базовые:
    - {user_id} - простая замена
    - {username|fallback:Гость} - с дефолтом (параметры с пробелами работают)
    - Привет, {username}! ID: {user_id} - смешанный текст
    
    Модификаторы:
    - {price|*0.9|format:currency} - цепочка модификаторов
    - {status|equals:active|value:Активен|fallback:Неактивен} - условная подстановка
    - {field|exists} - проверка существования (возвращает True/False)
    - {field|code} - оборачивание в <code>value</code>
    - {duration|seconds} - "2h 30m" в секунды (9000)
    - {created|shift:+1 day} - сдвиг даты на +1 день
    - {created|shift:+1 year 2 months|format:date} - сдвиг +1.2 года и форматирование
    
    Точечная нотация и массивы:
    - {user.profile.name|fallback:Неизвестный} - доступ к вложенным полям
    - {attachment[0].file_id} - первый элемент массива
    - {attachment[-1].type} - последний элемент (отрицательные индексы)
    
    Вложенные плейсхолдеры:
    - {reply_entity_id|fallback:{user_forward_id}} - в параметре fallback
    - {a|+{b}} - в арифметическом модификаторе
    - {status|equals:{expected}|value:OK|fallback:BAD} - в условном модификаторе
    
    Литералы:
    - {'hello'|upper} - литерал с модификатором → HELLO
    - {'1d 2w'|seconds} - литеральное время → 1296000
    - {'100'|+50} - литеральная арифметика → 150
    - {'2024-12-25'|shift:+1 day} - литеральная дата со сдвигом → 2024-12-26
    - {"it's working"} - двойные кавычки для строк с одинарными
    - {'test'|upper} и {name} - комбинация литералов и плейсхолдеров

features:
  - "Предкомпиляция регулярных выражений для максимальной производительности"
  - "Быстрые строковые проверки без regex для простых случаев"
  - "Многоуровневая оптимизация обработки"
  - "Поддержка цепочки модификаторов"
  - "Поддержка вложенных плейсхолдеров с настраиваемой глубиной (включая параметры модификаторов)"
  - "Точечная нотация для доступа к вложенным полям объектов (неограниченная глубина)"
  - "Доступ к элементам массивов по индексу (положительные и отрицательные индексы)"
  - "Поддержка вложенных массивов и смешанного доступа (объекты + массивы)"
  - "Сохранение типов данных (числа, булевы, списки)"
  - "Универсальное определение типов результата"
  - "Условные модификаторы для динамической логики"
  - "Форматирование чисел, валют и процентов"
  - "Преобразование временных строк в секунды (поддержка смешанного формата: Xw Yd Zh Km Ms)"
  - "Сдвиг дат на интервалы (PostgreSQL style) с поддержкой месяцев/годов и корректной обработкой краев"
  - "Литеральные значения в одинарных и двойных кавычках (с экранированием)"
  - "Литералы работают со всеми модификаторами без передачи через values_dict"

