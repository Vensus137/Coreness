name: "cache_manager"
description: "Единая утилита для глобального кэширования данных"
singleton: true

dependencies:
  - "logger"
  - "settings_manager"

settings:
  # Expired item cleanup: lazy (on access) + periodic (once per cleanup_interval)
  # Each service manages TTL when calling set()
  # If TTL is not specified - default_ttl is used (memory leak protection)
  
  default_ttl:
    type: integer
    default: 3600
    description: "TTL по умолчанию для ключей без явно указанного TTL и без настройки в ttl (1 час, для защиты от утечки памяти)"
  
  cleanup_interval:
    type: integer
    default: 60
    description: "Интервал периодической очистки истекших элементов кэша в секундах (1 минута)"
  
  cleanup_sample_size:
    type: integer
    default: 50
    description: "Размер случайной выборки для проверки истекших элементов (как в Redis)"
  
  cleanup_expired_threshold:
    type: float
    default: 0.25
    description: "Порог процента истекших элементов в выборке для полной очистки (25% как в Redis)"

methods:
  get:
    description: "Получение значения из кэша по ключу"
    input:
      key:
        type: string
        description: "Ключ кэша (формат: 'group:id', например 'bot:123', 'user:456')"
    output:
      type: any
      description: "Значение из кэша или None если не найдено"
  
  set:
    description: "Установка значения в кэш"
    input:
      key:
        type: string
        description: "Ключ кэша (формат: 'group:id', например 'bot:123', 'user:456')"
      value:
        type: any
        description: "Значение для кэширования"
      ttl:
        type: integer
        optional: true
        description: "TTL в секундах (если не указан, используется default_ttl из настроек)"
    output:
      type: boolean
      description: "Успешно ли установлено значение"
  
  delete:
    description: "Удаление значения из кэша"
    input:
      key:
        type: string
        description: "Ключ кэша (формат: 'group:id')"
    output:
      type: boolean
      description: "Успешно ли удалено значение"
  
  exists:
    description: "Проверка существования ключа в кэше"
    input:
      key:
        type: string
        description: "Ключ кэша (формат: 'group:id')"
    output:
      type: boolean
      description: "Существует ли ключ в кэше"
  
  invalidate_pattern:
    description: "Инвалидация ключей по паттерну"
    input:
      pattern:
        type: string
        description: "Паттерн для поиска ключей (например, 'bot:*' для всех ключей группы bot, 'tenant:123:*' для конкретного тенанта)"
    output:
      type: integer
      description: "Количество удаленных ключей"
  
  clear:
    description: "Очистка всего кэша"
    input: {}
    output:
      type: boolean
      description: "Успешно ли очищен кэш"

