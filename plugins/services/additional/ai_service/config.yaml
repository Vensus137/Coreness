name: "ai_service"
description: "Сервис для интеграции ИИ в сценарии"
description_en: "Service for AI integration in scenarios"
singleton: true
dependencies:
  - "logger"
  - "ai_client"
  - "action_hub"
  - "settings_manager"

settings:
  allow_default_api_key:
    type: boolean
    default: false
    description: "Разрешить использование дефолтного токена из ai_client"
    description_en: "Allow using default token from ai_client"
  
actions:
  completion:
    description: "AI completion через ИИ"
    description_en: "AI completion via AI"
    access_rules: ["data_integrity"]
    public: true
    input:
      data:
        type: object
        properties:
          prompt:
            type: string
            optional: false
            description: "Текст запроса пользователя"
            description_en: "User request text"
          system_prompt:
            type: string
            optional: true
            description: "Системный промпт для контекста"
            description_en: "System prompt for context"
          model:
            type: string
            optional: true
            description: "Модель AI (по умолчанию из настроек)"
            description_en: "AI model (default from settings)"
          max_tokens:
            type: integer
            optional: true
            description: "Максимальное количество токенов (по умолчанию из настроек)"
            description_en: "Maximum tokens (default from settings)"
          temperature:
            type: float
            optional: true
            min: 0.0
            max: 2.0
            description: "Температура генерации (по умолчанию из настроек)"
            description_en: "Generation temperature (default from settings)"
          context:
            type: string
            optional: true
            description: "Кастомный контекст (добавляется в финальное user сообщение в блок ДОП. КОНТЕКСТ вместе с other чанками из rag_chunks)"
            description_en: "Custom context (added to final user message in ADDITIONAL CONTEXT block with other chunks from rag_chunks)"
          rag_chunks:
            type: array
            optional: true
            description: "Массив чанков из RAG поиска для автоматического формирования messages. Чанки группируются по типам: chat_history (диалог), knowledge (база знаний), other (другое - добавляется в ДОП. КОНТЕКСТ). Формат: [{content, document_type, role, processed_at, ...}]"
            description_en: "Array of RAG search chunks for building messages. Types: chat_history, knowledge, other. Format: [{content, document_type, role, processed_at, ...}]"
            items:
              type: object
          json_mode:
            type: string
            optional: true
            enum: ["json_object", "json_schema"]
            description: "Режим JSON для структурированного ответа: 'json_object' или 'json_schema'"
            description_en: "JSON mode for structured response: 'json_object' or 'json_schema'"
          json_schema:
            type: object
            optional: true
            description: "JSON схема для режима json_schema (обязательна при json_mode='json_schema')"
            description_en: "JSON schema for json_schema mode (required when json_mode='json_schema')"
          tools:
            type: array
            optional: true
            description: "Массив объектов-инструментов (tool calling). Каждый элемент — объект: type 'function', function: { name, description, parameters }. parameters — JSON Schema объекта аргументов вызова (OpenAI-совместимый формат)."
            description_en: "Array of tool objects (tool calling). Each item is an object: type 'function', function: { name, description, parameters }. parameters is JSON Schema for the call arguments (OpenAI-compatible format)."
            items:
              type: object
          tool_choice:
            type: string
            optional: true
            description: "Управление выбором инструментов. Строка: 'none' (не вызывать), 'auto' (по умолчанию при наличии tools), 'required' (обязательно вызвать хотя бы один). Объект: принудительный вызов одной функции — {\"type\": \"function\", \"function\": {\"name\": \"имя_функции\"}}."
            description_en: "Tool selection. String: 'none' (do not call), 'auto' (default when tools present), 'required' (must call at least one). Object: force one function — {\"type\": \"function\", \"function\": {\"name\": \"function_name\"}}."
          chunk_format:
            type: object
            optional: true
            description: "Формат отображения чанков в контексте. Шаблоны используют маркеры $ для подстановки значений: $content (обязательно) + любые поля из chunk_metadata. Поддерживается модификатор fallback: $field|fallback:значение. Маркеры работают только с данными чанка (content + chunk_metadata), не затрагивая общий контекст."
            description_en: "Chunk display format in context. Templates use $ markers. $content + chunk_metadata. Fallback: $field|fallback:value. Markers apply only to chunk data."
            properties:
              chat_history:
                type: string
                optional: true
                description: "Шаблон для chat_history чанков. Доступны: $content (обязательно) + любые поля из chunk_metadata"
                description_en: "Template for chat_history chunks. Available: $content + chunk_metadata fields"
              knowledge:
                type: string
                optional: true
                description: "Шаблон для knowledge чанков. Доступны: $content (обязательно) + любые поля из chunk_metadata"
                description_en: "Template for knowledge chunks. Available: $content + chunk_metadata fields"
              other:
                type: string
                optional: true
                description: "Шаблон для other чанков. Доступны: $content (обязательно) + любые поля из chunk_metadata"
                description_en: "Template for other chunks. Available: $content + chunk_metadata fields"
          ai_token:
            type: string
            optional: false
            from_config: true
            description: "AI API ключ из конфига тенанта (_config.ai_token)"
            description_en: "AI API key from tenant config (_config.ai_token)"
    output:
      result:
        type: string
        description: "Результат: success, error, timeout"
        description_en: "Result: success, error, timeout"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки (например, ошибки валидации полей)"
            description_en: "Error details (e.g. field validation errors)"
      response_data:
        type: object
        description: "Данные ответа"
        description_en: "Response data"
        properties:
          response_completion:
            type: string
            description: "Completion ответ от ИИ"
            description_en: "AI completion response"
          prompt_tokens:
            type: integer
            description: "Токены на вход (prompt + context)"
            description_en: "Input tokens (prompt + context)"
          completion_tokens:
            type: integer
            description: "Токены на выход (сгенерированный ответ)"
            description_en: "Output tokens (generated response)"
          total_tokens:
            type: integer
            description: "Общее количество токенов (prompt + completion)"
            description_en: "Total tokens (prompt + completion)"
          model:
            type: string
            description: "Использованная модель"
            description_en: "Model used"
          response_dict:
            type: object
            optional: true
            description: "Распарсенный словарь из JSON ответа (только при использовании json_mode)"
            description_en: "Parsed dict from JSON response (when using json_mode)"
          tool_calls:
            type: array
            optional: true
            description: "При использовании tools — массив объектов вызовов. Каждый элемент: id, type, function: { name, arguments }. arguments — JSON-строка с параметрами вызова (разный набор полей у каждой функции); при необходимости распарсить в сценарии."
            description_en: "When using tools — array of call objects. Each item: id, type, function: { name, arguments }. arguments is a JSON string with call parameters (different keys per function); parse in scenario if needed."
            items:
              type: object
    details: |
      **JSON режимы:**
      - `json_object`: модель возвращает валидный JSON (парсится в `response_dict`)
      - `json_schema`: строгая JSON схема (требуется `json_schema` параметр)
      
      **Tool Calling:**
      - `tools` — массив объектов (каждый: type, function.name, function.description, function.parameters по JSON Schema)
      - Модель решает, какие функции вызвать и с какими параметрами; вызовы возвращаются в `response_data.tool_calls`
      - `tool_calls` — массив объектов: id, type, function.name, function.arguments (JSON-строка); обработка и циклы — в сценарии
      - `tool_choice`: строка 'none'|'auto'|'required' или объект для принудительного вызова одной функции
      
      **Формат чанков (chunk_format):**
      - Настройка отображения чанков из RAG через шаблоны с маркерами `$`
      - Доступны: `$content` (обязательно) + любые поля из `chunk_metadata`
      - Поддерживается fallback: `$field|fallback:значение` (если поле пустое/отсутствует)
      - Маркеры работают только с данными чанка (content + chunk_metadata)
      - Примеры: `"[$username]: $content"`, `"[$category|fallback:Общее]: $content"`
      - Можно задать разные шаблоны для `chat_history`, `knowledge`, `other`
  
  embedding:
    description: "Генерация embedding для текста через ИИ"
    description_en: "Generate text embedding via AI"
    access_rules: ["data_integrity"]
    public: true
    input:
      data:
        type: object
        properties:
          text:
            type: string
            optional: false
            description: "Текст для генерации embedding"
            description_en: "Text for embedding generation"
          model:
            type: string
            optional: true
            description: "Модель для генерации embedding (по умолчанию из настроек ai_client.default_embedding_model)"
            description_en: "Embedding model (default from ai_client.default_embedding_model)"
          dimensions:
            type: integer
            optional: true
            description: "Размерность embedding (по умолчанию из настроек ai_client.default_embedding_dimensions). Поддерживается только для OpenAI text-embedding-3-small и text-embedding-3-large"
            description_en: "Embedding dimensions (default from ai_client). Supported for OpenAI text-embedding-3-* only"
          ai_token:
            type: string
            optional: false
            from_config: true
            description: "AI API ключ из конфига тенанта (_config.ai_token)"
            description_en: "AI API key from tenant config (_config.ai_token)"
    output:
      result:
        type: string
        description: "Результат: success, error"
        description_en: "Result: success, error"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки (например, ошибки валидации полей)"
            description_en: "Error details (e.g. field validation errors)"
      response_data:
        type: object
        description: "Данные ответа"
        description_en: "Response data"
        properties:
          embedding:
            type: array
            description: "Вектор embedding (список чисел)"
            description_en: "Embedding vector (list of numbers)"
            items:
              type: number
          model:
            type: string
            description: "Использованная модель"
            description_en: "Model used"
          dimensions:
            type: integer
            description: "Размерность embedding"
            description_en: "Embedding dimensions"
          total_tokens:
            type: integer
            description: "Общее количество токенов"
            description_en: "Total tokens"
    details: |
      **Генерация векторных представлений текста (embeddings):**
      - Используется для RAG (Retrieval-Augmented Generation) и векторного поиска
      - Возвращает массив чисел (`embedding`) - векторное представление текста
      
      **Размерность (dimensions):**
      - По умолчанию 1024 (настраивается в `ai_client.default_embedding_dimensions`)
      - Поддерживается не всеми моделями (для моделей без поддержки размерность фиксирована)
      
      **Пример:**
      ```yaml
      action: embedding
      data:
        text: "Текст для векторизации"
        dimensions: 1024
      
      # Ответ:
      result: success
      response_data:
        embedding: [0.123, -0.456, ...]  # Вектор из 1024 чисел
        dimensions: 1024
        total_tokens: 15
      ```
