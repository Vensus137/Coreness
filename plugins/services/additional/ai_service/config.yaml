name: "ai_service"
description: "Сервис для интеграции ИИ в сценарии"
singleton: true
dependencies:
  - "logger"
  - "ai_client"
  - "action_hub"
  - "settings_manager"
  - "database_manager"
  - "task_manager"
  - "id_generator"
  - "datetime_formatter"

settings:
  allow_default_api_key:
    type: boolean
    default: false
    description: "Разрешить использование дефолтного токена из ai_client"
  
  chunk_size:
    type: integer
    default: 512
    description: "Размер чанка в символах по умолчанию (используется если не указан в параметрах действия)"
  
  chunk_overlap:
    type: integer
    default: 100
    description: "Перекрытие между чанками в символах по умолчанию (используется если не указано в параметрах действия, ~20% от chunk_size)"
  
  min_chunk_size:
    type: integer
    default: 50
    description: "Минимальный размер чанка в символах (фильтр мусора - чанки меньше этого размера отбрасываются)"
  
  search_limit_chunks:
    type: integer
    default: 10
    description: "Количество результатов поиска (top-k, по умолчанию 10). Работает вместе с limit_chars - сначала выбирается limit_chunks чанков, затем фильтруются по limit_chars"
  
  search_min_similarity:
    type: number
    default: 0.7
    description: "Минимальный порог схожести для поиска (cosine similarity, по умолчанию 0.7)"
  
actions:
  completion:
    description: "AI completion через ИИ"
    access_rules: ["data_integrity"]
    public: true
    input:
      data:
        type: object
        properties:
          prompt:
            type: string
            optional: false
            description: "Текст запроса пользователя"
          system_prompt:
            type: string
            optional: true
            description: "Системный промпт для контекста"
          model:
            type: string
            optional: true
            description: "Модель AI (по умолчанию из настроек)"
          max_tokens:
            type: integer
            optional: true
            description: "Максимальное количество токенов (по умолчанию из настроек)"
          temperature:
            type: float
            optional: true
            min: 0.0
            max: 2.0
            description: "Температура генерации (по умолчанию из настроек)"
          context:
            type: string
            optional: true
            description: "Кастомный контекст (добавляется в финальное user сообщение в блок ДОП. КОНТЕКСТ вместе с other чанками из rag_chunks)"
          rag_chunks:
            type: array
            optional: true
            description: "Массив чанков из RAG поиска для автоматического формирования messages. Чанки группируются по типам: chat_history (диалог), knowledge (база знаний), other (другое - добавляется в ДОП. КОНТЕКСТ). Формат: [{content, document_type, role, processed_at, ...}]"
            items:
              type: object
          json_mode:
            type: string
            optional: true
            enum: ["json_object", "json_schema"]
            description: "Режим JSON для структурированного ответа: 'json_object' или 'json_schema'"
          json_schema:
            type: object
            optional: true
            description: "JSON схема для режима json_schema (обязательна при json_mode='json_schema')"
          tools:
            type: array
            optional: true
            description: "Список доступных функций для вызова моделью (tool calling)"
          tool_choice:
            type: string
            optional: true
            description: "Управление выбором инструментов: 'none', 'auto', 'required' или объект с конкретной функцией"
          chunk_format:
            type: object
            optional: true
            description: "Формат отображения чанков в контексте. Шаблоны используют маркеры $ для подстановки значений: $content (обязательно) + любые поля из chunk_metadata. Поддерживается модификатор fallback: $field|fallback:значение. Маркеры работают только с данными чанка (content + chunk_metadata), не затрагивая общий контекст."
            properties:
              chat_history:
                type: string
                optional: true
                description: "Шаблон для chat_history чанков. Доступны: $content (обязательно) + любые поля из chunk_metadata"
              knowledge:
                type: string
                optional: true
                description: "Шаблон для knowledge чанков. Доступны: $content (обязательно) + любые поля из chunk_metadata"
              other:
                type: string
                optional: true
                description: "Шаблон для other чанков. Доступны: $content (обязательно) + любые поля из chunk_metadata"
          ai_token:
            type: string
            optional: false
            from_config: true
            description: "AI API ключ из конфига тенанта (_config.ai_token)"
    output:
      result:
        type: string
        description: "Результат: success, error, timeout"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        properties:
          code:
            type: string
            description: "Код ошибки"
          message:
            type: string
            description: "Сообщение об ошибке"
          details:
            type: array
            optional: true
            description: "Детали ошибки (например, ошибки валидации полей)"
      response_data:
        type: object
        description: "Данные ответа"
        properties:
          response_completion:
            type: string
            description: "Completion ответ от ИИ"
          prompt_tokens:
            type: integer
            description: "Токены на вход (prompt + context)"
          completion_tokens:
            type: integer
            description: "Токены на выход (сгенерированный ответ)"
          total_tokens:
            type: integer
            description: "Общее количество токенов (prompt + completion)"
          model:
            type: string
            description: "Использованная модель"
          response_dict:
            type: object
            optional: true
            description: "Распарсенный словарь из JSON ответа (только при использовании json_mode)"
          tool_calls:
            type: array
            optional: true
            description: "Список вызовов функций, которые модель решила выполнить (только при использовании tools)"
    details: |
      **JSON режимы:**
      - `json_object`: модель возвращает валидный JSON (парсится в `response_dict`)
      - `json_schema`: строгая JSON схема (требуется `json_schema` параметр)
      
      **Tool Calling:**
      - Параметр `tools` позволяет модели вызывать функции
      - Модель решает, какие функции вызвать и с какими параметрами
      - Результаты вызовов в `response_data.tool_calls`
      - `tool_choice`: управление выбором ('none', 'auto', 'required', или конкретная функция)
      
      **Формат чанков (chunk_format):**
      - Настройка отображения чанков из RAG через шаблоны с маркерами `$`
      - Доступны: `$content` (обязательно) + любые поля из `chunk_metadata`
      - Поддерживается fallback: `$field|fallback:значение` (если поле пустое/отсутствует)
      - Маркеры работают только с данными чанка (content + chunk_metadata)
      - Примеры: `"[$username]: $content"`, `"[$category|fallback:Общее]: $content"`
      - Можно задать разные шаблоны для `chat_history`, `knowledge`, `other`
  
  embedding:
    description: "Генерация embedding для текста через ИИ"
    access_rules: ["data_integrity"]
    public: true
    input:
      data:
        type: object
        properties:
          text:
            type: string
            optional: false
            description: "Текст для генерации embedding"
          model:
            type: string
            optional: true
            description: "Модель для генерации embedding (по умолчанию из настроек ai_client.default_embedding_model)"
          dimensions:
            type: integer
            optional: true
            description: "Размерность embedding (по умолчанию из настроек ai_client.default_embedding_dimensions). Поддерживается только для OpenAI text-embedding-3-small и text-embedding-3-large"
          ai_token:
            type: string
            optional: false
            from_config: true
            description: "AI API ключ из конфига тенанта (_config.ai_token)"
    output:
      result:
        type: string
        description: "Результат: success, error"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        properties:
          code:
            type: string
            description: "Код ошибки"
          message:
            type: string
            description: "Сообщение об ошибке"
          details:
            type: array
            optional: true
            description: "Детали ошибки (например, ошибки валидации полей)"
      response_data:
        type: object
        description: "Данные ответа"
        properties:
          embedding:
            type: array
            description: "Вектор embedding (список чисел)"
            items:
              type: number
          model:
            type: string
            description: "Использованная модель"
          dimensions:
            type: integer
            description: "Размерность embedding"
          total_tokens:
            type: integer
            description: "Общее количество токенов"
    details: |
      **Генерация векторных представлений текста (embeddings):**
      - Используется для RAG (Retrieval-Augmented Generation) и векторного поиска
      - Возвращает массив чисел (`embedding`) - векторное представление текста
      
      **Размерность (dimensions):**
      - По умолчанию 1024 (настраивается в `ai_client.default_embedding_dimensions`)
      - Поддерживается не всеми моделями (для моделей без поддержки размерность фиксирована)
      
      **Пример:**
      ```yaml
      action: embedding
      data:
        text: "Текст для векторизации"
        dimensions: 1024
      
      # Ответ:
      result: success
      response_data:
        embedding: [0.123, -0.456, ...]  # Вектор из 1024 чисел
        dimensions: 1024
        total_tokens: 15
      ```
  
  save_embedding:
    description: "Сохранение текста в vector_storage с автоматическим разбиением на чанки и генерацией embeddings. Поддерживает сохранение только текста без эмбеддинга через параметр generate_embedding=false"
    access_rules: ["data_integrity"]
    public: true
    input:
      data:
        type: object
        properties:
          tenant_id:
            type: integer
            optional: false
            min: 1
            description: "ID тенанта (обязательно)"
          text:
            type: string
            optional: false
            description: "Текст для сохранения (будет очищен и разбит на чанки)"
          document_id:
            type: string
            optional: true
            description: "Уникальный ID документа. Если не указан - будет сгенерирован автоматически через IdSequence (детерминированный по seed)"
          document_type:
            type: string
            optional: false
            enum: ["knowledge", "chat_history", "other"]
            description: "Тип документа: knowledge (база знаний), chat_history (история диалога), other (другое - добавляется в ДОП. КОНТЕКСТ)"
          role:
            type: string
            optional: true
            enum: ["system", "user", "assistant"]
            default: "user"
            description: "Роль для OpenAI messages (по умолчанию 'user'). Используется при формировании контекста в completion"
          chunk_metadata:
            type: object
            optional: true
            description: "Метаданные чанка (JSON объект): chat_id, username и др. Сохраняется в chunk_metadata и используется для фильтрации при поиске и удалении. Может быть использовано в chunk_format для отображения в контексте AI"
          model:
            type: string
            optional: true
            description: "Модель для генерации embedding (по умолчанию из настроек ai_client.default_embedding_model)"
          dimensions:
            type: integer
            optional: true
            description: "Размерность embedding (по умолчанию 1024)"
          chunk_size:
            type: integer
            optional: true
            min: 100
            max: 8000
            description: "Размер чанка в символах (по умолчанию 512)"
          chunk_overlap:
            type: integer
            optional: true
            min: 0
            max: 500
            description: "Перекрытие между чанками в символах (по умолчанию 100, ~20% от chunk_size). Сохраняет контекст на границах чанков для лучшего поиска"
          replace_existing:
            type: boolean
            optional: true
            description: "Заменить существующий документ (по умолчанию false - добавить). Если документ существует и replace_existing=false - вернется ошибка ALREADY_EXISTS"
          generate_embedding:
            type: boolean
            optional: true
            description: "Генерировать ли embedding для чанков (по умолчанию true). Если false - сохраняется только текст без эмбеддинга (полезно для истории без векторного поиска)"
          created_at:
            type: string
            optional: true
            description: "Реальная дата создания (для правильной сортировки истории). Поддерживает форматы: ISO, YYYY-MM-DD, YYYY-MM-DD HH:MM:SS. Если не указано - используется текущее локальное время"
          ai_token:
            type: string
            optional: false
            from_config: true
            description: "AI API ключ из конфига тенанта (_config.ai_token). Требуется только если generate_embedding=true"
    output:
      result:
        type: string
        description: "Результат: success, error"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        properties:
          code:
            type: string
            description: "Код ошибки: ALREADY_EXISTS (документ существует), INTERNAL_ERROR, VALIDATION_ERROR"
          message:
            type: string
            description: "Сообщение об ошибке"
          details:
            type: array
            optional: true
            description: "Детали ошибки (например, ошибки валидации полей)"
      response_data:
        type: object
        description: "Данные ответа"
        properties:
          document_id:
            type: string
            description: "ID сохраненного документа (переданный или сгенерированный)"
          document_type:
            type: string
            description: "Тип документа"
          chunks_count:
            type: integer
            description: "Количество созданных чанков"
          model:
            type: string
            optional: true
            description: "Использованная модель embedding (только если generate_embedding=true)"
          dimensions:
            type: integer
            optional: true
            description: "Размерность embedding (только если generate_embedding=true)"
          total_tokens:
            type: integer
            optional: true
            description: "Общее количество токенов во всех чанках (только если generate_embedding=true)"
          text_length:
            type: integer
            description: "Длина исходного текста (после очистки)"
    details: |
      **Автоматическое сохранение текста с разбиением на чанки:**
      1. Очистка текста (лишние пробелы, невидимые символы)
      2. Разбиение на чанки (гибридный подход: по предложениям/абзацам → по символам)
      3. Генерация embeddings (параллельно, если `generate_embedding=true`)
      4. Сохранение в `vector_storage`
      
      **Режимы сохранения:**
      - `generate_embedding=true` (по умолчанию): с эмбеддингами для векторного поиска
      - `generate_embedding=false`: только текст без эмбеддингов (экономит токены, не требует `ai_token`)
      
      **Перекрытие чанков (chunk_overlap):**
      - Сохраняет контекст на границах для лучшего поиска
      - Рекомендуется ~20% от `chunk_size` (по умолчанию 100 при `chunk_size=512`)
      - Расширяется до целых предложений при разбиении
      
      **Генерация document_id:**
      - Если не указан → генерируется автоматически (детерминированный)
      - Seed: `{tenant_id}:{document_type}:{MD5(text)}`
      - Повторная загрузка того же текста вернет тот же ID
      
      **Обработка существующих документов:**
      - `replace_existing=false` (по умолчанию): ошибка ALREADY_EXISTS если документ существует
      - `replace_existing=true`: старые чанки удаляются, создаются новые
      
      **Пример:**
      ```yaml
      action: save_embedding
      data:
        text: "Длинный текст..."
        document_type: "knowledge"
        chunk_size: 512
        chunk_overlap: 100
      
      # Ответ:
      result: success
      response_data:
        document_id: "doc_12345"
        chunks_count: 5
        total_tokens: 150
      ```
  
  delete_embedding:
    description: "Удаление данных из vector_storage по document_id или по дате processed_at"
    access_rules: ["data_integrity"]
    public: true
    input:
      data:
        type: object
        properties:
          tenant_id:
            type: integer
            optional: false
            min: 1
            description: "ID тенанта (обязательно)"
          document_id:
            type: string
            optional: true
            description: "ID документа для удаления (удаляет все чанки документа). Если указан, остальные параметры игнорируются"
          until_date:
            type: string
            optional: true
            description: "Удалить чанки с processed_at <= until_date включительно (формат: 'YYYY-MM-DD' или 'YYYY-MM-DD HH:MM:SS'). Можно использовать вместе с since_date"
          since_date:
            type: string
            optional: true
            description: "Удалить чанки с processed_at >= since_date включительно (формат: 'YYYY-MM-DD' или 'YYYY-MM-DD HH:MM:SS'). Можно использовать вместе с until_date"
          metadata_filter:
            type: object
            optional: true
            description: "Фильтр по метаданным (JSON объект): например, {'chat_id': 123, 'username': 'user1'}. Используется для фильтрации чанков по сохраненным метаданным. Можно использовать вместе с until_date/since_date"
    output:
      result:
        type: string
        description: "Результат: success, error"
      error:
        type: object
        optional: true
        description: "Информация об ошибке"
        properties:
          code:
            type: string
            description: "Код ошибки"
          message:
            type: string
            description: "Сообщение об ошибке"
      response_data:
        type: object
        description: "Данные ответа"
        properties:
          deleted_chunks_count:
            type: integer
            description: "Количество удаленных чанков"
    details: |
      **Удаление данных из vector_storage:**
      
      **Способы удаления:**
      1. По `document_id` - удаляет все чанки документа (остальные параметры игнорируются)
      2. По дате `processed_at` - удаляет чанки по дате обработки
      3. По `metadata_filter` - удаляет чанки с определенными метаданными
      
      **Параметры даты:**
      - `since_date`: удалить с даты (включительно)
      - `until_date`: удалить до даты (включительно)
      - Можно указать оба параметра (диапазон)
      - Формат: 'YYYY-MM-DD' или 'YYYY-MM-DD HH:MM:SS'
      
      **Примеры:**
      ```yaml
      # По document_id
      data:
        document_id: "doc_12345"
      
      # По дате
      data:
        until_date: "2024-01-01"
      
      # Диапазон дат
      data:
        since_date: "2024-01-01"
        until_date: "2024-12-31"
      
      # По метаданным
      data:
        metadata_filter: {chat_id: 123}
      ```
  
  search_embedding:
    description: "Поиск похожих чанков по тексту или вектору (semantic search) через cosine similarity"
    access_rules: ["data_integrity"]
    public: true
    input:
      data:
        type: object
        properties:
          tenant_id:
            type: integer
            optional: false
            min: 1
            description: "ID тенанта (обязательно)"
          query_text:
            type: string
            optional: true
            description: "Текст запроса для поиска (будет преобразован в embedding). Необходимо указать либо query_text, либо query_vector"
          query_vector:
            type: array
            optional: true
            description: "Готовый вектор для поиска (массив чисел). Размерность должна совпадать с сохраненными embeddings. Необходимо указать либо query_text, либо query_vector"
          limit_chunks:
            type: integer
            optional: true
            min: 1
            max: 200
            description: "Количество результатов (top-k, по умолчанию 10). Работает вместе с limit_chars - сначала выбирается limit_chunks чанков, затем фильтруются по limit_chars"
          limit_chars:
            type: integer
            optional: true
            min: 1
            description: "Лимит по символам (опционально, без ограничения по умолчанию). Работает поверх limit_chunks - после получения limit_chunks чанков они отбираются по порядку (от большего similarity), пока сумма символов не превысит limit_chars. Возвращается столько чанков, сколько влезает в лимит"
          min_similarity:
            type: number
            optional: true
            min: 0.0
            max: 1.0
            description: "Минимальный порог схожести (cosine similarity, по умолчанию из настроек search_min_similarity)"
          document_id:
            type: "string|array"
            optional: true
            description: "Фильтр по document_id. Строка для одного документа или массив для нескольких (например, ['doc_123', 'doc_456'])"
          document_type:
            type: "string|array"
            optional: true
            description: "Фильтр по типу документа. Строка для одного типа или массив для нескольких типов (например, ['message', 'document'])"
          until_date:
            type: string
            optional: true
            description: "Фильтр: искать только чанки с processed_at <= until_date включительно (формат: 'YYYY-MM-DD' или 'YYYY-MM-DD HH:MM:SS'). Можно использовать вместе с since_date"
          since_date:
            type: string
            optional: true
            description: "Фильтр: искать только чанки с processed_at >= since_date включительно (формат: 'YYYY-MM-DD' или 'YYYY-MM-DD HH:MM:SS'). Можно использовать вместе с until_date"
          metadata_filter:
            type: object
            optional: true
            description: "Фильтр по метаданным (JSON объект): например, {'chat_id': 123, 'username': 'user1'}. Используется для фильтрации чанков по сохраненным метаданным. Можно комбинировать с другими фильтрами"
          model:
            type: string
            optional: true
            description: "Модель для генерации embedding (используется только если указан query_text, по умолчанию из настроек ai_client.default_embedding_model)"
          dimensions:
            type: integer
            optional: true
            description: "Размерность embedding (используется только если указан query_text, по умолчанию 1024)"
          ai_token:
            type: string
            optional: false
            from_config: true
            description: "AI API ключ из конфига тенанта (_config.ai_token). Требуется только если указан query_text"
    output:
      result:
        type: string
        description: "Результат: success, error"
      error:
        type: object
        optional: true
        description: "Информация об ошибке"
        properties:
          code:
            type: string
            description: "Код ошибки"
          message:
            type: string
            description: "Сообщение об ошибке"
      response_data:
        type: object
        description: "Данные ответа"
        properties:
          chunks:
            type: array
            description: "Массив найденных чанков"
            items:
              type: object
              properties:
                content:
                  type: string
                  description: "Текст чанка"
                document_id:
                  type: string
                  description: "ID документа"
                chunk_index:
                  type: integer
                  description: "Индекс чанка в документе"
                document_type:
                  type: string
                  description: "Тип документа"
                role:
                  type: string
                  description: "Роль для OpenAI messages: 'system', 'user', 'assistant'"
                chunk_metadata:
                  type: object
                  optional: true
                  description: "Метаданные чанка (JSON объект): chat_id, username и др."
                embedding_model:
                  type: string
                  description: "Модель embedding"
                similarity:
                  type: number
                  description: "Оценка схожести (0.0-1.0, cosine similarity)"
                created_at:
                  type: string
                  description: "Реальная дата создания (ISO формат, для правильной сортировки истории)"
                processed_at:
                  type: string
                  description: "Дата обработки (ISO формат)"
          chunks_count:
            type: integer
            description: "Количество найденных чанков"
    details: |
      **Семантический поиск похожих чанков:**
      - Поиск по cosine similarity между векторами
      - Использует HNSW индекс для быстрого поиска
      - Результаты сортируются по убыванию similarity
      
      **Запрос (требуется одно из):**
      - `query_text`: текст (генерируется embedding автоматически)
      - `query_vector`: готовый вектор (не требует API ключ)
      
      **Параметры поиска:**
      - `limit_chunks`: top-k результатов (по умолчанию 10)
      - `limit_chars`: лимит по символам (работает поверх `limit_chunks`)
      - `min_similarity`: минимальный порог (0.0-1.0, по умолчанию 0.7)
      
      **Фильтры (комбинируются):**
      - `document_type`, `document_id`: строка или массив
      - `since_date`, `until_date`: диапазон дат (формат: 'YYYY-MM-DD' или 'YYYY-MM-DD HH:MM:SS')
      - `metadata_filter`: JSON объект (например, `{chat_id: 123}`)
      
      **Примеры:**
      ```yaml
      # Поиск по тексту
      data:
        query_text: "Как работает RAG?"
        limit_chunks: 10
        min_similarity: 0.75
      
      # Поиск с фильтрами
      data:
        query_text: "Вопрос"
        document_type: ["message", "document"]
        since_date: "2024-01-01"
        until_date: "2024-12-31"
      
      # Поиск с лимитом по символам
      data:
        query_text: "Вопрос"
        limit_chunks: 20
        limit_chars: 5000
      ```
  
  get_recent_chunks:
    description: "Получение последних N чанков по дате created_at (не векторный поиск, просто выборка по дате, сортировка по created_at для правильного порядка истории)"
    access_rules: ["data_integrity"]
    public: true
    input:
      data:
        type: object
        properties:
          tenant_id:
            type: integer
            optional: false
            min: 1
            description: "ID тенанта (обязательно)"
          limit_chunks:
            type: integer
            optional: true
            min: 1
            max: 200
            description: "Количество чанков (по умолчанию 10 из настроек search_limit_chunks). Работает вместе с limit_chars - сначала выбирается limit_chunks чанков, затем фильтруются по limit_chars"
          limit_chars:
            type: integer
            optional: true
            min: 1
            description: "Лимит по символам (опционально, без ограничения по умолчанию). Работает поверх limit_chunks - после получения limit_chunks чанков они отбираются по порядку (от новых к старым), пока сумма символов не превысит limit_chars. Возвращается столько чанков, сколько влезает в лимит"
          document_type:
            type: "string|array"
            optional: true
            description: "Фильтр по типу документа. Строка для одного типа или массив для нескольких типов (например, ['message', 'document'])"
          document_id:
            type: "string|array"
            optional: true
            description: "Фильтр по document_id. Строка для одного документа или массив для нескольких (например, ['doc_123', 'doc_456'])"
          until_date:
            type: string
            optional: true
            description: "Фильтр: искать только чанки с processed_at <= until_date включительно (формат: 'YYYY-MM-DD' или 'YYYY-MM-DD HH:MM:SS'). Можно использовать вместе с since_date"
          since_date:
            type: string
            optional: true
            description: "Фильтр: искать только чанки с processed_at >= since_date включительно (формат: 'YYYY-MM-DD' или 'YYYY-MM-DD HH:MM:SS'). Можно использовать вместе с until_date"
          metadata_filter:
            type: object
            optional: true
            description: "Фильтр по метаданным (JSON объект): например, {'chat_id': 123, 'username': 'user1'}. Используется для фильтрации чанков по сохраненным метаданным. Можно комбинировать с другими фильтрами"
    output:
      result:
        type: string
        description: "Результат: success, error"
      error:
        type: object
        optional: true
        description: "Информация об ошибке"
        properties:
          code:
            type: string
            description: "Код ошибки"
          message:
            type: string
            description: "Сообщение об ошибке"
      response_data:
        type: object
        description: "Данные ответа"
        properties:
          chunks:
            type: array
            description: "Массив найденных чанков (отсортированы по created_at DESC - новые первыми)"
            items:
              type: object
              properties:
                content:
                  type: string
                  description: "Текст чанка"
                document_id:
                  type: string
                  description: "ID документа"
                chunk_index:
                  type: integer
                  description: "Индекс чанка в документе"
                document_type:
                  type: string
                  description: "Тип документа"
                role:
                  type: string
                  description: "Роль для OpenAI messages: 'system', 'user', 'assistant'"
                chunk_metadata:
                  type: object
                  optional: true
                  description: "Метаданные чанка (JSON объект): chat_id, username и др."
                embedding_model:
                  type: string
                  description: "Модель embedding"
                created_at:
                  type: string
                  description: "Реальная дата создания (ISO формат, для правильной сортировки истории)"
                processed_at:
                  type: string
                  description: "Дата обработки (ISO формат)"
          chunks_count:
            type: integer
            description: "Количество найденных чанков"
    details: |
      **Получение последних чанков по дате (НЕ векторный поиск):**
      - Возвращает последние N чанков, отсортированных по `created_at` (новые первыми, для правильного порядка истории)
      - Полезно для получения последних сообщений или истории диалога
      
      **Параметры:**
      - `limit_chunks`: количество чанков (по умолчанию 10)
      - `limit_chars`: лимит по символам (работает поверх `limit_chunks`)
      
      **Фильтры (комбинируются):**
      - `document_type`, `document_id`: строка или массив
      - `since_date`, `until_date`: диапазон дат (формат: 'YYYY-MM-DD' или 'YYYY-MM-DD HH:MM:SS')
      - `metadata_filter`: JSON объект (например, `{chat_id: 123}`)
      
      **Примеры:**
      ```yaml
      # Последние 10 чанков
      data:
        limit_chunks: 10
      
      # Последние сообщения
      data:
        document_type: "message"
        limit_chunks: 20
      
      # Последние чанки документа
      data:
        document_id: "doc_123"
        limit_chunks: 10
      
      # Последние чанки за период
      data:
        since_date: "2024-01-01"
        until_date: "2024-12-31"
        limit_chunks: 50
      ```