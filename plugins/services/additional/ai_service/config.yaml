name: "ai_service"
description: "Сервис для интеграции ИИ в сценарии"
singleton: true
dependencies:
  - "logger"
  - "ai_client"
  - "action_hub"
  - "settings_manager"

settings:
  allow_default_api_key:
    type: boolean
    default: false
    description: "Разрешить использование дефолтного токена из ai_client"
  
actions:
  completion:
    description: "AI completion через ИИ"
    access_rules: ["data_integrity"]
    public: true
    input:
      data:
        type: object
        properties:
          prompt:
            type: string
            optional: false
            description: "Текст запроса пользователя"
          system_prompt:
            type: string
            optional: true
            description: "Системный промпт для контекста"
          model:
            type: string
            optional: true
            description: "Модель AI (по умолчанию из настроек)"
          max_tokens:
            type: integer
            optional: true
            description: "Максимальное количество токенов (по умолчанию из настроек)"
          temperature:
            type: float
            optional: true
            min: 0.0
            max: 2.0
            description: "Температура генерации (по умолчанию из настроек)"
          context:
            type: string
            optional: true
            description: "Кастомный контекст (добавляется в финальное user сообщение в блок ДОП. КОНТЕКСТ вместе с other чанками из rag_chunks)"
          rag_chunks:
            type: array
            optional: true
            description: "Массив чанков из RAG поиска для автоматического формирования messages. Чанки группируются по типам: chat_history (диалог), knowledge (база знаний), other (другое - добавляется в ДОП. КОНТЕКСТ). Формат: [{content, document_type, role, processed_at, ...}]"
            items:
              type: object
          json_mode:
            type: string
            optional: true
            enum: ["json_object", "json_schema"]
            description: "Режим JSON для структурированного ответа: 'json_object' или 'json_schema'"
          json_schema:
            type: object
            optional: true
            description: "JSON схема для режима json_schema (обязательна при json_mode='json_schema')"
          tools:
            type: array
            optional: true
            description: "Список доступных функций для вызова моделью (tool calling)"
          tool_choice:
            type: string
            optional: true
            description: "Управление выбором инструментов: 'none', 'auto', 'required' или объект с конкретной функцией"
          chunk_format:
            type: object
            optional: true
            description: "Формат отображения чанков в контексте. Шаблоны используют маркеры $ для подстановки значений: $content (обязательно) + любые поля из chunk_metadata. Поддерживается модификатор fallback: $field|fallback:значение. Маркеры работают только с данными чанка (content + chunk_metadata), не затрагивая общий контекст."
            properties:
              chat_history:
                type: string
                optional: true
                description: "Шаблон для chat_history чанков. Доступны: $content (обязательно) + любые поля из chunk_metadata"
              knowledge:
                type: string
                optional: true
                description: "Шаблон для knowledge чанков. Доступны: $content (обязательно) + любые поля из chunk_metadata"
              other:
                type: string
                optional: true
                description: "Шаблон для other чанков. Доступны: $content (обязательно) + любые поля из chunk_metadata"
          ai_token:
            type: string
            optional: false
            from_config: true
            description: "AI API ключ из конфига тенанта (_config.ai_token)"
    output:
      result:
        type: string
        description: "Результат: success, error, timeout"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        properties:
          code:
            type: string
            description: "Код ошибки"
          message:
            type: string
            description: "Сообщение об ошибке"
          details:
            type: array
            optional: true
            description: "Детали ошибки (например, ошибки валидации полей)"
      response_data:
        type: object
        description: "Данные ответа"
        properties:
          response_completion:
            type: string
            description: "Completion ответ от ИИ"
          prompt_tokens:
            type: integer
            description: "Токены на вход (prompt + context)"
          completion_tokens:
            type: integer
            description: "Токены на выход (сгенерированный ответ)"
          total_tokens:
            type: integer
            description: "Общее количество токенов (prompt + completion)"
          model:
            type: string
            description: "Использованная модель"
          response_dict:
            type: object
            optional: true
            description: "Распарсенный словарь из JSON ответа (только при использовании json_mode)"
          tool_calls:
            type: array
            optional: true
            description: "Список вызовов функций, которые модель решила выполнить (только при использовании tools)"
    details: |
      **JSON режимы:**
      - `json_object`: модель возвращает валидный JSON (парсится в `response_dict`)
      - `json_schema`: строгая JSON схема (требуется `json_schema` параметр)
      
      **Tool Calling:**
      - Параметр `tools` позволяет модели вызывать функции
      - Модель решает, какие функции вызвать и с какими параметрами
      - Результаты вызовов в `response_data.tool_calls`
      - `tool_choice`: управление выбором ('none', 'auto', 'required', или конкретная функция)
      
      **Формат чанков (chunk_format):**
      - Настройка отображения чанков из RAG через шаблоны с маркерами `$`
      - Доступны: `$content` (обязательно) + любые поля из `chunk_metadata`
      - Поддерживается fallback: `$field|fallback:значение` (если поле пустое/отсутствует)
      - Маркеры работают только с данными чанка (content + chunk_metadata)
      - Примеры: `"[$username]: $content"`, `"[$category|fallback:Общее]: $content"`
      - Можно задать разные шаблоны для `chat_history`, `knowledge`, `other`
  
  embedding:
    description: "Генерация embedding для текста через ИИ"
    access_rules: ["data_integrity"]
    public: true
    input:
      data:
        type: object
        properties:
          text:
            type: string
            optional: false
            description: "Текст для генерации embedding"
          model:
            type: string
            optional: true
            description: "Модель для генерации embedding (по умолчанию из настроек ai_client.default_embedding_model)"
          dimensions:
            type: integer
            optional: true
            description: "Размерность embedding (по умолчанию из настроек ai_client.default_embedding_dimensions). Поддерживается только для OpenAI text-embedding-3-small и text-embedding-3-large"
          ai_token:
            type: string
            optional: false
            from_config: true
            description: "AI API ключ из конфига тенанта (_config.ai_token)"
    output:
      result:
        type: string
        description: "Результат: success, error"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        properties:
          code:
            type: string
            description: "Код ошибки"
          message:
            type: string
            description: "Сообщение об ошибке"
          details:
            type: array
            optional: true
            description: "Детали ошибки (например, ошибки валидации полей)"
      response_data:
        type: object
        description: "Данные ответа"
        properties:
          embedding:
            type: array
            description: "Вектор embedding (список чисел)"
            items:
              type: number
          model:
            type: string
            description: "Использованная модель"
          dimensions:
            type: integer
            description: "Размерность embedding"
          total_tokens:
            type: integer
            description: "Общее количество токенов"
    details: |
      **Генерация векторных представлений текста (embeddings):**
      - Используется для RAG (Retrieval-Augmented Generation) и векторного поиска
      - Возвращает массив чисел (`embedding`) - векторное представление текста
      
      **Размерность (dimensions):**
      - По умолчанию 1024 (настраивается в `ai_client.default_embedding_dimensions`)
      - Поддерживается не всеми моделями (для моделей без поддержки размерность фиксирована)
      
      **Пример:**
      ```yaml
      action: embedding
      data:
        text: "Текст для векторизации"
        dimensions: 1024
      
      # Ответ:
      result: success
      response_data:
        embedding: [0.123, -0.456, ...]  # Вектор из 1024 чисел
        dimensions: 1024
        total_tokens: 15
      ```
