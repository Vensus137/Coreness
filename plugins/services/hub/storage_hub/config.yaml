name: storage_hub
description: "Сервис для управления tenant storage"
description_en: "Service for managing tenant storage"
singleton: true
type: service

dependencies:
  - logger
  - settings_manager
  - action_hub
  - database_manager

settings:
  storage_max_depth:
    type: integer
    default: 20
    description: "Максимальная глубина вложенности для валидации storage структур (словари, массивы)"
    description_en: "Maximum nesting depth for storage structure validation (dicts, arrays)"
  
  storage_max_records:
    type: integer
    default: 100
    description: "Максимальное количество записей storage, возвращаемых при получении данных. Ограничение на выгрузку огромных storage. По умолчанию 100 записей."
    description_en: "Maximum number of storage records returned when fetching data. Limit for large storage export. Default 100."
  
  storage_groups_max_limit:
    type: integer
    default: 200
    description: "Максимальное количество групп, возвращаемых при получении списка групп. Ограничение на отображение огромных списков групп. По умолчанию 200 групп."
    description_en: "Maximum number of groups returned when fetching group list. Limit for large group lists. Default 200."

actions:
  sync_tenant_storage:
    description: "Синхронизация storage для тенанта: парсинг storage/*.yaml + синхронизация с БД"
    description_en: "Sync tenant storage: parse storage/*.yaml + sync to database"
    access_rules: ["system_access"]
    input:
      data:
        type: object
        properties:
          tenant_id:
            type: integer
            optional: false
            min: 1
            description: "ID тенанта"
            description_en: "Tenant ID"
    output:
      result:
        type: string
        description: "Результат: success, error"
        description_en: "Result: success, error"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки"
            description_en: "Error details"

  get_storage:
    description: "Получение значений storage для тенанта. Поддерживает получение всех значений, группы, конкретного значения, а также поиск по паттернам"
    description_en: "Get storage values for tenant. Supports full values, group, single value, and pattern search"
    access_rules: ["data_integrity"]
    public: true
    input:
      data:
        type: object
        properties:
          tenant_id:
            type: integer
            optional: false
            min: 1
            description: "ID тенанта (обязательно)"
            description_en: "Tenant ID (required)"
          group_key:
            type: string
            optional: true
            description: "Ключ группы (точное совпадение, приоритет над group_key_pattern)"
            description_en: "Group key (exact match, takes priority over group_key_pattern)"
          group_key_pattern:
            type: string
            optional: true
            min_length: 1
            description: "Паттерн для поиска группы (ILIKE, используется если group_key не указан)"
            description_en: "Pattern for group search (ILIKE, used when group_key not specified)"
          key:
            type: string
            optional: true
            description: "Ключ атрибута (точное совпадение, приоритет над key_pattern). Используется только если указан group_key или group_key_pattern"
            description_en: "Attribute key (exact match, priority over key_pattern). Only when group_key or group_key_pattern specified"
          key_pattern:
            type: string
            optional: true
            min_length: 1
            description: "Паттерн для поиска ключа (ILIKE, используется если key не указан). Используется только если указан group_key или group_key_pattern"
            description_en: "Pattern for key search (ILIKE, used when key not specified). Only when group_key or group_key_pattern specified"
          format:
            type: boolean
            optional: true
            description: "Если true, возвращает дополнительное поле formatted_text с данными в формате YAML"
            description_en: "If true, returns additional formatted_text field with YAML data"
    output:
      result:
        type: string
        description: "Результат: success, error, not_found"
        description_en: "Result: success, error, not_found"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки"
            description_en: "Error details"
      response_data:
        type: object
        properties:
          storage_values:
            type: any
            replaceable: true
            description: "Запрошенные данные. Если указаны group_key и key - возвращается прямое значение (примитив или объект как есть). Если указан только group_key - возвращается структура группы {key: value}. Если ничего не указано - возвращается полная структура {group_key: {key: value}}"
            description_en: "Requested data. If group_key and key set - raw value. If only group_key - group structure {key: value}. If none - full structure {group_key: {key: value}}"
          formatted_text:
            type: string
            optional: true
            description: "Отформатированный текст в формате YAML (возвращается только если format=true)"
            description_en: "Formatted text in YAML (returned only when format=true)"

  set_storage:
    description: "Установка значений storage для тенанта. Поддерживает смешанный подход: полная структура через values или частичная через group_key/key/value"
    description_en: "Set storage values for tenant. Supports full structure via values or partial via group_key/key/value"
    access_rules: ["data_integrity"]
    public: true
    input:
      data:
        type: object
        description: "Параметры для установки значений. Приоритет: group_key -> key -> value -> values"
        description_en: "Parameters for setting values. Priority: group_key -> key -> value -> values"
        properties:
          tenant_id:
            type: integer
            optional: false
            min: 1
            description: "ID тенанта (обязательно)"
            description_en: "Tenant ID (required)"
          group_key:
            type: string
            optional: true
            description: "Ключ группы (с поддержкой плейсхолдеров). Если указан, используется смешанный подход"
            description_en: "Group key (placeholder support). If set, mixed approach is used"
          key:
            type: string
            optional: true
            description: "Ключ значения (с поддержкой плейсхолдеров). Используется вместе с group_key"
            description_en: "Value key (placeholder support). Used with group_key"
          value:
            type: any
            optional: true
            description: "Значение для установки. Используется вместе с group_key и key"
            description_en: "Value to set. Used with group_key and key"
          values:
            type: object
            optional: true
            description: "Структура для установки. Если указан group_key - структура для группы {key: value}, иначе полная структура {group_key: {key: value}}"
            description_en: "Structure to set. If group_key set - group {key: value}, else full {group_key: {key: value}}"
          format:
            type: boolean
            optional: true
            description: "Если true, возвращает дополнительное поле formatted_text с данными в формате YAML"
            description_en: "If true, returns additional formatted_text field with YAML data"
    output:
      result:
        type: string
        description: "Результат: success, error"
        description_en: "Result: success, error"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки"
            description_en: "Error details"
      response_data:
        type: object
        properties:
          storage_values:
            type: any
            replaceable: true
            description: "Установленные данные. Если установлено одно значение (group_key + key + value) - возвращается прямое значение (примитив или объект как есть). Если установлена группа (group_key + values) - возвращается структура группы {key: value}. Если установлена полная структура (values) - возвращается полная структура {group_key: {key: value}}"
            description_en: "Set data. Single value returns raw value; group returns {key: value}; full returns {group_key: {key: value}}"
          formatted_text:
            type: string
            optional: true
            description: "Отформатированный текст в формате YAML (возвращается только если format=true)"
            description_en: "Formatted text in YAML (returned only when format=true)"

  delete_storage:
    description: "Удаление значений или групп из storage. Если указан key или key_pattern - удаляется значение, иначе удаляется группа"
    description_en: "Delete values or groups from storage. If key or key_pattern set - delete value, else delete group"
    access_rules: ["data_integrity"]
    public: true
    input:
      data:
        type: object
        properties:
          tenant_id:
            type: integer
            optional: false
            min: 1
            description: "ID тенанта (обязательно)"
            description_en: "Tenant ID (required)"
          group_key:
            type: string
            optional: true
            description: "Ключ группы (точное совпадение, приоритет над group_key_pattern)"
            description_en: "Group key (exact match, takes priority over group_key_pattern)"
          group_key_pattern:
            type: string
            optional: true
            min_length: 1
            description: "Паттерн для поиска группы (ILIKE, используется если group_key не указан)"
            description_en: "Pattern for group search (ILIKE, used when group_key not specified)"
          key:
            type: string
            optional: true
            description: "Ключ атрибута (точное совпадение, приоритет над key_pattern). Если указан - удаляется значение, иначе удаляется группа"
            description_en: "Attribute key (exact match). If set - delete value, else delete group"
          key_pattern:
            type: string
            optional: true
            min_length: 1
            description: "Паттерн для поиска ключа (ILIKE, используется если key не указан). Если указан - удаляется значение, иначе удаляется группа"
            description_en: "Pattern for key (ILIKE). If set - delete value, else delete group"
    output:
      result:
        type: string
        description: "Результат: success, error, not_found"
        description_en: "Result: success, error, not_found"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки"
            description_en: "Error details"

  get_storage_groups:
    description: "Получение списка уникальных ключей групп для тенанта. Возвращает только список group_key без значений (с ограничением на количество групп)"
    description_en: "Get list of unique group keys for tenant. Returns group_key list only (limited by storage_groups_max_limit)"
    access_rules: ["data_integrity"]
    public: true
    input:
      data:
        type: object
        properties:
          tenant_id:
            type: integer
            optional: false
            min: 1
            description: "ID тенанта (обязательно)"
            description_en: "Tenant ID (required)"
    output:
      result:
        type: string
        description: "Результат: success, error"
        description_en: "Result: success, error"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки"
            description_en: "Error details"
      response_data:
        type: object
        properties:
          group_keys:
            type: array
            items:
              type: string
            replaceable: true
            description: "Список уникальных ключей групп (ограничен настройкой storage_groups_max_limit)"
            description_en: "List of unique group keys (limited by storage_groups_max_limit)"
          is_truncated:
            type: boolean
            optional: true
            description: "Флаг, указывающий что список был обрезан (true если групп больше лимита, иначе поле отсутствует)"
            description_en: "Flag that list was truncated (true if more groups than limit)"

features:
  - "Парсинг и синхронизация storage/*.yaml"
  - "CRUD операции для tenant storage"
  - "Поддержка вложенных структур (массивы, объекты)"
  - "Валидация глубины вложенности"
  - "Поиск по паттернам"
  - "Форматирование в YAML"
