name: "telegram_bot_manager"
description: "Сервис управления lifecycle Telegram ботов"
description_en: "Service for managing Telegram bot lifecycle"
singleton: true
type: service

dependencies:
  - "logger"
  - "settings_manager"
  - "action_hub"
  - "telegram_polling"
  - "telegram_api"
  - "database_manager"
  - "cache_manager"

optional_dependencies:
  - "http_server"

settings:
  cache_ttl:
    type: integer
    default: 315360000
    description: "TTL для кэша ботов (10 лет в секундах). Вечный кэш, инвалидируется явно"
    description_en: "TTL for bot cache (10 years in seconds). Long-lived cache, invalidated explicitly"
  
  error_cache_ttl:
    type: integer
    default: 300
    description: "TTL для кэширования ошибок (5 минут в секундах)"
    description_en: "TTL for error cache (5 min)"
  
  use_webhooks:
    type: boolean
    default: false
    description: "Использовать вебхуки вместо пулинга (глобально для всех ботов). Требует настройки external_url в http_server"
    description_en: "Use webhooks instead of polling (all bots). Requires http_server external_url"
  
  webhook_endpoint:
    type: string
    default: "/webhooks/telegram"
    description: "Путь эндпоинта для Telegram вебхуков"
    description_en: "Endpoint path for Telegram webhooks"

actions:
  sync_telegram_bot:
    description: "Синхронизация Telegram бота для тенанта: парсинг bots/telegram.yaml + создание/обновление бота + синхронизация команд + запуск"
    description_en: "Sync Telegram bot for tenant: parse bots/telegram.yaml + create/update bot + sync commands + start"
    access_rules: ["system_access"]
    input:
      data:
        type: object
        properties:
          tenant_id:
            type: integer
            optional: false
            min: 1
            description: "ID тенанта"
            description_en: "Tenant ID"
    output:
      result:
        type: string
        description: "Результат: success, error, not_found"
        description_en: "Result: success, error, not_found"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки"
            description_en: "Error details"
      response_data:
        type: object
        optional: true
        description: "Данные ответа (bot_id, action)"
        description_en: "Response data (bot_id, action)"
        properties:
          bot_id:
            type: integer
            description: "ID бота"
            description_en: "Bot ID"
          action:
            type: string
            description: "Выполненное действие"
            description_en: "Action performed"

  get_bot_status:
    description: "Получение статуса пулинга и активности бота"
    description_en: "Get polling status and bot activity"
    access_rules: ["system_access"]
    input:
      data:
        type: object
        properties:
          bot_id:
            type: integer
            optional: false
            min: 1
            description: "ID бота"
            description_en: "Bot ID"
    output:
      result:
        type: string
        description: "Результат запроса"
        description_en: "Request result"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки"
            description_en: "Error details"
      response_data:
        type: object
        description: "Статус бота"
        description_en: "Bot status"
        properties:
          is_polling:
            type: boolean
            description: "Идёт ли пулинг"
            description_en: "Whether polling is active"
          is_webhook_active:
            type: boolean
            description: "Активен ли вебхук"
            description_en: "Whether webhook is active"
          is_active:
            type: boolean
            description: "Активен ли бот"
            description_en: "Whether bot is active"
          is_working:
            type: boolean
            description: "Работает ли бот (polling или webhook)"
            description_en: "Whether bot is working (polling or webhook)"

  start_bot:
    description: "Запуск бота (polling или webhook)"
    description_en: "Start bot (polling or webhook)"
    access_rules: ["system_access"]
    input:
      data:
        type: object
        properties:
          bot_id:
            type: integer
            optional: false
            min: 1
            description: "ID бота"
            description_en: "Bot ID"
    output:
      result:
        type: string
        description: "Результат: success, error"
        description_en: "Result: success, error"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки"
            description_en: "Error details"

  stop_bot:
    description: "Остановка бота"
    description_en: "Stop bot"
    access_rules: ["system_access"]
    input:
      data:
        type: object
        properties:
          bot_id:
            type: integer
            optional: false
            min: 1
            description: "ID бота"
            description_en: "Bot ID"
    output:
      result:
        type: string
        description: "Результат: success, error"
        description_en: "Result: success, error"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки"
            description_en: "Error details"

  stop_all_bots:
    description: "Остановка всех ботов"
    description_en: "Stop all bots"
    access_rules: ["system_access"]
    input:
      data:
        type: object
        description: "Пустой объект"
        description_en: "Empty object"
        properties: {}
    output:
      result:
        type: string
        description: "Результат: success, error"
        description_en: "Result: success, error"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки"
            description_en: "Error details"

  sync_bot_config:
    description: "Синхронизация конфигурации бота: создание/обновление бота + запуск"
    description_en: "Sync bot config: create/update bot + start"
    access_rules: ["system_access"]
    input:
      data:
        type: object
        properties:
          tenant_id:
            type: integer
            optional: false
            min: 1
            description: "ID тенанта"
            description_en: "Tenant ID"
          bot_token:
            type: string
            optional: true
            min_length: 1
            description: "Токен бота Telegram"
            description_en: "Telegram bot token"
          is_active:
            type: boolean
            optional: false
            description: "Активен ли бот"
            description_en: "Whether bot is active"
    output:
      result:
        type: string
        description: "Результат: success, error"
        description_en: "Result: success, error"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки"
            description_en: "Error details"
      response_data:
        type: object
        description: "Данные ответа"
        description_en: "Response data"
        properties:
          bot_id:
            type: integer
            description: "ID бота"
            description_en: "Bot ID"
          action:
            type: string
            description: "Выполненное действие"
            description_en: "Action performed"

  sync_bot_commands:
    description: "Синхронизация команд бота: сохранение в БД → применение в Telegram"
    description_en: "Sync bot commands: save to DB → apply in Telegram"
    access_rules: ["system_access"]
    input:
      data:
        type: object
        properties:
          bot_id:
            type: integer
            optional: false
            min: 1
            description: "ID бота"
            description_en: "Bot ID"
          command_list:
            type: array
            optional: false
            description: "Список команд бота"
            description_en: "List of bot commands"
    output:
      result:
        type: string
        description: "Результат: success, error"
        description_en: "Result: success, error"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки"
            description_en: "Error details"

  set_bot_token:
    description: "Установка токена бота"
    description_en: "Set bot token"
    access_rules: ["system_access"]
    input:
      data:
        type: object
        properties:
          tenant_id:
            type: integer
            optional: false
            min: 1
            description: "ID тенанта"
            description_en: "Tenant ID"
          bot_token:
            type: "string|None"
            optional: true
            description: "Токен бота или null для сброса"
            description_en: "Bot token or null to clear"
    output:
      result:
        type: string
        description: "Результат: success, error"
        description_en: "Result: success, error"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки"
            description_en: "Error details"

  sync_bot:
    description: "Синхронизация бота: конфигурация + команды"
    description_en: "Sync bot: config + commands"
    access_rules: ["system_access"]
    input:
      data:
        type: object
        properties:
          tenant_id:
            type: integer
            optional: false
            min: 1
            description: "ID тенанта"
            description_en: "Tenant ID"
          bot_token:
            type: string
            optional: false
            min_length: 1
            description: "Токен бота Telegram"
            description_en: "Telegram bot token"
          is_active:
            type: boolean
            optional: true
            description: "Активен ли бот"
            description_en: "Whether bot is active"
          bot_commands:
            type: array
            optional: true
            description: "Список команд бота"
            description_en: "List of bot commands"
    output:
      result:
        type: string
        description: "Результат: success, error"
        description_en: "Result: success, error"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки"
            description_en: "Error details"
      response_data:
        type: object
        optional: true
        description: "Данные ответа (bot_id, action)"
        description_en: "Response data (bot_id, action)"
        properties:
          bot_id:
            type: integer
            description: "ID бота"
            description_en: "Bot ID"
          action:
            type: string
            description: "Выполненное действие"
            description_en: "Action performed"

  get_telegram_bot_info:
    description: "Получение информации о боте через Telegram API"
    description_en: "Get bot info via Telegram API"
    access_rules: ["system_access"]
    input:
      data:
        type: object
        properties:
          bot_token:
            type: string
            optional: false
            min_length: 1
            description: "Токен бота Telegram"
            description_en: "Telegram bot token"
    output:
      result:
        type: string
        description: "Результат запроса"
        description_en: "Request result"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки"
            description_en: "Error details"
      response_data:
        type: object
        description: "Данные бота из Telegram API"
        description_en: "Bot data from Telegram API"
        properties:
          telegram_bot_id:
            type: integer
            description: "ID бота в Telegram"
            description_en: "Bot ID in Telegram"
          username:
            type: string
            description: "Username бота"
            description_en: "Bot username"
          first_name:
            type: string
            description: "Имя бота"
            description_en: "Bot first name"

  get_bot_info:
    description: "Получение информации о боте из базы данных (с кэшированием)"
    description_en: "Get bot info from database (with caching)"
    access_rules: ["system_access"]
    input:
      data:
        type: object
        properties:
          bot_id:
            type: integer
            optional: false
            min: 1
            description: "ID бота"
            description_en: "Bot ID"
          force_refresh:
            type: boolean
            optional: true
            description: "Принудительно обновить кэш"
            description_en: "Force refresh cache"
    output:
      result:
        type: string
        description: "Результат запроса"
        description_en: "Request result"
      error:
        type: object
        optional: true
        description: "Структура ошибки"
        description_en: "Error structure"
        properties:
          code:
            type: string
            description: "Код ошибки"
            description_en: "Error code"
          message:
            type: string
            description: "Сообщение об ошибке"
            description_en: "Error message"
          details:
            type: array
            optional: true
            description: "Детали ошибки"
            description_en: "Error details"
      response_data:
        type: object
        description: "Данные бота из БД"
        description_en: "Bot data from database"
        properties:
          bot_id:
            type: integer
            description: "ID бота"
            description_en: "Bot ID"
          telegram_bot_id:
            type: integer
            description: "ID бота в Telegram"
            description_en: "Bot ID in Telegram"
          tenant_id:
            type: integer
            description: "ID тенанта"
            description_en: "Tenant ID"
          bot_token:
            type: string
            description: "Токен бота"
            description_en: "Bot token"
          username:
            type: string
            description: "Username бота"
            description_en: "Bot username"
          first_name:
            type: string
            description: "Имя бота"
            description_en: "Bot first name"
          is_active:
            type: boolean
            description: "Активен ли бот"
            description_en: "Whether bot is active"
          bot_command:
            type: array
            description: "Команды бота"
            description_en: "Bot commands"

features:
  - "Управление жизненным циклом ботов"
  - "Синхронизация из YAML конфигураций"
  - "Поддержка polling и webhook режимов"
  - "Управление командами ботов"
  - "Кеширование информации о ботах"
