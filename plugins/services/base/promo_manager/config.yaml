name: "promo_manager"
description: "Сервис для управления промокодами: создание, модификация, проверка доступности и получение списков"
dependencies:
  utilities:
    - "logger"
    - "database_service"
    - "hash_manager"
    - "datetime_formatter"
    - "settings_manager"
    - "users_directory"
settings:
  queue_read_interval:
    type: float
    default: 0.10
    description: "Интервал (в секундах) между чтением очереди действий"
  queue_batch_size:
    type: integer
    default: 50
    description: "Максимальное количество действий, обрабатываемых за одну итерацию чтения очереди"
  default_code_length:
    type: integer
    default: 8
    description: "Длина промокода по умолчанию (6-16 символов)"
  default_expire_days:
    type: integer
    default: 30
    description: "Срок действия промокода по умолчанию (в днях)"
  default_global_promos:
    type: boolean
    default: false
    description: "По умолчанию промокоды локальные (привязаны к user_id из события). True = глобальные для всех"
actions:
  create_promo:
    description: "Создание промокода (ручное или автогенерация)"
    required_data:
      - promo_name
    config_attrs:
      promo_code:
        type: string
        description: "Код промокода (опционально, если не указан - генерируется автоматически)"
      target_user_id:
        type: integer
        description: "ID пользователя для привязки (опционально, 'Any'/'Null' = для всех, по умолчанию user_id из ивента или глобальный согласно настройке default_global_promos)"
      started_at:
        type: string
        description: "Дата начала действия (опционально, ISO формат, по умолчанию - текущее время)"
      expired_at:
        type: string
        description: "Дата окончания действия (опционально, ISO формат)"
      expire:
        type: string
        description: "Срок действия от текущего времени (например, '2d 4h 30m')"
      permanent:
        type: boolean
        description: "Постоянный промокод (действует с 2000 по 2999 год)"
      length:
        type: integer
        description: "Длина кода (6-16 символов)"
      use_digits:
        type: boolean
        description: "Использовать цифры"
      use_letters:
        type: boolean
        description: "Использовать буквы"
      salt:
        type: string
        description: "Соль для детерминированной генерации (по умолчанию 'default')"
      use_random:
        type: boolean
        description: "Случайная генерация (true) или детерминированная (false)"
    response_data:
      success:
        type: boolean
        description: "Успех операции"
      promo_id:
        type: integer
        description: "ID созданного промокода"
      promo_code:
        type: string
        description: "Созданный код промокода"
      promo_name:
        type: string
        description: "Название промокода"
      started_at:
        type: string
        description: "Дата начала действия"
      expired_at:
        type: string
        description: "Дата окончания действия"
      # Параметры генерации кода
      target_user_id:
        type: integer
        description: "ID пользователя для привязки (None = для всех)"
      permanent:
        type: boolean
        description: "Постоянный промокод"
      use_digits:
        type: boolean
        description: "Использовать цифры при генерации"
      use_letters:
        type: boolean
        description: "Использовать буквы при генерации"
      salt:
        type: string
        description: "Соль для детерминированной генерации"
      use_random:
        type: boolean
        description: "Случайная генерация (true) или детерминированная (false)"
      error:
        type: string
        description: "Описание ошибки при неудачном выполнении"
  
  modify_promo:
    description: "Изменение любых полей промокода"
    required_data:
      - promo_id
    config_attrs:
      promo_code:
        type: string
        description: "Новый код промокода (опционально)"
      promo_name:
        type: string
        description: "Новое название (опционально)"
      target_user_id:
        type: integer
        description: "Новый ID пользователя (опционально, 'Any'/'Null' = для всех)"
      started_at:
        type: string
        description: "Новая дата начала (опционально, ISO формат)"
      expired_at:
        type: string
        description: "Новая дата окончания (опционально, ISO формат)"
      expire:
        type: string
        description: "Новый срок действия от текущего времени (например, '2d 4h 30m')"
      permanent:
        type: boolean
        description: "Сделать промокод постоянным (действует с 2000 по 2999 год)"
    response_data:
      success:
        type: boolean
        description: "Успех операции"
      promo_id:
        type: integer
        description: "ID измененного промокода"
      promo_code:
        type: string
        description: "Код промокода"
      promo_name:
        type: string
        description: "Название промокода"
      started_at:
        type: string
        description: "Дата начала действия"
      expired_at:
        type: string
        description: "Дата окончания действия"
      # Параметры генерации кода
      target_user_id:
        type: integer
        description: "ID пользователя для привязки (None = для всех)"
      permanent:
        type: boolean
        description: "Постоянный промокод"
      use_digits:
        type: boolean
        description: "Использовать цифры при генерации"
      use_letters:
        type: boolean
        description: "Использовать буквы при генерации"
      salt:
        type: string
        description: "Соль для детерминированной генерации"
      use_random:
        type: boolean
        description: "Случайная генерация (true) или детерминированная (false)"
      error:
        type: string
        description: "Описание ошибки при неудачном выполнении"
  
  check_promo:
    description: "Проверка доступности промокода для пользователя"
    required_data:
      - promo_code
      - user_id
    response_data:
      promo_available:
        type: boolean
        description: "Доступен ли промокод"
      promo_data:
        type: object
        description: "Данные промокода (если доступен)"
      reason:
        type: string
        description: "Причина недоступности (если не доступен)"
      error:
        type: string
        description: "Описание ошибки при неудачном выполнении"

  promo_management:
    description: "Управление промокодами (просмотр списка, детали)"
    required_data: []
    config_attrs:
      operation:
        type: string
        description: "Тип операции: 'list' или 'details'"
      name_pattern:
        type: string
        description: "Фильтр по названию промокода (частичное совпадение)"
      user_filter:
        type: string
        description: "Фильтр по пользователю (username с @ или без, user_id)"
      promo_code:
        type: string
        description: "Фильтр по коду промокода"
      date_from:
        type: string
        description: "Фильтр по дате создания"
      date_to:
        type: string
        description: "Фильтр по дате создания"
      expired_before:
        type: string
        description: "Фильтр по дате истечения"
      expired_after:
        type: string
        description: "Фильтр по дате истечения"
      limit:
        type: integer
        default: 50
        description: "Максимальное количество промокодов для отображения"
      event_text:
        type: string
        description: "ID промокода для операции 'details'"
      promo_id:
        type: integer
        description: "ID промокода для операции 'details' (приоритет над event_text)"
    response_data:
      response_text:
        type: string
        description: "Форматированный текст результата"
      error:
        type: string
        description: "Описание ошибки при неудачном выполнении"

features:
  - "Создание промокодов с ручным вводом или автогенерацией"
  - "Модификация любых полей существующих промокодов"
  - "Проверка доступности промокодов для пользователей"
  - "Управление промокодами (просмотр списка, детали)"
  - "Поддержка пользовательских и глобальных промокодов"
  - "Автоматическая генерация уникальных кодов через hash_manager"
  - "Асинхронная обработка через очередь действий"
  - "Интеграция с системой пользователей и дат"
