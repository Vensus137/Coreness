# ============================================
# Tenant Configuration Management
# Purpose: setting tenant configuration attributes (ai_token, etc.)
# ============================================

# ============================================
# BLOCK 1: Tenant Configuration Main Menu
# ============================================

# Tenant configuration menu
tenant_config_menu:
  description: "Display tenant configuration menu"

  trigger:
    - event_type: "callback"
      callback_data: "tenant_config_menu"
  
  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get active tenant from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "send_message"
      params:
        text: |
          ‚öôÔ∏è <b>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ–Ω–∞–Ω—Ç–∞ <code>{_cache.active_tenant_id}</code></b>
          
          –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–µ–Ω–∞–Ω—Ç–∞.
        inline:
          - [{"üîë AI —Ç–æ–∫–µ–Ω": "set_ai_token_input"}]
          - [{"üîô –ö –º–µ–Ω—é —Ç–µ–Ω–∞–Ω—Ç–∞": "tenant"}]

# ============================================
# BLOCK 2: AI Token Setup
# ============================================

# AI token request
set_ai_token_input:
  description: "Request AI token for setup"

  trigger:
    - event_type: "callback"
      callback_data: "set_ai_token_input"

  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get active tenant from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # Send message with instruction
    - action: "send_message"
      params:
        text: |
          üîë <b>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ AI —Ç–æ–∫–µ–Ω–∞</b>
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
          
          –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω AI API –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏.
          
          –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –≤–≤–µ–¥–∏—Ç–µ <code>null</code> –∏–ª–∏ <code>none</code> (–≤ –ª—é–±–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ).
          
          ‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ:</b> –¢–æ–∫–µ–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –≤—Å–µ—Ö AI –∑–∞–ø—Ä–æ—Å–æ–≤ —ç—Ç–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞.
        inline:
          - [{"‚ùå –û—Ç–º–µ–Ω–∞": "tenant_config_menu"}]
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "set_ai_token"
        expires_in_seconds: 300

# AI token input handling
set_ai_token_handler:
  description: "AI token input handling"

  trigger:
    - event_type: "message"
      user_state: "set_ai_token"

  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Check that input is not a command
    - action: "execute_scenario"
      params:
        scenario: "check_message"
    
    # Get active tenant from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # Clear state
    - action: "clear_user_state"
    
    # Check if input is null/none (for token deletion)
    - action: "validate"
      params:
        condition: '{event_text|lower} == "null" or {event_text|lower} == "none"'
      transition:
        - action_result: "success"
          transition_action: "jump_to_scenario"
          transition_value: "set_ai_token_delete"
        - action_result: "failed"
          transition_action: "continue"
        - action_result: "error"
          transition_action: "continue"
    
    # Token format validation (allowed characters: letters, numbers, dashes, underscores)
    - action: "validate"
      params:
        condition: '$event_text regex "^[A-Za-z0-9_-]+$"'
      transition:
        - action_result: "success"
          transition_action: "continue"
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "set_ai_token_invalid_format"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "set_ai_token_invalid_format"
    
    # Send notification about installation start
    - action: "send_message"
      params:
        text: |
          ‚è≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ AI —Ç–æ–∫–µ–Ω–∞...
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
    
    # Set AI token
    - action: "update_tenant_config"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        ai_token: "{event_text}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "set_ai_token_error"
    
    # Successful completion
    - action: "send_message"
      params:
        text: |
          ‚úÖ AI —Ç–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
          
          –¢–æ–∫–µ–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –≤—Å–µ—Ö AI –∑–∞–ø—Ä–æ—Å–æ–≤ —ç—Ç–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞.
        message_edit: "{_cache.last_message_id}"
      transition:
        - action_result: "any"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_config_menu"

# Invalid token format error handling
set_ai_token_invalid_format:
  description: "Invalid AI token format error handling"

  step:
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞</b>
          
          –¢–æ–∫–µ–Ω –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è.
          
          –ü—Ä–∏–º–µ—Ä: <code>ak_example_token_123</code>
          
          –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.
        inline:
          - [{"üîô –ö –º–µ–Ω—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏": "tenant_config_menu"}]

# Token deletion (via null/none input)
set_ai_token_delete:
  description: "AI token deletion via null/none input"

  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get active tenant from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # Send notification about deletion start
    - action: "send_message"
      params:
        text: |
          ‚è≥ –£–¥–∞–ª–µ–Ω–∏–µ AI —Ç–æ–∫–µ–Ω–∞...
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
    
    # Delete AI token (pass null)
    - action: "update_tenant_config"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        ai_token: null
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "set_ai_token_error"
    
    # Successful completion
    - action: "send_message"
      params:
        text: |
          ‚úÖ AI —Ç–æ–∫–µ–Ω —É–¥–∞–ª–µ–Ω
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
          
          –¢–æ–∫–µ–Ω –±—ã–ª —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–µ–Ω–∞–Ω—Ç–∞.
        message_edit: "{_cache.last_message_id}"
      transition:
        - action_result: "any"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_config_menu"

# Token setup error handling
set_ai_token_error:
  description: "AI token setup error handling"

  step:
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ–∫–µ–Ω–∞</b>
          
          –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
          ‚Ä¢ –¢–µ–Ω–∞–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
          ‚Ä¢ –¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º

          ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <code>{user_id}</code>
          –õ–æ–≥ –æ—à–∏–±–∫–∏: <code>{last_error.message|fallback:–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞}</code>
        inline:
          - [{"üîô –ö –º–µ–Ω—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏": "tenant_config_menu"}]

