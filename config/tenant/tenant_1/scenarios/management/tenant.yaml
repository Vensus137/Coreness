# ============================================
# Tenant Management
# Purpose: selection, switching and management of tenants with owner binding
# Uses User Storage to store active tenant
# ============================================

# ============================================
# BLOCK 1: Tenant Main Menu
# ============================================

tenant:
  description: "Universal tenant management scenario - access check and active tenant"
  
  trigger:
    - event_type: "message"
      event_text: "/tenant"
    - event_type: "callback"
      callback_data: "tenant"

  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get active tenant from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # Check if there is an active tenant
    - action: "validate"
      params:
        condition: "{_cache.active_tenant_id|exists} == True and {_cache.active_tenant_id|fallback:0} > 0"
      transition:
        - action_result: "success"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_menu"
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_not_selected"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"

# Tenant menu (with message editing)
tenant_menu:
  description: "Display active tenant menu"

  step:
    # Get active tenant from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # Get tenant bot status
    - action: "get_tenant_status"
      params:
        tenant_id: "{_cache.active_tenant_id}"
    
    - action: "send_message"
      params:
        text: |
          üè† <b>–ú–µ–Ω—é —Ç–µ–Ω–∞–Ω—Ç–∞ <code>{_cache.active_tenant_id}</code></b>
          
          –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞: <code>{_cache.bot_is_active|equals:True|value:‚úÖ –í–∫–ª—é—á–µ–Ω|fallback:{_cache.bot_is_active|equals:False|value:‚ùå –í—ã–∫–ª—é—á–µ–Ω|fallback:‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ}}</code>
          –°—Ç–∞—Ç—É—Å —Ä–∞–±–æ—Ç—ã: <code>{_cache.bot_is_working|equals:True|value:‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç|fallback:{_cache.bot_is_working|equals:False|value:‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç|fallback:‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ}}</code>

          –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: <code>{_cache.last_updated_at|format:datetime_full|fallback:‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ}</code>
          {_cache.last_error|length|true|value:–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: <code></code>}<code>{_cache.last_failed_at|format:datetime_full}</code>{_cache.last_failed_at|length|true|value: ‚Äî }<code>{_cache.last_error|fallback:}</code>
        inline:
          - [{"üè¢ Tenant Storage": "tenant_storage_menu"}, {"üë§ User Storage": "user_storage_menu"}]
          - [{"‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ–Ω–∞–Ω—Ç–∞": "tenant_config_menu"}, {"üîë –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω": "set_bot_token_input"}]
          - [{"üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö": "sync_tenant_data"}, {"üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å": "tenant"}]
          - [{"üîÄ –°–º–µ–Ω–∏—Ç—å —Ç–µ–Ω–∞–Ω—Ç": "tenant_not_selected"}]

# ============================================
# BLOCK 2: Tenant Selection
# ============================================

# Tenant selection menu
tenant_not_selected:
  description: "Determine user type and display list of available tenants"

  trigger:
    - event_type: "callback"
      callback_data: "tenant_not_selected"
  
  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Check if user is an administrator
    - action: "validate"
      params:
        condition: "{_cache.user.admin} == True"
      transition:
        - action_result: "success"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_select_all"
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_select_owner"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_select_owner"

# Owner tenant selection menu (for regular users)
tenant_select_owner:
  description: "Display owner tenant list for selection"

  step:
    # Check if there are bound tenants
    - action: "validate"
      params:
        condition: "{_cache.user.tenant_owner|exists} == True and {_cache.user.tenant_owner|length} > 0"
      transition:
        - action_result: "success"
          transition_action: "continue"
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_no_access"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Build dynamic keyboard from owner tenants
    - action: "build_keyboard"
      params:
        items: "{_cache.user.tenant_owner}"
        keyboard_type: "inline"
        text_template: "–¢–µ–Ω–∞–Ω—Ç $value$"
        callback_template: "select_tenant_$value$"
        buttons_per_row: 3
    
    # Send message with dynamic keyboard
    - action: "send_message"
      params:
        text: |
          üìã <b>–í—ã–±–æ—Ä —Ç–µ–Ω–∞–Ω—Ç–∞</b>
          
          –í—ã–±–µ—Ä–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞:
        inline:
          - "{_cache.keyboard|expand}"
          - [{"üîô –ù–∞–∑–∞–¥": "start"}]

# All tenants selection menu (for system administrators)
tenant_select_all:
  description: "Display list of all tenants for selection (system + public)"

  step:
    # Get list of all tenants
    - action: "get_tenants_list"
      params: {}
    
    # Build dynamic keyboard from all tenants (system + public)
    - action: "build_keyboard"
      params:
        items: "{_cache.tenant_ids}"
        keyboard_type: "inline"
        text_template: "–¢–µ–Ω–∞–Ω—Ç $value$"
        callback_template: "select_tenant_$value$"
        buttons_per_row: 3
    
    # Send message with dynamic keyboard
    - action: "send_message"
      params:
        text: |
          üìã <b>–í—ã–±–æ—Ä —Ç–µ–Ω–∞–Ω—Ç–∞</b>
          
          –í—ã–±–µ—Ä–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞:
        inline:
          - "{_cache.keyboard|expand}"
          - [{"üîô –ù–∞–∑–∞–¥": "start"}]

# No available tenants notification
tenant_no_access:
  description: "Notification about absence of available tenants"

  step:
    - action: "send_message"
      params:
        text: |
          ‚ÑπÔ∏è <b>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤</b>
          
          –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞.
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "start"}]

# ============================================
# BLOCK 3: Tenant Selection Handling
# ============================================

# Tenant selection handling from dynamic keyboard
tenant_select_handler:
  description: "Tenant selection handling with access check and saving to User Storage"

  trigger:
    - event_type: "callback"
      condition: '$callback_data ~ "select_tenant_"'

  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Extract tenant ID from callback_data (format: select_tenant_105)
    # Use placeholder to extract value with regex modifier
    - action: "validate"
      params:
        condition: '{callback_data|regex:select_tenant_(\d+)|exists} == True'
      transition:
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "invalid_tenant_number"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "invalid_tenant_number"
    
    # Check if user is an administrator
    - action: "validate"
      params:
        condition: "{_cache.user.admin} == True"
      transition:
        - action_result: "success"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_select_save"
        - action_result: "failed"
          transition_action: "continue"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # For regular users check access to selected tenant
    # Use placeholder to extract value with regex modifier
    - action: "validate"
      params:
        condition: '{callback_data|regex:select_tenant_(\d+)} in {_cache.user.tenant_owner}'
      transition:
        - action_result: "success"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_select_save"
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_access_denied"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"

# Save selected tenant to User Storage
tenant_select_save:
  description: "Save selected tenant to User Storage and navigate to menu"

  step:
    # Save active tenant to User Storage
    - action: "set_user_storage"
      params:
        key: "active_tenant_id"
        value: '{callback_data|regex:select_tenant_(\d+)}'
    
    # Navigate to tenant menu
    - action: "execute_scenario"
      params:
        scenario: "tenant"

# Tenant access denied
tenant_access_denied:
  description: "Notification about access denial to selected tenant"

  step:
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</b>
          
          –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–µ–Ω–∞–Ω—Ç—É.
          
          –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞.
        inline:
          - [{"üîô –ö —Å–ø–∏—Å–∫—É —Ç–µ–Ω–∞–Ω—Ç–æ–≤": "tenant_not_selected"}]

# Invalid tenant selection handling
invalid_tenant_number:
  description: "Notification about invalid tenant selection"
  
  step:
    - action: "send_message"
      params:
        text: |
          ‚ö†Ô∏è <b>–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ–Ω–∞–Ω—Ç–∞</b>
          
          –í—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
          
          –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å —Ç–µ–Ω–∞–Ω—Ç —Å–Ω–æ–≤–∞.
        inline:
          - [{"üîô –ö —Å–ø–∏—Å–∫—É —Ç–µ–Ω–∞–Ω—Ç–æ–≤": "tenant_not_selected"}]

# ============================================
# BLOCK 4: Synchronization and Update
# ============================================

# Full tenant synchronization
sync_tenant_data:
  description: "Full tenant synchronization (bot + scenarios + storage)"

  trigger:
    - event_type: "callback"
      callback_data: "sync_tenant_data"

  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get active tenant from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # Send notification
    - action: "send_message"
      params:
        text: |
          ‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–∞...
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id|fallback:–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π}</code>
    
    # Full tenant synchronization (pull from GitHub + sync all data)
    - action: "sync_tenant"
      params:
        tenant_id: "{_cache.active_tenant_id}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"

    # Successful completion
    - action: "send_message"
      params:
        text: |
          ‚úÖ –î–∞–Ω–Ω—ã–µ —Ç–µ–Ω–∞–Ω—Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
      transition:
        - action_result: "any"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_menu"

# ============================================
# BLOCK 5: Bot Token Setup
# ============================================

# Bot token request
set_bot_token_input:
  description: "Request bot token for setup"

  trigger:
    - event_type: "callback"
      callback_data: "set_bot_token_input"

  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get active tenant from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # Send message with instruction
    - action: "send_message"
      params:
        text: |
          üîë <b>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞</b>
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
          
          –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏.
          
          –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –≤–≤–µ–¥–∏—Ç–µ <code>null</code> –∏–ª–∏ <code>none</code> (–≤ –ª—é–±–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ).
          
          ‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ:</b> –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Ç–æ–∫–µ–Ω–∞.
        inline:
          - [{"‚ùå –û—Ç–º–µ–Ω–∞": "tenant"}]
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "set_bot_token"
        expires_in_seconds: 300

# Token input handling
set_bot_token_handler:
  description: "Bot token input handling"

  trigger:
    - event_type: "message"
      user_state: "set_bot_token"

  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Check that input is not a command
    - action: "execute_scenario"
      params:
        scenario: "check_message"
    
    # Get active tenant from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # Clear state
    - action: "clear_user_state"
    
    # Check if input is null/none (for token deletion)
    - action: "validate"
      params:
        condition: '{event_text|lower} == "null" or {event_text|lower} == "none"'
      transition:
        - action_result: "success"
          transition_action: "jump_to_scenario"
          transition_value: "set_bot_token_delete"
        - action_result: "failed"
          transition_action: "continue"
        - action_result: "error"
          transition_action: "continue"
    
    # Token format validation (number:string)
    - action: "validate"
      params:
        condition: '$event_text regex "^\\d+:[A-Za-z0-9_-]+$"'
      transition:
        - action_result: "success"
          transition_action: "continue"
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "set_bot_token_invalid_format"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "set_bot_token_invalid_format"
    
    # Send notification about installation start
    - action: "send_message"
      params:
        text: |
          ‚è≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞...
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
    
    # Set bot token
    - action: "set_bot_token"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        bot_token: "{event_text}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "set_bot_token_error"

    # Successful completion
    - action: "send_message"
      params:
        text: |
          ‚úÖ –¢–æ–∫–µ–Ω –±–æ—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
          
          –¢–æ–∫–µ–Ω –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—É–ª–∏–Ω–≥–∞.
        message_edit: "{_cache.last_message_id}"
      transition:
        - action_result: "any"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_menu"

# Invalid token format error handling
set_bot_token_invalid_format:
  description: "Invalid token format error handling"

  step:
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞</b>
          
          –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —Ñ–æ—Ä–º–∞—Ç: <code>—á–∏—Å–ª–æ:—Å—Ç—Ä–æ–∫–∞</code>
          
          –ü—Ä–∏–º–µ—Ä: <code>123456789:ABCdefGHIjklMNOpqrsTUVwxyz</code>
          
          –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.
        inline:
          - [{"üîô –ö –º–µ–Ω—é —Ç–µ–Ω–∞–Ω—Ç–∞": "tenant"}]

# Token deletion (via null/none input)
set_bot_token_delete:
  description: "Bot token deletion via null/none input"

  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get active tenant from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # Send notification about deletion start
    - action: "send_message"
      params:
        text: |
          ‚è≥ –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞...
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
    
    # Delete bot token (pass null)
    - action: "set_bot_token"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        bot_token: null
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "set_bot_token_error"

    # Successful completion
    - action: "send_message"
      params:
        text: |
          ‚úÖ –¢–æ–∫–µ–Ω –±–æ—Ç–∞ —É–¥–∞–ª–µ–Ω
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
          
          –¢–æ–∫–µ–Ω –±—ã–ª —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞. –ü—É–ª–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
        message_edit: "{_cache.last_message_id}"
      transition:
        - action_result: "any"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_menu"

# Token setup error handling
set_bot_token_error:
  description: "Bot token setup error handling"

  step:
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ–∫–µ–Ω–∞</b>
          
          –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
          ‚Ä¢ –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
          ‚Ä¢ –¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º

          ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <code>{user_id}</code>
          –õ–æ–≥ –æ—à–∏–±–∫–∏: <code>{last_error.message|fallback:–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞}</code>
        inline:
          - [{"üîô –ö –º–µ–Ω—é —Ç–µ–Ω–∞–Ω—Ç–∞": "tenant"}]

