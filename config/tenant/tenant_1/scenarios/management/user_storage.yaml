# ============================================
# User Storage
# Purpose: user User Storage management
# ============================================

# ============================================
# BLOCK 1: Main Menu
# ============================================

# User Storage main menu
user_storage_menu:
  description: "User Storage management main menu"
  
  trigger:
    - event_type: "callback"
      callback_data: "user_storage_menu"
  
  step:
    # Default check (loads language)
    - action: "execute_scenario"
      params:
        scenario: "default_check"
    
    # Get active tenant from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "send_message"
      params:
        text: |
          {_cache.translation.user_storage_menu|fallback:{_cache.translation.default|fallback:Unknown error}}
        inline: "{_cache.translation.user_storage_menu_inline|fallback:{_cache.translation.default_inline|fallback:}}"
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "user_storage_input"
        expires_in_seconds: 300

# ============================================
# BLOCK 2: Input Handling
# ============================================

# user_id/key/value input handling
user_storage_input_handler:
  description: "user_id, key and value input handling"
  
  trigger:
    - event_type: "message"
      user_state: "user_storage_input"
  
  step:
    # Default check (loads language)
    - action: "execute_scenario"
      params:
        scenario: "default_check"
    
    # Check that input is not a command
    - action: "execute_scenario"
      params:
        scenario: "check_message"
    
    # Clear state
    - action: "clear_user_state"
    
    # Save entered data to User Storage for passing between scenarios
    - action: "set_user_storage"
      params:
        key: "temp_user_id"
        value: "{event_text|regex:^([^\\s]+)}"
    
    # Determine number of words in input
    - action: "validate"
      params:
        condition: '$event_text regex "^[^\\s]+$"'
      transition:
        # One word - only user_id
        - action_result: "success"
          transition_action: "jump_to_scenario"
          transition_value: "user_storage_view_user"
        # Two or more words
        - action_result: "failed"
          transition_action: "continue"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Save key (second word)
    - action: "set_user_storage"
      params:
        key: "temp_key"
        value: "{event_text|regex:\\s+([^\\s]+)|lower}"
    
    # Check if there is a third word (value)
    - action: "validate"
      params:
        condition: '$event_text regex "^[^\\s]+\\s+[^\\s]+\\s+"'
      transition:
        # Three or more words - user_id + key + value
        - action_result: "success"
          transition_action: "continue"
        # Two words - user_id + key
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "user_storage_view_key"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Save value (everything after second space) to User Storage
    - action: "set_user_storage"
      params:
        key: "temp_value"
        value: "{event_text|regex:\\s+[^\\s]+\\s+(.+)$}"
    
    # Navigate to value change
    - action: "execute_scenario"
      params:
        scenario: "user_storage_edit_value"

# ============================================
# BLOCK 3: User Storage View
# ============================================

# User storage view
user_storage_view_user:
  description: "View entire user storage in YAML format"
  
  step:
    # Get active tenant and user_id from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_user_id"
        _response_key: "temp_user_id"
    
    # Get entire user storage with formatting
    - action: "get_user_storage"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        user_id: "{_cache.temp_user_id|regex:^\\d+$}"
        format: true
        _namespace: "view_user"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "jump_to_scenario"
          transition_value: "user_storage_user_not_found"
    
    # Send user storage in YAML format
    - action: "send_message"
      params:
        text: |
          {_cache.translation.user_storage_view_user|fallback:{_cache.translation.default|fallback:Unknown error}}
        inline: "{_cache.translation.user_storage_view_user_inline|fallback:{_cache.translation.default_inline|fallback:}}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "user_storage_input"
        expires_in_seconds: 300

# User not found notification
user_storage_user_not_found:
  description: "User storage not found notification"
  
  step:
    - action: "send_message"
      params:
        text: |
          {_cache.translation.user_storage_user_not_found|fallback:{_cache.translation.default|fallback:Unknown error}}
        inline: "{_cache.translation.user_storage_user_not_found_inline|fallback:{_cache.translation.default_inline|fallback:}}"
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "user_storage_input"
        expires_in_seconds: 300

# ============================================
# BLOCK 4: Key Value View
# ============================================

# Key value view
user_storage_view_key:
  description: "Key value view"
  
  step:
    # Get active tenant, user_id and key from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_user_id"
        _response_key: "temp_user_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_key"
        _response_key: "temp_key"
    
    # Get key value with formatting
    - action: "get_user_storage"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        user_id: "{_cache.temp_user_id|regex:^\\d+$}"
        key: "{_cache.temp_key}"
        format: true
        _namespace: "view_key"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "jump_to_scenario"
          transition_value: "user_storage_key_not_found"
    
    # Send key value
    - action: "send_message"
      params:
        text: |
          {_cache.translation.user_storage_view_key|fallback:{_cache.translation.default|fallback:Unknown error}}
        inline: "{_cache.translation.user_storage_view_key_inline|fallback:{_cache.translation.default_inline|fallback:}}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "user_storage_input"
        expires_in_seconds: 300

# Key not found notification
user_storage_key_not_found:
  description: "Key not found notification"
  
  step:
    # Get user_id and key from User Storage
    - action: "get_user_storage"
      params:
        key: "temp_user_id"
        _response_key: "temp_user_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_key"
        _response_key: "temp_key"
      
    - action: "send_message"
      params:
        text: |
          {_cache.translation.user_storage_key_not_found|fallback:{_cache.translation.default|fallback:Unknown error}}
        inline: "{_cache.translation.user_storage_key_not_found_inline|fallback:{_cache.translation.default_inline|fallback:}}"
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "user_storage_input"
        expires_in_seconds: 300

# ============================================
# BLOCK 5: Value Change/Add
# ============================================

# Value change/add
user_storage_edit_value:
  description: "Value change/add (user_id + key + value entered)"
  
  step:
    # Get active tenant, user_id, key and value from User Storage
    - action: "get_user_storage"
    
    # Get current value for display (if exists)
    - action: "get_user_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        user_id: "{_cache.user_storage_values.temp_user_id|regex:^\\d+$}"
        key: "{_cache.user_storage_values.temp_key}"
        format: true
        _namespace: "current_value"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "jump_to_scenario"
          transition_value: "user_storage_edit_new_value"
    
    # Show confirmation with current and new value
    - action: "send_message"
      params:
        text: |
          {_cache.translation.user_storage_edit_value|fallback:{_cache.translation.default|fallback:Unknown error}}
        inline: "{_cache.translation.user_storage_edit_value_inline|fallback:{_cache.translation.default_inline|fallback:}}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "user_storage_input"
        expires_in_seconds: 300

# New value addition confirmation (for case when value not found)
user_storage_edit_new_value:
  description: "New value addition confirmation for non-existent key"
  
  step:
    # Get entire User Storage (need multiple values)
    - action: "get_user_storage"
    
    - action: "send_message"
      params:
        text: |
          {_cache.translation.user_storage_edit_new_value|fallback:{_cache.translation.default|fallback:Unknown error}}
        inline: "{_cache.translation.user_storage_edit_new_value_inline|fallback:{_cache.translation.default_inline|fallback:}}"
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "user_storage_input"
        expires_in_seconds: 300

# Value save execution
user_storage_edit_execute:
  description: "Value save execution"
  
  trigger:
    - event_type: "callback"
      callback_data: "user_storage_edit_execute"
  
  step:
    # Default check (loads language)
    - action: "execute_scenario"
      params:
        scenario: "default_check"
    
    # Get entire User Storage (need multiple values)
    - action: "get_user_storage"
    
    # Save value (returns saved data in response_data)
    - action: "set_user_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        user_id: "{_cache.user_storage_values.temp_user_id|regex:^\\d+$}"
        key: "{_cache.user_storage_values.temp_key}"
        value: "{_cache.user_storage_values.temp_value}"
        format: true
        _namespace: "edit_saved"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          {_cache.translation.user_storage_edit_execute|fallback:{_cache.translation.default|fallback:Unknown error}}
        inline: "{_cache.translation.user_storage_edit_execute_inline|fallback:{_cache.translation.default_inline|fallback:}}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Clear temporary data from User Storage
    - action: "delete_user_storage"
      params:
        key: "temp_user_id"
    
    - action: "delete_user_storage"
      params:
        key: "temp_key"
    
    - action: "delete_user_storage"
      params:
        key: "temp_value"

# ============================================
# BLOCK 6: Value Deletion
# ============================================

# Value deletion confirmation
user_storage_delete_value_confirm:
  description: "Value deletion confirmation"
  
  trigger:
    - event_type: "callback"
      callback_data: "user_storage_delete_value_confirm"
  
  step:
    # Default check (loads language)
    - action: "execute_scenario"
      params:
        scenario: "default_check"
    
    # Get entire User Storage (need multiple values)
    - action: "get_user_storage"
    
    # Get current value for display
    - action: "get_user_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        user_id: "{_cache.user_storage_values.temp_user_id|regex:^\\d+$}"
        key: "{_cache.user_storage_values.temp_key}"
        format: true
        _namespace: "delete_value"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "jump_to_scenario"
          transition_value: "user_storage_delete_value_not_found"
    
    # Show deletion confirmation
    - action: "send_message"
      params:
        text: |
          {_cache.translation.user_storage_delete_value_confirm|fallback:{_cache.translation.default|fallback:Unknown error}}
        inline: "{_cache.translation.user_storage_delete_value_confirm_inline|fallback:{_cache.translation.default_inline|fallback:}}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"

# Value not found notification
user_storage_delete_value_not_found:
  description: "Value not found notification"
  
  step:
    # Get user_id and key from User Storage
    - action: "get_user_storage"
      params:
        key: "temp_user_id"
        _response_key: "temp_user_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_key"
        _response_key: "temp_key"
    
    - action: "send_message"
      params:
        text: |
          {_cache.translation.user_storage_delete_value_not_found|fallback:{_cache.translation.default|fallback:Unknown error}}
        inline: "{_cache.translation.user_storage_delete_value_not_found_inline|fallback:{_cache.translation.default_inline|fallback:}}"
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "user_storage_input"
        expires_in_seconds: 300

# Value deletion execution
user_storage_delete_value_execute:
  description: "Value deletion execution"
  
  trigger:
    - event_type: "callback"
      callback_data: "user_storage_delete_value_execute"
  
  step:
    # Default check (loads language)
    - action: "execute_scenario"
      params:
        scenario: "default_check"
    
    # Get entire User Storage (need multiple values)
    - action: "get_user_storage"
    
    # Get value before deletion for display
    - action: "get_user_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        user_id: "{_cache.user_storage_values.temp_user_id|regex:^\\d+$}"
        key: "{_cache.user_storage_values.temp_key}"
        _namespace: "deleted_value"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "continue"
    
    # Delete value
    - action: "delete_user_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        user_id: "{_cache.user_storage_values.temp_user_id|regex:^\\d+$}"
        key: "{_cache.user_storage_values.temp_key}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          {_cache.translation.user_storage_delete_value_execute|fallback:{_cache.translation.default|fallback:Unknown error}}
        inline: "{_cache.translation.user_storage_delete_value_execute_inline|fallback:{_cache.translation.default_inline|fallback:}}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Clear temporary data from User Storage
    - action: "delete_user_storage"
      params:
        key: "temp_user_id"
    
    - action: "delete_user_storage"
      params:
        key: "temp_key"

# ============================================
# BLOCK 7: User Storage Deletion
# ============================================

# User storage deletion confirmation
user_storage_delete_user_confirm:
  description: "Entire user storage deletion confirmation"
  
  trigger:
    - event_type: "callback"
      callback_data: "user_storage_delete_user_confirm"
  
  step:
    # Default check (loads language)
    - action: "execute_scenario"
      params:
        scenario: "default_check"
    
    # Get active tenant and user_id from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_user_id"
        _response_key: "temp_user_id"
    
    # Get user storage for information display
    - action: "get_user_storage"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        user_id: "{_cache.temp_user_id|regex:^\\d+$}"
        format: true
        _namespace: "delete_user"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          {_cache.translation.user_storage_delete_user_confirm|fallback:{_cache.translation.default|fallback:Unknown error}}
        inline: "{_cache.translation.user_storage_delete_user_confirm_inline|fallback:{_cache.translation.default_inline|fallback:}}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"

# User storage deletion execution
user_storage_delete_user_execute:
  description: "Entire user storage deletion execution"
  
  trigger:
    - event_type: "callback"
      callback_data: "user_storage_delete_user_execute"
  
  step:
    # Default check (loads language)
    - action: "execute_scenario"
      params:
        scenario: "default_check"
    
    # Get active tenant and user_id from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_user_id"
        _response_key: "temp_user_id"
    
    # Delete entire user storage (without key all records are deleted)
    - action: "delete_user_storage"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        user_id: "{_cache.temp_user_id|regex:^\\d+$}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          {_cache.translation.user_storage_delete_user_execute|fallback:{_cache.translation.default|fallback:Unknown error}}
        inline: "{_cache.translation.user_storage_delete_user_execute_inline|fallback:{_cache.translation.default_inline|fallback:}}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Clear temporary data from User Storage
    - action: "delete_user_storage"
      params:
        key: "temp_user_id"
