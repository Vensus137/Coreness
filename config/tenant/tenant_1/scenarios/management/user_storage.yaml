# ============================================
# User Storage
# Purpose: user User Storage management
# ============================================

# ============================================
# BLOCK 1: Main Menu
# ============================================

# User Storage main menu
user_storage_menu:
  description: "User Storage management main menu"
  
  trigger:
    - event_type: "callback"
      callback_data: "user_storage_menu"
  
  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get active tenant from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "send_message"
      params:
        text: |
          üë§ <b>User Storage <code>{_cache.active_tenant_id}</code></b>
          
          –í–≤–µ–¥–∏—Ç–µ: <b>user_id</b> <b>–∫–ª—é—á</b> <b>–∑–Ω–∞—á–µ–Ω–∏–µ</b>
          
          ‚Ä¢ <b>–û–¥–Ω–æ —Å–ª–æ–≤–æ</b> (user_id) ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ–≥–æ storage –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          ‚Ä¢ <b>–î–≤–∞ —Å–ª–æ–≤–∞</b> (user_id –∫–ª—é—á) ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–∞
          ‚Ä¢ <b>–¢—Ä–∏ —Å–ª–æ–≤–∞</b> (user_id –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ) ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ/–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
          
          –ü—Ä–∏–º–µ—Ä: <code>123456789 temp_data some_value</code>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "tenant"}]
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "user_storage_input"
        expires_in_seconds: 300

# ============================================
# BLOCK 2: Input Handling
# ============================================

# user_id/key/value input handling
user_storage_input_handler:
  description: "user_id, key and value input handling"
  
  trigger:
    - event_type: "message"
      user_state: "user_storage_input"
  
  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Check that input is not a command
    - action: "execute_scenario"
      params:
        scenario: "check_message"
    
    # Clear state
    - action: "clear_user_state"
    
    # Save entered data to User Storage for passing between scenarios
    - action: "set_user_storage"
      params:
        key: "temp_user_id"
        value: "{event_text|regex:^([^\\s]+)}"
    
    # Determine number of words in input
    - action: "validate"
      params:
        condition: '$event_text regex "^[^\\s]+$"'
      transition:
        # One word - only user_id
        - action_result: "success"
          transition_action: "jump_to_scenario"
          transition_value: "user_storage_view_user"
        # Two or more words
        - action_result: "failed"
          transition_action: "continue"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Save key (second word)
    - action: "set_user_storage"
      params:
        key: "temp_key"
        value: "{event_text|regex:\\s+([^\\s]+)|lower}"
    
    # Check if there is a third word (value)
    - action: "validate"
      params:
        condition: '$event_text regex "^[^\\s]+\\s+[^\\s]+\\s+"'
      transition:
        # Three or more words - user_id + key + value
        - action_result: "success"
          transition_action: "continue"
        # Two words - user_id + key
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "user_storage_view_key"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Save value (everything after second space) to User Storage
    - action: "set_user_storage"
      params:
        key: "temp_value"
        value: "{event_text|regex:\\s+[^\\s]+\\s+(.+)$}"
    
    # Navigate to value change
    - action: "execute_scenario"
      params:
        scenario: "user_storage_edit_value"

# ============================================
# BLOCK 3: User Storage View
# ============================================

# User storage view
user_storage_view_user:
  description: "View entire user storage in YAML format"
  
  step:
    # Get active tenant and user_id from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_user_id"
        _response_key: "temp_user_id"
    
    # Get entire user storage with formatting
    - action: "get_user_storage"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        user_id: "{_cache.temp_user_id|regex:^\\d+$}"
        format: true
        _namespace: "view_user"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "jump_to_scenario"
          transition_value: "user_storage_user_not_found"
    
    # Send user storage in YAML format
    - action: "send_message"
      params:
        text: |
          üìÑ <b>User Storage <code>{_cache.active_tenant_id}</code></b>
          
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <code>{_cache.temp_user_id}</code>
          
          <b>Storage –≤ YAML —Ñ–æ—Ä–º–∞—Ç–µ:</b>
          <pre>{_cache.view_user.formatted_text|fallback:‚ÑπÔ∏è Storage –ø—É—Å—Ç}</pre>

          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>user_id –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"üóëÔ∏è –£–¥–∞–ª–∏—Ç—å storage": "user_storage_delete_user_confirm"}, {"üîô –ù–∞–∑–∞–¥": "user_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "user_storage_input"
        expires_in_seconds: 300

# User not found notification
user_storage_user_not_found:
  description: "User storage not found notification"
  
  step:
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>Storage –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω</b>
          
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å <code>{_cache.temp_user_id}</code> –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ storage –ø—É—Å—Ç.
          
          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>user_id –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "user_storage_menu"}]
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "user_storage_input"
        expires_in_seconds: 300

# ============================================
# BLOCK 4: Key Value View
# ============================================

# Key value view
user_storage_view_key:
  description: "Key value view"
  
  step:
    # Get active tenant, user_id and key from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_user_id"
        _response_key: "temp_user_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_key"
        _response_key: "temp_key"
    
    # Get key value with formatting
    - action: "get_user_storage"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        user_id: "{_cache.temp_user_id|regex:^\\d+$}"
        key: "{_cache.temp_key}"
        format: true
        _namespace: "view_key"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "jump_to_scenario"
          transition_value: "user_storage_key_not_found"
    
    # Send key value
    - action: "send_message"
      params:
        text: |
          üìã <b>User Storage <code>{_cache.active_tenant_id}</code></b>
          
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <code>{_cache.temp_user_id}</code>
          –ö–ª—é—á: <code>{_cache.temp_key}</code>
          
          <b>–ó–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.view_key.formatted_text|fallback:–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ}</pre>

          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>user_id –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ": "user_storage_delete_value_confirm"}, {"üîô –ù–∞–∑–∞–¥": "user_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "user_storage_input"
        expires_in_seconds: 300

# Key not found notification
user_storage_key_not_found:
  description: "Key not found notification"
  
  step:
    # Get user_id and key from User Storage
    - action: "get_user_storage"
      params:
        key: "temp_user_id"
        _response_key: "temp_user_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_key"
        _response_key: "temp_key"
      
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–ö–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω</b>
          
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <code>{_cache.temp_user_id}</code>
          –ö–ª—é—á: <code>{_cache.temp_key}</code>
          
          –ö–ª—é—á –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ storage –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
          
          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>user_id –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "user_storage_menu"}]
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "user_storage_input"
        expires_in_seconds: 300

# ============================================
# BLOCK 5: Value Change/Add
# ============================================

# Value change/add
user_storage_edit_value:
  description: "Value change/add (user_id + key + value entered)"
  
  step:
    # Get active tenant, user_id, key and value from User Storage
    - action: "get_user_storage"
    
    # Get current value for display (if exists)
    - action: "get_user_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        user_id: "{_cache.user_storage_values.temp_user_id|regex:^\\d+$}"
        key: "{_cache.user_storage_values.temp_key}"
        format: true
        _namespace: "current_value"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "jump_to_scenario"
          transition_value: "user_storage_edit_new_value"
    
    # Show confirmation with current and new value
    - action: "send_message"
      params:
        text: |
          ‚ö†Ô∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</b>
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.user_storage_values.active_tenant_id}</code>
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <code>{_cache.user_storage_values.temp_user_id}</code>
          –ö–ª—é—á: <code>{_cache.user_storage_values.temp_key}</code>
          
          <b>–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.current_value.formatted_text|fallback:–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ}</pre>

          <b>–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.user_storage_values.temp_value}</pre>
          
          –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ?
          
          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>user_id –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"‚úÖ –ò–∑–º–µ–Ω–∏—Ç—å": "user_storage_edit_execute"}, {"üóëÔ∏è –£–¥–∞–ª–∏—Ç—å": "user_storage_delete_value_confirm"}, {"üîô –ù–∞–∑–∞–¥": "user_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "user_storage_input"
        expires_in_seconds: 300

# New value addition confirmation (for case when value not found)
user_storage_edit_new_value:
  description: "New value addition confirmation for non-existent key"
  
  step:
    # Get entire User Storage (need multiple values)
    - action: "get_user_storage"
    
    - action: "send_message"
      params:
        text: |
          ‚ö†Ô∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è</b>
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.user_storage_values.active_tenant_id}</code>
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <code>{_cache.user_storage_values.temp_user_id}</code>
          –ö–ª—é—á: <code>{_cache.user_storage_values.temp_key}</code>
          
          <i>–ö–ª—é—á –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π.</i>
          
          <b>–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.user_storage_values.temp_value}</pre>
          
          –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ?
          
          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>user_id –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"‚úÖ –î–æ–±–∞–≤–∏—Ç—å": "user_storage_edit_execute"}, {"üîô –ù–∞–∑–∞–¥": "user_storage_menu"}]
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "user_storage_input"
        expires_in_seconds: 300

# Value save execution
user_storage_edit_execute:
  description: "Value save execution"
  
  trigger:
    - event_type: "callback"
      callback_data: "user_storage_edit_execute"
  
  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get entire User Storage (need multiple values)
    - action: "get_user_storage"
    
    # Save value (returns saved data in response_data)
    - action: "set_user_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        user_id: "{_cache.user_storage_values.temp_user_id|regex:^\\d+$}"
        key: "{_cache.user_storage_values.temp_key}"
        value: "{_cache.user_storage_values.temp_value}"
        format: true
        _namespace: "edit_saved"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          ‚úÖ <b>–ó–Ω–∞—á–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ</b>
          
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <code>{_cache.user_storage_values.temp_user_id}</code>
          –ö–ª—é—á: <code>{_cache.user_storage_values.temp_key}</code>
          
          <b>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.edit_saved.formatted_text|fallback:–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ}</pre>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "user_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Clear temporary data from User Storage
    - action: "delete_user_storage"
      params:
        key: "temp_user_id"
    
    - action: "delete_user_storage"
      params:
        key: "temp_key"
    
    - action: "delete_user_storage"
      params:
        key: "temp_value"

# ============================================
# BLOCK 6: Value Deletion
# ============================================

# Value deletion confirmation
user_storage_delete_value_confirm:
  description: "Value deletion confirmation"
  
  trigger:
    - event_type: "callback"
      callback_data: "user_storage_delete_value_confirm"
  
  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get entire User Storage (need multiple values)
    - action: "get_user_storage"
    
    # Get current value for display
    - action: "get_user_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        user_id: "{_cache.user_storage_values.temp_user_id|regex:^\\d+$}"
        key: "{_cache.user_storage_values.temp_key}"
        format: true
        _namespace: "delete_value"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "jump_to_scenario"
          transition_value: "user_storage_delete_value_not_found"
    
    # Show deletion confirmation
    - action: "send_message"
      params:
        text: |
          ‚ö†Ô∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è</b>
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.user_storage_values.active_tenant_id}</code>
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <code>{_cache.user_storage_values.temp_user_id}</code>
          –ö–ª—é—á: <code>{_cache.user_storage_values.temp_key}</code>
          
          <b>–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.delete_value.formatted_text|fallback:–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ}</pre>
          
          –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ?
        inline:
          - [{"‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å": "user_storage_delete_value_execute"}, {"‚ùå –û—Ç–º–µ–Ω–∞": "user_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"

# Value not found notification
user_storage_delete_value_not_found:
  description: "Value not found notification"
  
  step:
    # Get user_id and key from User Storage
    - action: "get_user_storage"
      params:
        key: "temp_user_id"
        _response_key: "temp_user_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_key"
        _response_key: "temp_key"
    
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</b>
          
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <code>{_cache.temp_user_id}</code>
          –ö–ª—é—á: <code>{_cache.temp_key}</code>
          
          –ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
          
          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>user_id –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "user_storage_menu"}]
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "user_storage_input"
        expires_in_seconds: 300

# Value deletion execution
user_storage_delete_value_execute:
  description: "Value deletion execution"
  
  trigger:
    - event_type: "callback"
      callback_data: "user_storage_delete_value_execute"
  
  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get entire User Storage (need multiple values)
    - action: "get_user_storage"
    
    # Get value before deletion for display
    - action: "get_user_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        user_id: "{_cache.user_storage_values.temp_user_id|regex:^\\d+$}"
        key: "{_cache.user_storage_values.temp_key}"
        _namespace: "deleted_value"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "continue"
    
    # Delete value
    - action: "delete_user_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        user_id: "{_cache.user_storage_values.temp_user_id|regex:^\\d+$}"
        key: "{_cache.user_storage_values.temp_key}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          ‚úÖ <b>–ó–Ω–∞—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ</b>
          
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <code>{_cache.user_storage_values.temp_user_id}</code>
          –ö–ª—é—á: <code>{_cache.user_storage_values.temp_key}</code>
          –ó–Ω–∞—á–µ–Ω–∏–µ: <code>{_cache.deleted_value.user_storage_values|fallback:–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å}</code>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "user_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Clear temporary data from User Storage
    - action: "delete_user_storage"
      params:
        key: "temp_user_id"
    
    - action: "delete_user_storage"
      params:
        key: "temp_key"

# ============================================
# BLOCK 7: User Storage Deletion
# ============================================

# User storage deletion confirmation
user_storage_delete_user_confirm:
  description: "Entire user storage deletion confirmation"
  
  trigger:
    - event_type: "callback"
      callback_data: "user_storage_delete_user_confirm"
  
  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get active tenant and user_id from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_user_id"
        _response_key: "temp_user_id"
    
    # Get user storage for information display
    - action: "get_user_storage"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        user_id: "{_cache.temp_user_id|regex:^\\d+$}"
        format: true
        _namespace: "delete_user"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          ‚ö†Ô∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è storage –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</b>
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <code>{_cache.temp_user_id}</code>
          
          <b>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ storage:</b>
          <pre>{_cache.delete_user.formatted_text|fallback:Storage –ø—É—Å—Ç}</pre>
          
          ‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ!</b> –ë—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –≤–µ—Å—å storage –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ –≤—Å–µ–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏!
        inline:
          - [{"‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å": "user_storage_delete_user_execute"}, {"‚ùå –û—Ç–º–µ–Ω–∞": "user_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"

# User storage deletion execution
user_storage_delete_user_execute:
  description: "Entire user storage deletion execution"
  
  trigger:
    - event_type: "callback"
      callback_data: "user_storage_delete_user_execute"
  
  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get active tenant and user_id from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_user_id"
        _response_key: "temp_user_id"
    
    # Delete entire user storage (without key all records are deleted)
    - action: "delete_user_storage"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        user_id: "{_cache.temp_user_id|regex:^\\d+$}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          ‚úÖ <b>Storage –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª–µ–Ω</b>
          
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å <code>{_cache.temp_user_id}</code> - –≤–µ—Å—å storage —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "user_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Clear temporary data from User Storage
    - action: "delete_user_storage"
      params:
        key: "temp_user_id"
