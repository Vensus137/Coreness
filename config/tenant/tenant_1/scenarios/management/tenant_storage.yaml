# ============================================
# Tenant Storage
# Purpose: tenant Tenant Storage management
# ============================================

# ============================================
# BLOCK 1: Main Menu
# ============================================

# Tenant Storage main menu
tenant_storage_menu:
  description: "Tenant Storage management main menu"
  
  trigger:
    - event_type: "callback"
      callback_data: "tenant_storage_menu"
  
  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get active tenant from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # Get list of groups
    - action: "get_storage_groups"
      params:
        tenant_id: "{_cache.active_tenant_id}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          üè¢ <b>Tenant Storage <code>{_cache.active_tenant_id}</code></b>
          
          –î–æ—Å—Ç—É–ø–Ω–æ <code>{_cache.is_truncated|true|value:>}{_cache.group_keys|length|fallback:0}</code> –≥—Ä—É–ø–ø(—ã):
          <blockquote expandable>{_cache.group_keys|list|fallback:–ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.}</blockquote>

          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
          
          ‚Ä¢ <b>–û–¥–Ω–æ —Å–ª–æ–≤–æ</b> (–≥—Ä—É–ø–ø–∞) ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –≥—Ä—É–ø–ø—ã
          ‚Ä¢ <b>–î–≤–∞ —Å–ª–æ–≤–∞</b> (–≥—Ä—É–ø–ø–∞ –∫–ª—é—á) ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–∞
          ‚Ä¢ <b>–¢—Ä–∏ —Å–ª–æ–≤–∞</b> (–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ) ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ/–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
          
          –ü—Ä–∏–º–µ—Ä: <code>settings max_users 100</code>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "tenant"}]
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "tenant_storage_input"
        expires_in_seconds: 300

# ============================================
# BLOCK 2: Input Handling
# ============================================

# Group/key/value input handling
tenant_storage_input_handler:
  description: "Group, key and value input handling"
  
  trigger:
    - event_type: "message"
      user_state: "tenant_storage_input"
  
  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Check that input is not a command
    - action: "execute_scenario"
      params:
        scenario: "check_message"
    
    # Clear state
    - action: "clear_user_state"
    
    # Save entered data to User Storage for passing between scenarios
    - action: "set_user_storage"
      params:
        key: "temp_group_key"
        value: "{event_text|regex:^([^\\s]+)|lower}"
    
    # Determine number of words in input
    - action: "validate"
      params:
        condition: '$event_text regex "^[^\\s]+$"'
      transition:
        # One word - only group
        - action_result: "success"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_storage_view_group"
        # Two or more words
        - action_result: "failed"
          transition_action: "continue"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Save key (second word)
    - action: "set_user_storage"
      params:
        key: "temp_key"
        value: "{event_text|regex:\\s+([^\\s]+)|lower}"
    
    # Check if there is a third word (value)
    - action: "validate"
      params:
        condition: '$event_text regex "^[^\\s]+\\s+[^\\s]+\\s+"'
      transition:
        # Three or more words - group + key + value
        - action_result: "success"
          transition_action: "continue"
        # Two words - group + key
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_storage_view_key"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Save value (everything after second space) to User Storage
    - action: "set_user_storage"
      params:
        key: "temp_value"
        value: "{event_text|regex:\\s+[^\\s]+\\s+(.+)$}"
    
    # Navigate to value change
    - action: "execute_scenario"
      params:
        scenario: "tenant_storage_edit_value"

# ============================================
# BLOCK 3: Group View
# ============================================

# Group view
tenant_storage_view_group:
  description: "Group view in YAML format"
  
  step:
    # Get active tenant and group from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_group_key"
        _response_key: "temp_group_key"
    
    # Get group with formatting
    - action: "get_storage"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        group_key: "{_cache.temp_group_key}"
        format: true
        _namespace: "view_group"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_storage_group_not_found"
    
    # Send group in YAML format
    - action: "send_message"
      params:
        text: |
          üìÑ <b>Tenant Storage <code>{_cache.active_tenant_id}</code></b>
          
          –ì—Ä—É–ø–ø–∞: <code>{_cache.temp_group_key}</code>
          
          <b>–ì—Ä—É–ø–ø–∞ –≤ YAML —Ñ–æ—Ä–º–∞—Ç–µ:</b>
          <pre>{_cache.view_group.formatted_text|fallback:‚ÑπÔ∏è –ì—Ä—É–ø–ø–∞ –ø—É—Å—Ç–∞}</pre>

          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É": "tenant_storage_delete_group_confirm"}, {"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "tenant_storage_input"
        expires_in_seconds: 300

# Group not found notification
tenant_storage_group_not_found:
  description: "Group not found notification"
  
  step:
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</b>
          
          –ì—Ä—É–ø–ø–∞ <code>{_cache.temp_group_key}</code> –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
          
          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "tenant_storage_input"
        expires_in_seconds: 300

# ============================================
# BLOCK 4: Key Value View
# ============================================

# Key value view
tenant_storage_view_key:
  description: "Key value view"
  
  step:
    # Get active tenant, group and key from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_group_key"
        _response_key: "temp_group_key"
    
    - action: "get_user_storage"
      params:
        key: "temp_key"
        _response_key: "temp_key"
    
    # Get key value with formatting
    - action: "get_storage"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        group_key: "{_cache.temp_group_key}"
        key: "{_cache.temp_key}"
        format: true
        _namespace: "view_key"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_storage_key_not_found"
    
    # Send key value
    - action: "send_message"
      params:
        text: |
          üìã <b>Tenant Storage <code>{_cache.active_tenant_id}</code></b>
          
          –ì—Ä—É–ø–ø–∞: <code>{_cache.temp_group_key}</code>
          –ö–ª—é—á: <code>{_cache.temp_key}</code>
          
          <b>–ó–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.view_key.formatted_text|fallback:–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ}</pre>

          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ": "tenant_storage_delete_value_confirm"}, {"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "tenant_storage_input"
        expires_in_seconds: 300

# Key not found notification
tenant_storage_key_not_found:
  description: "Key not found notification"
  
  step:
    # Get group and key from User Storage
    - action: "get_user_storage"
      params:
        key: "temp_group_key"
        _response_key: "temp_group_key"
    
    - action: "get_user_storage"
      params:
        key: "temp_key"
        _response_key: "temp_key"
      
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–ö–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω</b>
          
          –ì—Ä—É–ø–ø–∞: <code>{_cache.temp_group_key}</code>
          –ö–ª—é—á: <code>{_cache.temp_key}</code>
          
          –ö–ª—é—á –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ.
          
          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "tenant_storage_input"
        expires_in_seconds: 300

# ============================================
# BLOCK 5: Value Change/Add
# ============================================

# Value change/add
tenant_storage_edit_value:
  description: "Value change/add (group + key + value entered)"
  
  step:
    # Get active tenant, group, key and value from User Storage
    - action: "get_user_storage"
    
    # Get current value for display (if exists)
    - action: "get_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        group_key: "{_cache.user_storage_values.temp_group_key}"
        key: "{_cache.user_storage_values.temp_key}"
        format: true
        _namespace: "current_value"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_storage_edit_new_value"
    
    # Show confirmation with current and new value
    - action: "send_message"
      params:
        text: |
          ‚ö†Ô∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</b>
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.user_storage_values.active_tenant_id}</code>
          –ì—Ä—É–ø–ø–∞: <code>{_cache.user_storage_values.temp_group_key}</code>
          –ö–ª—é—á: <code>{_cache.user_storage_values.temp_key}</code>
          
          <b>–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.current_value.formatted_text|fallback:–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ}</pre>

          <b>–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.user_storage_values.temp_value}</pre>
          
          –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ?
          
          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"‚úÖ –ò–∑–º–µ–Ω–∏—Ç—å": "tenant_storage_edit_execute"}, {"üóëÔ∏è –£–¥–∞–ª–∏—Ç—å": "tenant_storage_delete_value_confirm"}, {"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "tenant_storage_input"
        expires_in_seconds: 300

# New value addition confirmation (for case when value not found)
tenant_storage_edit_new_value:
  description: "New value addition confirmation for non-existent key"
  
  step:
    # Get entire User Storage (need multiple values)
    - action: "get_user_storage"
    
    - action: "send_message"
      params:
        text: |
          ‚ö†Ô∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è</b>
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.user_storage_values.active_tenant_id}</code>
          –ì—Ä—É–ø–ø–∞: <code>{_cache.user_storage_values.temp_group_key}</code>
          –ö–ª—é—á: <code>{_cache.user_storage_values.temp_key}</code>
          
          <i>–ö–ª—é—á –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π.</i>
          
          <b>–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.user_storage_values.temp_value}</pre>

          –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ?
          
          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"‚úÖ –î–æ–±–∞–≤–∏—Ç—å": "tenant_storage_edit_execute"}, {"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "tenant_storage_input"
        expires_in_seconds: 300

# Value save execution
tenant_storage_edit_execute:
  description: "Value save execution"
  
  trigger:
    - event_type: "callback"
      callback_data: "tenant_storage_edit_execute"
  
  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get entire User Storage (need multiple values)
    - action: "get_user_storage"
    
    # Save value (returns saved data in response_data)
    - action: "set_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        group_key: "{_cache.user_storage_values.temp_group_key}"
        key: "{_cache.user_storage_values.temp_key}"
        value: "{_cache.user_storage_values.temp_value}"
        format: true
        _namespace: "edit_saved"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          ‚úÖ <b>–ó–Ω–∞—á–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ</b>
          
          –ì—Ä—É–ø–ø–∞: <code>{_cache.user_storage_values.temp_group_key}</code>
          –ö–ª—é—á: <code>{_cache.user_storage_values.temp_key}</code>
          
          <b>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.edit_saved.formatted_text|fallback:–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ}</pre>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Clear temporary data from User Storage
    - action: "delete_user_storage"
      params:
        key: "temp_group_key"
    
    - action: "delete_user_storage"
      params:
        key: "temp_key"
    
    - action: "delete_user_storage"
      params:
        key: "temp_value"

# ============================================
# BLOCK 6: Value Deletion
# ============================================

# Value deletion confirmation
tenant_storage_delete_value_confirm:
  description: "Value deletion confirmation"
  
  trigger:
    - event_type: "callback"
      callback_data: "tenant_storage_delete_value_confirm"
  
  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get entire User Storage (need multiple values)
    - action: "get_user_storage"
    
    # Get current value for display
    - action: "get_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        group_key: "{_cache.user_storage_values.temp_group_key}"
        key: "{_cache.user_storage_values.temp_key}"
        format: true
        _namespace: "delete_value"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_storage_delete_value_not_found"
    
    # Show deletion confirmation
    - action: "send_message"
      params:
        text: |
          ‚ö†Ô∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è</b>
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.user_storage_values.active_tenant_id}</code>
          –ì—Ä—É–ø–ø–∞: <code>{_cache.user_storage_values.temp_group_key}</code>
          –ö–ª—é—á: <code>{_cache.user_storage_values.temp_key}</code>
          
          <b>–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.delete_value.formatted_text|fallback:–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ}</pre>

          –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ?
        inline:
          - [{"‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å": "tenant_storage_delete_value_execute"}, {"‚ùå –û—Ç–º–µ–Ω–∞": "tenant_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"

# Value not found notification
tenant_storage_delete_value_not_found:
  description: "Value not found notification"
  
  step:
    # Get group and key from User Storage
    - action: "get_user_storage"
      params:
        key: "temp_group_key"
        _response_key: "temp_group_key"
    
    - action: "get_user_storage"
      params:
        key: "temp_key"
        _response_key: "temp_key"
    
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</b>
          
          –ì—Ä—É–ø–ø–∞: <code>{_cache.temp_group_key}</code>
          –ö–ª—é—á: <code>{_cache.temp_key}</code>
          
          –ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
          
          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
    
    # Set input waiting state
    - action: "set_user_state"
      params:
        state: "tenant_storage_input"
        expires_in_seconds: 300

# Value deletion execution
tenant_storage_delete_value_execute:
  description: "Value deletion execution"
  
  trigger:
    - event_type: "callback"
      callback_data: "tenant_storage_delete_value_execute"
  
  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get entire User Storage (need multiple values)
    - action: "get_user_storage"
    
    # Get value before deletion for display
    - action: "get_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        group_key: "{_cache.user_storage_values.temp_group_key}"
        key: "{_cache.user_storage_values.temp_key}"
        _namespace: "deleted_value"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "continue"
    
    # Delete value
    - action: "delete_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        group_key: "{_cache.user_storage_values.temp_group_key}"
        key: "{_cache.user_storage_values.temp_key}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          ‚úÖ <b>–ó–Ω–∞—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ</b>
          
          –ì—Ä—É–ø–ø–∞: <code>{_cache.user_storage_values.temp_group_key}</code>
          –ö–ª—é—á: <code>{_cache.user_storage_values.temp_key}</code>
          –ó–Ω–∞—á–µ–Ω–∏–µ: <code>{_cache.deleted_value.storage_values|fallback:–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å}</code>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Clear temporary data from User Storage
    - action: "delete_user_storage"
      params:
        key: "temp_group_key"
    
    - action: "delete_user_storage"
      params:
        key: "temp_key"

# ============================================
# BLOCK 7: Group Deletion
# ============================================

# Group deletion confirmation
tenant_storage_delete_group_confirm:
  description: "Group deletion confirmation"
  
  trigger:
    - event_type: "callback"
      callback_data: "tenant_storage_delete_group_confirm"
  
  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get active tenant and group from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_group_key"
        _response_key: "temp_group_key"
    
    # Get group for information display
    - action: "get_storage"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        group_key: "{_cache.temp_group_key}"
        format: true
        _namespace: "delete_group"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          ‚ö†Ô∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã</b>
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
          –ì—Ä—É–ø–ø–∞: <code>{_cache.temp_group_key}</code>
          
          <b>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≥—Ä—É–ø–ø—ã:</b>
          <pre>{_cache.delete_group.formatted_text|fallback:–ì—Ä—É–ø–ø–∞ –ø—É—Å—Ç–∞}</pre>
          
          ‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ!</b> –ë—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ –≤—Å—è –≥—Ä—É–ø–ø–∞ —Å–æ –≤—Å–µ–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏!
        inline:
          - [{"‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å": "tenant_storage_delete_group_execute"}, {"‚ùå –û—Ç–º–µ–Ω–∞": "tenant_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"

# Group deletion execution
tenant_storage_delete_group_execute:
  description: "Group deletion execution"
  
  trigger:
    - event_type: "callback"
      callback_data: "tenant_storage_delete_group_execute"
  
  step:
    # Access check
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Get active tenant and group from User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_group_key"
        _response_key: "temp_group_key"
    
    # Delete group
    - action: "delete_storage"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        group_key: "{_cache.temp_group_key}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          ‚úÖ <b>–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞</b>
          
          –ì—Ä—É–ø–ø–∞ <code>{_cache.temp_group_key}</code> —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # Clear temporary data from User Storage
    - action: "delete_user_storage"
      params:
        key: "temp_group_key"

