# ============================================
# Управление доступом
# Назначение: проверка прав доступа пользователей к различным функциям системы
# ============================================

# ============================================
# БЛОК 1: Основная проверка доступа
# ============================================

# Сценарий проверки доступа (вызывается программно)
access_check:
  description: "Проверка доступа пользователя к Master боту"
  
  step:
    # Получаем настройки пользователя из storage тенанта_1 (Master тенант)
    - action: "get_storage"
      params:
        group_key: "users"
        key: "{user_id}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario" # Ошибка валидации или пользователь не найден
          transition_value: "default_error"
    
    # Проверяем, что у пользователя есть доступ (поле access = true)
    - action: "validate"
      params:
        condition: "{_cache.storage_values.access} == True"
      transition:
        - action_result: "success"
          transition_action: "continue"        # Доступ разрешен - продолжаем выполнение
        - action_result: "failed"
          transition_action: "jump_to_scenario" # Доступ запрещен
          transition_value: "access_denied"
        - action_result: "error"
          transition_action: "jump_to_scenario" # Ошибка валидации или пользователь не найден
          transition_value: "default_error"

# Сценарий отказа в доступе
access_denied:
  description: "Уведомление об отказе в доступе"
  
  step:
    - action: "send_message"
      params:
        text: |
          ❌ <b>Доступ ограничен</b>
          
          К сожалению, у вас нет прав для использования этой функции.
        message_edit: false
      transition:
        - action_result: "any"
          transition_action: "abort"  # Всегда прерываем выполнение сценария

# ============================================
# БЛОК 2: Административная проверка доступа
# ============================================

# Сценарий проверки доступа администратора
access_check_admin:
  description: "Проверка доступа администратора к административным функциям"
  
  step:
    # Проверяем доступ
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # Проверяем, что пользователь является администратором (поле admin = true)
    - action: "validate"
      params:
        condition: "{_cache.storage_values.admin} == True"
      transition:
        - action_result: "success"
          transition_action: "continue"        # Доступ разрешен - продолжаем выполнение
        - action_result: "failed"
          transition_action: "jump_to_scenario" # Доступ запрещен
          transition_value: "access_denied_admin"
        - action_result: "error"
          transition_action: "jump_to_scenario" # Ошибка валидации или пользователь не найден
          transition_value: "default_error"

# Сценарий отказа в доступе для администратора
access_denied_admin:
  description: "Уведомление об отказе в доступе администратора"
  
  step:
    - action: "send_message"
      params:
        text: |
          ❌ <b>Доступ ограничен</b>
          
          Эта функция доступна только администратору системы.
        message_edit: false
      transition:
        - action_result: "any"
          transition_action: "abort"  # Всегда прерываем выполнение сценария
