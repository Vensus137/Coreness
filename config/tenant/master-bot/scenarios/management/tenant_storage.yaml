# ============================================
# Tenant Storage
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Tenant Storage —Ç–µ–Ω–∞–Ω—Ç–∞
# ============================================

# ============================================
# –ë–õ–û–ö 1: –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
# ============================================

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é Tenant Storage
tenant_storage_menu:
  description: "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Tenant Storage"
  
  trigger:
    - event_type: "callback"
      callback_data: "tenant_storage_menu"
  
  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø
    - action: "get_storage_groups"
      params:
        tenant_id: "{_cache.active_tenant_id}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          üè¢ <b>Tenant Storage <code>{_cache.active_tenant_id}</code></b>
          
          –î–æ—Å—Ç—É–ø–Ω–æ <code>{_cache.is_truncated|true|value:>}{_cache.group_keys|length|fallback:0}</code> –≥—Ä—É–ø–ø(—ã):
          <blockquote expandable>{_cache.group_keys|list|fallback:–ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.}</blockquote>

          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
          
          ‚Ä¢ <b>–û–¥–Ω–æ —Å–ª–æ–≤–æ</b> (–≥—Ä—É–ø–ø–∞) ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –≥—Ä—É–ø–ø—ã
          ‚Ä¢ <b>–î–≤–∞ —Å–ª–æ–≤–∞</b> (–≥—Ä—É–ø–ø–∞ –∫–ª—é—á) ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–∞
          ‚Ä¢ <b>–¢—Ä–∏ —Å–ª–æ–≤–∞</b> (–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ) ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ/–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
          
          –ü—Ä–∏–º–µ—Ä: <code>settings max_users 100</code>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "tenant"}]
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞
    - action: "set_user_state"
      params:
        state: "tenant_storage_input"
        expires_in_seconds: 300

# ============================================
# –ë–õ–û–ö 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞
# ============================================

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –≥—Ä—É–ø–ø—ã/–∫–ª—é—á–∞/–∑–Ω–∞—á–µ–Ω–∏—è
tenant_storage_input_handler:
  description: "–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –≥—Ä—É–ø–ø—ã, –∫–ª—é—á–∞ –∏ –∑–Ω–∞—á–µ–Ω–∏—è"
  
  trigger:
    - event_type: "message"
      user_state: "tenant_storage_input"
  
  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤–≤–æ–¥ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π
    - action: "execute_scenario"
      params:
        scenario: "check_message"
    
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    - action: "clear_user_state"
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ User Storage –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –º–µ–∂–¥—É —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏
    - action: "set_user_storage"
      params:
        key: "temp_group_key"
        value: "{event_text|regex:^([^\\s]+)|lower}"
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤ –≤ –≤–≤–æ–¥–µ
    - action: "validate"
      params:
        condition: '$event_text regex "^[^\\s]+$"'
      transition:
        # –û–¥–Ω–æ —Å–ª–æ–≤–æ - —Ç–æ–ª—å–∫–æ –≥—Ä—É–ø–ø–∞
        - action_result: "success"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_storage_view_group"
        # –î–≤–∞ –∏–ª–∏ –±–æ–ª–µ–µ —Å–ª–æ–≤
        - action_result: "failed"
          transition_action: "continue"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á (–≤—Ç–æ—Ä–æ–µ —Å–ª–æ–≤–æ)
    - action: "set_user_storage"
      params:
        key: "temp_key"
        value: "{event_text|regex:\\s+([^\\s]+)|lower}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç—Ä–µ—Ç—å–µ —Å–ª–æ–≤–æ (–∑–Ω–∞—á–µ–Ω–∏–µ)
    - action: "validate"
      params:
        condition: '$event_text regex "^[^\\s]+\\s+[^\\s]+\\s+"'
      transition:
        # –¢—Ä–∏ –∏–ª–∏ –±–æ–ª–µ–µ —Å–ª–æ–≤ - –≥—Ä—É–ø–ø–∞ + –∫–ª—é—á + –∑–Ω–∞—á–µ–Ω–∏–µ
        - action_result: "success"
          transition_action: "continue"
        # –î–≤–∞ —Å–ª–æ–≤–∞ - –≥—Ä—É–ø–ø–∞ + –∫–ª—é—á
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_storage_view_key"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ (–≤—Å–µ –ø–æ—Å–ª–µ –≤—Ç–æ—Ä–æ–≥–æ –ø—Ä–æ–±–µ–ª–∞) –≤ User Storage
    - action: "set_user_storage"
      params:
        key: "temp_value"
        value: "{event_text|regex:\\s+[^\\s]+\\s+(.+)$}"
    
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é –∑–Ω–∞—á–µ–Ω–∏—è
    - action: "execute_scenario"
      params:
        scenario: "tenant_storage_edit_value"

# ============================================
# –ë–õ–û–ö 3: –ü—Ä–æ—Å–º–æ—Ç—Ä –≥—Ä—É–ø–ø—ã
# ============================================

# –ü—Ä–æ—Å–º–æ—Ç—Ä –≥—Ä—É–ø–ø—ã
tenant_storage_view_group:
  description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –≥—Ä—É–ø–ø—ã –≤ YAML —Ñ–æ—Ä–º–∞—Ç–µ"
  
  step:
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏ –≥—Ä—É–ø–ø—É –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_group_key"
        _response_key: "temp_group_key"
    
    # –ü–æ–ª—É—á–∞–µ–º –≥—Ä—É–ø–ø—É —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    - action: "get_storage"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        group_key: "{_cache.temp_group_key}"
        format: true
        _namespace: "view_group"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_storage_group_not_found"
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥—Ä—É–ø–ø—É –≤ YAML —Ñ–æ—Ä–º–∞—Ç–µ
    - action: "send_message"
      params:
        text: |
          üìÑ <b>Tenant Storage <code>{_cache.active_tenant_id}</code></b>
          
          –ì—Ä—É–ø–ø–∞: <code>{_cache.temp_group_key}</code>
          
          <b>–ì—Ä—É–ø–ø–∞ –≤ YAML —Ñ–æ—Ä–º–∞—Ç–µ:</b>
          <pre>{_cache.view_group.formatted_text|fallback:‚ÑπÔ∏è –ì—Ä—É–ø–ø–∞ –ø—É—Å—Ç–∞}</pre>

          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É": "tenant_storage_delete_group_confirm"}, {"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞
    - action: "set_user_state"
      params:
        state: "tenant_storage_input"
        expires_in_seconds: 300

# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –≥—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
tenant_storage_group_not_found:
  description: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –≥—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
  
  step:
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</b>
          
          –ì—Ä—É–ø–ø–∞ <code>{_cache.temp_group_key}</code> –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
          
          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞
    - action: "set_user_state"
      params:
        state: "tenant_storage_input"
        expires_in_seconds: 300

# ============================================
# –ë–õ–û–ö 4: –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–∞
# ============================================

# –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–∞
tenant_storage_view_key:
  description: "–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–∞"
  
  step:
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç, –≥—Ä—É–ø–ø—É –∏ –∫–ª—é—á –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_group_key"
        _response_key: "temp_group_key"
    
    - action: "get_user_storage"
      params:
        key: "temp_key"
        _response_key: "temp_key"
    
    # –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª—é—á–∞ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    - action: "get_storage"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        group_key: "{_cache.temp_group_key}"
        key: "{_cache.temp_key}"
        format: true
        _namespace: "view_key"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_storage_key_not_found"
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª—é—á–∞
    - action: "send_message"
      params:
        text: |
          üìã <b>Tenant Storage <code>{_cache.active_tenant_id}</code></b>
          
          –ì—Ä—É–ø–ø–∞: <code>{_cache.temp_group_key}</code>
          –ö–ª—é—á: <code>{_cache.temp_key}</code>
          
          <b>–ó–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.view_key.formatted_text|fallback:–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ}</pre>

          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ": "tenant_storage_delete_value_confirm"}, {"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞
    - action: "set_user_state"
      params:
        state: "tenant_storage_input"
        expires_in_seconds: 300

# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω
tenant_storage_key_not_found:
  description: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω"
  
  step:
    # –ü–æ–ª—É—á–∞–µ–º –≥—Ä—É–ø–ø—É –∏ –∫–ª—é—á –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "temp_group_key"
        _response_key: "temp_group_key"
    
    - action: "get_user_storage"
      params:
        key: "temp_key"
        _response_key: "temp_key"
      
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–ö–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω</b>
          
          –ì—Ä—É–ø–ø–∞: <code>{_cache.temp_group_key}</code>
          –ö–ª—é—á: <code>{_cache.temp_key}</code>
          
          –ö–ª—é—á –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ.
          
          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞
    - action: "set_user_state"
      params:
        state: "tenant_storage_input"
        expires_in_seconds: 300

# ============================================
# –ë–õ–û–ö 5: –ò–∑–º–µ–Ω–µ–Ω–∏–µ/–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
# ============================================

# –ò–∑–º–µ–Ω–µ–Ω–∏–µ/–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
tenant_storage_edit_value:
  description: "–ò–∑–º–µ–Ω–µ–Ω–∏–µ/–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (–≥—Ä—É–ø–ø–∞ + –∫–ª—é—á + –∑–Ω–∞—á–µ–Ω–∏–µ –≤–≤–µ–¥–µ–Ω—ã)"
  
  step:
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç, –≥—Ä—É–ø–ø—É, –∫–ª—é—á –∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ User Storage
    - action: "get_user_storage"
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
    - action: "get_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        group_key: "{_cache.user_storage_values.temp_group_key}"
        key: "{_cache.user_storage_values.temp_key}"
        format: true
        _namespace: "current_value"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_storage_edit_new_value"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å —Ç–µ–∫—É—â–∏–º –∏ –Ω–æ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
    - action: "send_message"
      params:
        text: |
          ‚ö†Ô∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</b>
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.user_storage_values.active_tenant_id}</code>
          –ì—Ä—É–ø–ø–∞: <code>{_cache.user_storage_values.temp_group_key}</code>
          –ö–ª—é—á: <code>{_cache.user_storage_values.temp_key}</code>
          
          <b>–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.current_value.formatted_text|fallback:–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ}</pre>

          <b>–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.user_storage_values.temp_value}</pre>
          
          –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ?
          
          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"‚úÖ –ò–∑–º–µ–Ω–∏—Ç—å": "tenant_storage_edit_execute"}, {"üóëÔ∏è –£–¥–∞–ª–∏—Ç—å": "tenant_storage_delete_value_confirm"}, {"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞
    - action: "set_user_state"
      params:
        state: "tenant_storage_input"
        expires_in_seconds: 300

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è (–¥–ª—è —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ)
tenant_storage_edit_new_value:
  description: "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª—é—á–∞"
  
  step:
    # –ü–æ–ª—É—á–∞–µ–º –≤–µ—Å—å User Storage (–Ω—É–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–π)
    - action: "get_user_storage"
    
    - action: "send_message"
      params:
        text: |
          ‚ö†Ô∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è</b>
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.user_storage_values.active_tenant_id}</code>
          –ì—Ä—É–ø–ø–∞: <code>{_cache.user_storage_values.temp_group_key}</code>
          –ö–ª—é—á: <code>{_cache.user_storage_values.temp_key}</code>
          
          <i>–ö–ª—é—á –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π.</i>
          
          <b>–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.user_storage_values.temp_value}</pre>

          –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ?
          
          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"‚úÖ –î–æ–±–∞–≤–∏—Ç—å": "tenant_storage_edit_execute"}, {"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞
    - action: "set_user_state"
      params:
        state: "tenant_storage_input"
        expires_in_seconds: 300

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è
tenant_storage_edit_execute:
  description: "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è"
  
  trigger:
    - event_type: "callback"
      callback_data: "tenant_storage_edit_execute"
  
  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü–æ–ª—É—á–∞–µ–º –≤–µ—Å—å User Storage (–Ω—É–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–π)
    - action: "get_user_storage"
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ response_data)
    - action: "set_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        group_key: "{_cache.user_storage_values.temp_group_key}"
        key: "{_cache.user_storage_values.temp_key}"
        value: "{_cache.user_storage_values.temp_value}"
        format: true
        _namespace: "edit_saved"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          ‚úÖ <b>–ó–Ω–∞—á–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ</b>
          
          –ì—Ä—É–ø–ø–∞: <code>{_cache.user_storage_values.temp_group_key}</code>
          –ö–ª—é—á: <code>{_cache.user_storage_values.temp_key}</code>
          
          <b>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.edit_saved.formatted_text|fallback:–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ}</pre>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ User Storage
    - action: "delete_user_storage"
      params:
        key: "temp_group_key"
    
    - action: "delete_user_storage"
      params:
        key: "temp_key"
    
    - action: "delete_user_storage"
      params:
        key: "temp_value"

# ============================================
# –ë–õ–û–ö 6: –£–¥–∞–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
# ============================================

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è
tenant_storage_delete_value_confirm:
  description: "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è"
  
  trigger:
    - event_type: "callback"
      callback_data: "tenant_storage_delete_value_confirm"
  
  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü–æ–ª—É—á–∞–µ–º –≤–µ—Å—å User Storage (–Ω—É–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–π)
    - action: "get_user_storage"
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    - action: "get_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        group_key: "{_cache.user_storage_values.temp_group_key}"
        key: "{_cache.user_storage_values.temp_key}"
        format: true
        _namespace: "delete_value"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_storage_delete_value_not_found"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
    - action: "send_message"
      params:
        text: |
          ‚ö†Ô∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è</b>
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.user_storage_values.active_tenant_id}</code>
          –ì—Ä—É–ø–ø–∞: <code>{_cache.user_storage_values.temp_group_key}</code>
          –ö–ª—é—á: <code>{_cache.user_storage_values.temp_key}</code>
          
          <b>–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</b>
          <pre>{_cache.delete_value.formatted_text|fallback:–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ}</pre>

          –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ?
        inline:
          - [{"‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å": "tenant_storage_delete_value_execute"}, {"‚ùå –û—Ç–º–µ–Ω–∞": "tenant_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"

# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
tenant_storage_delete_value_not_found:
  description: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
  
  step:
    # –ü–æ–ª—É—á–∞–µ–º –≥—Ä—É–ø–ø—É –∏ –∫–ª—é—á –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "temp_group_key"
        _response_key: "temp_group_key"
    
    - action: "get_user_storage"
      params:
        key: "temp_key"
        _response_key: "temp_key"
    
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</b>
          
          –ì—Ä—É–ø–ø–∞: <code>{_cache.temp_group_key}</code>
          –ö–ª—é—á: <code>{_cache.temp_key}</code>
          
          –ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
          
          üí° –î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º –¥–∞–Ω–Ω—ã–º –≤–≤–µ–¥–∏—Ç–µ: <code>–≥—Ä—É–ø–ø–∞ –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ</code>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞
    - action: "set_user_state"
      params:
        state: "tenant_storage_input"
        expires_in_seconds: 300

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è
tenant_storage_delete_value_execute:
  description: "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è"
  
  trigger:
    - event_type: "callback"
      callback_data: "tenant_storage_delete_value_execute"
  
  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü–æ–ª—É—á–∞–µ–º –≤–µ—Å—å User Storage (–Ω—É–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–π)
    - action: "get_user_storage"
    
    # –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    - action: "get_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        group_key: "{_cache.user_storage_values.temp_group_key}"
        key: "{_cache.user_storage_values.temp_key}"
        _namespace: "deleted_value"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
        - action_result: "not_found"
          transition_action: "continue"
    
    # –£–¥–∞–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
    - action: "delete_storage"
      params:
        tenant_id: "{_cache.user_storage_values.active_tenant_id}"
        group_key: "{_cache.user_storage_values.temp_group_key}"
        key: "{_cache.user_storage_values.temp_key}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          ‚úÖ <b>–ó–Ω–∞—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ</b>
          
          –ì—Ä—É–ø–ø–∞: <code>{_cache.user_storage_values.temp_group_key}</code>
          –ö–ª—é—á: <code>{_cache.user_storage_values.temp_key}</code>
          –ó–Ω–∞—á–µ–Ω–∏–µ: <code>{_cache.deleted_value.storage_values|fallback:–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å}</code>
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ User Storage
    - action: "delete_user_storage"
      params:
        key: "temp_group_key"
    
    - action: "delete_user_storage"
      params:
        key: "temp_key"

# ============================================
# –ë–õ–û–ö 7: –£–¥–∞–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã
# ============================================

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã
tenant_storage_delete_group_confirm:
  description: "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã"
  
  trigger:
    - event_type: "callback"
      callback_data: "tenant_storage_delete_group_confirm"
  
  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏ –≥—Ä—É–ø–ø—É –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_group_key"
        _response_key: "temp_group_key"
    
    # –ü–æ–ª—É—á–∞–µ–º –≥—Ä—É–ø–ø—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    - action: "get_storage"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        group_key: "{_cache.temp_group_key}"
        format: true
        _namespace: "delete_group"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          ‚ö†Ô∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã</b>
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
          –ì—Ä—É–ø–ø–∞: <code>{_cache.temp_group_key}</code>
          
          <b>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≥—Ä—É–ø–ø—ã:</b>
          <pre>{_cache.delete_group.formatted_text|fallback:–ì—Ä—É–ø–ø–∞ –ø—É—Å—Ç–∞}</pre>
          
          ‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ!</b> –ë—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ –≤—Å—è –≥—Ä—É–ø–ø–∞ —Å–æ –≤—Å–µ–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏!
        inline:
          - [{"‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å": "tenant_storage_delete_group_execute"}, {"‚ùå –û—Ç–º–µ–Ω–∞": "tenant_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã
tenant_storage_delete_group_execute:
  description: "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã"
  
  trigger:
    - event_type: "callback"
      callback_data: "tenant_storage_delete_group_execute"
  
  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏ –≥—Ä—É–ø–ø—É –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "get_user_storage"
      params:
        key: "temp_group_key"
        _response_key: "temp_group_key"
    
    # –£–¥–∞–ª—è–µ–º –≥—Ä—É–ø–ø—É
    - action: "delete_storage"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        group_key: "{_cache.temp_group_key}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    - action: "send_message"
      params:
        text: |
          ‚úÖ <b>–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞</b>
          
          –ì—Ä—É–ø–ø–∞ <code>{_cache.temp_group_key}</code> —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "tenant_storage_menu"}]
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ User Storage
    - action: "delete_user_storage"
      params:
        key: "temp_group_key"

