# ============================================
# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π —Ç–µ–Ω–∞–Ω—Ç–∞
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–µ–Ω–∞–Ω—Ç–∞ (ai_token –∏ –¥—Ä.)
# ============================================

# ============================================
# –ë–õ–û–ö 1: –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–µ–Ω–∞–Ω—Ç–∞
# ============================================

# –ú–µ–Ω—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–µ–Ω–∞–Ω—Ç–∞
tenant_config_menu:
  description: "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–Ω—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–µ–Ω–∞–Ω—Ç–∞"

  trigger:
    - event_type: "callback"
      callback_data: "tenant_config_menu"
  
  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    - action: "send_message"
      params:
        text: |
          ‚öôÔ∏è <b>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ–Ω–∞–Ω—Ç–∞ <code>{_cache.active_tenant_id}</code></b>
          
          –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–µ–Ω–∞–Ω—Ç–∞.
        inline:
          - [{"üîë AI —Ç–æ–∫–µ–Ω": "set_ai_token_input"}]
          - [{"üîô –ö –º–µ–Ω—é —Ç–µ–Ω–∞–Ω—Ç–∞": "tenant"}]

# ============================================
# –ë–õ–û–ö 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ AI —Ç–æ–∫–µ–Ω–∞
# ============================================

# –ó–∞–ø—Ä–æ—Å AI —Ç–æ–∫–µ–Ω–∞
set_ai_token_input:
  description: "–ó–∞–ø—Ä–æ—Å AI —Ç–æ–∫–µ–Ω–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏"

  trigger:
    - event_type: "callback"
      callback_data: "set_ai_token_input"

  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
    - action: "send_message"
      params:
        text: |
          üîë <b>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ AI —Ç–æ–∫–µ–Ω–∞</b>
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
          
          –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω AI API –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏.
          
          –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –≤–≤–µ–¥–∏—Ç–µ <code>null</code> –∏–ª–∏ <code>none</code> (–≤ –ª—é–±–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ).
          
          ‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ:</b> –¢–æ–∫–µ–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –≤—Å–µ—Ö AI –∑–∞–ø—Ä–æ—Å–æ–≤ —ç—Ç–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞.
        inline:
          - [{"‚ùå –û—Ç–º–µ–Ω–∞": "tenant_config_menu"}]
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞
    - action: "set_user_state"
      params:
        state: "set_ai_token"
        expires_in_seconds: 300

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ AI —Ç–æ–∫–µ–Ω–∞
set_ai_token_handler:
  description: "–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ AI —Ç–æ–∫–µ–Ω–∞"

  trigger:
    - event_type: "message"
      user_state: "set_ai_token"

  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤–≤–æ–¥ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π
    - action: "execute_scenario"
      params:
        scenario: "check_message"
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    - action: "clear_user_state"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–≤–æ–¥ null/none (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞)
    - action: "validate"
      params:
        condition: '{event_text|lower} == "null" or {event_text|lower} == "none"'
      transition:
        - action_result: "success"
          transition_action: "jump_to_scenario"
          transition_value: "set_ai_token_delete"
        - action_result: "failed"
          transition_action: "continue"
        - action_result: "error"
          transition_action: "continue"
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–æ–∫–µ–Ω–∞ (–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã: –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å—ã, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è)
    - action: "validate"
      params:
        condition: '$event_text regex "^[A-Za-z0-9_-]+$"'
      transition:
        - action_result: "success"
          transition_action: "continue"
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "set_ai_token_invalid_format"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "set_ai_token_invalid_format"
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–∞—á–∞–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    - action: "send_message"
      params:
        text: |
          ‚è≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ AI —Ç–æ–∫–µ–Ω–∞...
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω AI
    - action: "update_tenant_config"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        ai_token: "{event_text}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "set_ai_token_error"
    
    # –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
    - action: "send_message"
      params:
        text: |
          ‚úÖ AI —Ç–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
          
          –¢–æ–∫–µ–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –≤—Å–µ—Ö AI –∑–∞–ø—Ä–æ—Å–æ–≤ —ç—Ç–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞.
        message_edit: "{_cache.last_message_id}"
      transition:
        - action_result: "any"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_config_menu"

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–æ–∫–µ–Ω–∞
set_ai_token_invalid_format:
  description: "–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ AI —Ç–æ–∫–µ–Ω–∞"

  step:
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞</b>
          
          –¢–æ–∫–µ–Ω –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è.
          
          –ü—Ä–∏–º–µ—Ä: <code>ak_example_token_123</code>
          
          –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.
        inline:
          - [{"üîô –ö –º–µ–Ω—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏": "tenant_config_menu"}]

# –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ (—á–µ—Ä–µ–∑ –≤–≤–æ–¥ null/none)
set_ai_token_delete:
  description: "–£–¥–∞–ª–µ–Ω–∏–µ AI —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ –≤–≤–æ–¥ null/none"

  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–∞—á–∞–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
    - action: "send_message"
      params:
        text: |
          ‚è≥ –£–¥–∞–ª–µ–Ω–∏–µ AI —Ç–æ–∫–µ–Ω–∞...
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
    
    # –£–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω AI (–ø–µ—Ä–µ–¥–∞–µ–º null)
    - action: "update_tenant_config"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        ai_token: null
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "set_ai_token_error"
    
    # –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
    - action: "send_message"
      params:
        text: |
          ‚úÖ AI —Ç–æ–∫–µ–Ω —É–¥–∞–ª–µ–Ω
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
          
          –¢–æ–∫–µ–Ω –±—ã–ª —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–µ–Ω–∞–Ω—Ç–∞.
        message_edit: "{_cache.last_message_id}"
      transition:
        - action_result: "any"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_config_menu"

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ–∫–µ–Ω–∞
set_ai_token_error:
  description: "–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ AI —Ç–æ–∫–µ–Ω–∞"

  step:
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ–∫–µ–Ω–∞</b>
          
          –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
          ‚Ä¢ –¢–µ–Ω–∞–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
          ‚Ä¢ –¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º

          ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <code>{user_id}</code>
          –õ–æ–≥ –æ—à–∏–±–∫–∏: <code>{last_error.message|fallback:–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞}</code>
        inline:
          - [{"üîô –ö –º–µ–Ω—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏": "tenant_config_menu"}]

