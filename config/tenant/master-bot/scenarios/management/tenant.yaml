# ============================================
# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–Ω–∞–Ω—Ç–æ–º
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –≤—ã–±–æ—Ä, —Å–º–µ–Ω–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–Ω–∞–Ω—Ç–∞–º–∏ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –≤–ª–∞–¥–µ–ª—å—Ü–∞–º
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç User Storage –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞
# ============================================

# ============================================
# –ë–õ–û–ö 1: –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Ç–µ–Ω–∞–Ω—Ç–∞
# ============================================

tenant:
  description: "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–Ω–∞–Ω—Ç–æ–º - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞"
  
  trigger:
    - event_type: "message"
      event_text: "/tenant"
    - event_type: "callback"
      callback_data: "tenant"

  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç
    - action: "validate"
      params:
        condition: "{_cache.active_tenant_id|exists} == True and {_cache.active_tenant_id|fallback:0} > 0"
      transition:
        - action_result: "success"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_menu"
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_not_selected"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"

# –ú–µ–Ω—é —Ç–µ–Ω–∞–Ω—Ç–∞ (—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è)
tenant_menu:
  description: "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–Ω—é –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞"

  step:
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ —Ç–µ–Ω–∞–Ω—Ç–∞
    - action: "get_tenant_status"
      params:
        tenant_id: "{_cache.active_tenant_id}"
    
    - action: "send_message"
      params:
        text: |
          üè† <b>–ú–µ–Ω—é —Ç–µ–Ω–∞–Ω—Ç–∞ <code>{_cache.active_tenant_id}</code></b>
          
          –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞: <code>{_cache.bot_is_active|equals:True|value:‚úÖ –í–∫–ª—é—á–µ–Ω|fallback:{_cache.bot_is_active|equals:False|value:‚ùå –í—ã–∫–ª—é—á–µ–Ω|fallback:‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ}}</code>
          –°—Ç–∞—Ç—É—Å —Ä–∞–±–æ—Ç—ã: <code>{_cache.bot_is_working|equals:True|value:‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç|fallback:{_cache.bot_is_working|equals:False|value:‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç|fallback:‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ}}</code>

          –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: <code>{_cache.last_updated_at|format:datetime_full|fallback:‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ}</code>
          {_cache.last_error|length|true|value:–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: <code></code>}<code>{_cache.last_failed_at|format:datetime_full}</code>{_cache.last_failed_at|length|true|value: ‚Äî }<code>{_cache.last_error|fallback:}</code>
        inline:
          - [{"üè¢ Tenant Storage": "tenant_storage_menu"}, {"üë§ User Storage": "user_storage_menu"}]
          - [{"‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ–Ω–∞–Ω—Ç–∞": "tenant_config_menu"}, {"üîë –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω": "set_bot_token_input"}]
          - [{"üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö": "sync_tenant_data"}, {"üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å": "tenant"}]
          - [{"üîÄ –°–º–µ–Ω–∏—Ç—å —Ç–µ–Ω–∞–Ω—Ç": "tenant_not_selected"}]

# ============================================
# –ë–õ–û–ö 2: –í—ã–±–æ—Ä —Ç–µ–Ω–∞–Ω—Ç–∞
# ============================================

# –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–µ–Ω–∞–Ω—Ç–∞
tenant_not_selected:
  description: "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤"

  trigger:
    - event_type: "callback"
      callback_data: "tenant_not_selected"
  
  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    - action: "validate"
      params:
        condition: "{_cache.storage_values.admin} == True"
      transition:
        - action_result: "success"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_select_all"
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_select_owner"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_select_owner"

# –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–µ–Ω–∞–Ω—Ç–æ–≤ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
tenant_select_owner:
  description: "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç–µ–Ω–∞–Ω—Ç–æ–≤ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞"

  step:
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–µ–Ω–∞–Ω—Ç—ã
    - action: "validate"
      params:
        condition: "{_cache.storage_values.tenant_owner|exists} == True and {_cache.storage_values.tenant_owner|length} > 0"
      transition:
        - action_result: "success"
          transition_action: "continue"
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_no_access"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # –°—Ç—Ä–æ–∏–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∏–∑ —Ç–µ–Ω–∞–Ω—Ç–æ–≤ –≤–ª–∞–¥–µ–ª—å—Ü–∞
    - action: "build_keyboard"
      params:
        items: "{_cache.storage_values.tenant_owner}"
        keyboard_type: "inline"
        text_template: "–¢–µ–Ω–∞–Ω—Ç $value$"
        callback_template: "select_tenant_$value$"
        buttons_per_row: 3
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
    - action: "send_message"
      params:
        text: |
          üìã <b>–í—ã–±–æ—Ä —Ç–µ–Ω–∞–Ω—Ç–∞</b>
          
          –í—ã–±–µ—Ä–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞:
        inline:
          - "{_cache.keyboard|expand}"
          - [{"üîô –ù–∞–∑–∞–¥": "start"}]

# –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –≤—Å–µ—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤ (–¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)
tenant_select_all:
  description: "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ (—Å–∏—Å—Ç–µ–º–Ω—ã–µ + –ø—É–±–ª–∏—á–Ω—ã–µ)"

  step:
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤
    - action: "get_tenants_list"
      params: {}
    
    # –°—Ç—Ä–æ–∏–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∏–∑ –≤—Å–µ—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤ (—Å–∏—Å—Ç–µ–º–Ω—ã–µ + –ø—É–±–ª–∏—á–Ω—ã–µ)
    - action: "build_keyboard"
      params:
        items: "{_cache.tenant_ids}"
        keyboard_type: "inline"
        text_template: "–¢–µ–Ω–∞–Ω—Ç $value$"
        callback_template: "select_tenant_$value$"
        buttons_per_row: 3
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
    - action: "send_message"
      params:
        text: |
          üìã <b>–í—ã–±–æ—Ä —Ç–µ–Ω–∞–Ω—Ç–∞</b>
          
          –í—ã–±–µ—Ä–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞:
        inline:
          - "{_cache.keyboard|expand}"
          - [{"üîô –ù–∞–∑–∞–¥": "start"}]

# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤
tenant_no_access:
  description: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤"

  step:
    - action: "send_message"
      params:
        text: |
          ‚ÑπÔ∏è <b>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤</b>
          
          –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞.
        inline:
          - [{"üîô –ù–∞–∑–∞–¥": "start"}]

# ============================================
# –ë–õ–û–ö 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ–Ω–∞–Ω—Ç–∞
# ============================================

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ–Ω–∞–Ω—Ç–∞ –∏–∑ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
tenant_select_handler:
  description: "–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ–Ω–∞–Ω—Ç–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ User Storage"

  trigger:
    - event_type: "callback"
      condition: '$callback_data ~ "select_tenant_"'

  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Ç–µ–Ω–∞–Ω—Ç–∞ –∏–∑ callback_data (—Ñ–æ—Ä–º–∞—Ç: select_tenant_105)
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è —Å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º regex
    - action: "validate"
      params:
        condition: '{callback_data|regex:select_tenant_(\d+)|exists} == True'
      transition:
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "invalid_tenant_number"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "invalid_tenant_number"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    - action: "validate"
      params:
        condition: "{_cache.storage_values.admin} == True"
      transition:
        - action_result: "success"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_select_save"
        - action_result: "failed"
          transition_action: "continue"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"
    
    # –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–µ–Ω–∞–Ω—Ç—É
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è —Å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º regex
    - action: "validate"
      params:
        condition: '{callback_data|regex:select_tenant_(\d+)} in {_cache.storage_values.tenant_owner}'
      transition:
        - action_result: "success"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_select_save"
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_access_denied"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞ –≤ User Storage
tenant_select_save:
  description: "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞ –≤ User Storage –∏ –ø–µ—Ä–µ—Ö–æ–¥ –∫ –º–µ–Ω—é"

  step:
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –≤ User Storage
    - action: "set_user_storage"
      params:
        key: "active_tenant_id"
        value: '{callback_data|regex:select_tenant_(\d+)}'
    
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –º–µ–Ω—é —Ç–µ–Ω–∞–Ω—Ç–∞
    - action: "execute_scenario"
      params:
        scenario: "tenant"

# –û—Ç–∫–∞–∑ –≤ –¥–æ—Å—Ç—É–ø–µ –∫ —Ç–µ–Ω–∞–Ω—Ç—É
tenant_access_denied:
  description: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–∫–∞–∑–µ –≤ –¥–æ—Å—Ç—É–ø–µ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–µ–Ω–∞–Ω—Ç—É"

  step:
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</b>
          
          –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–µ–Ω–∞–Ω—Ç—É.
          
          –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞.
        inline:
          - [{"üîô –ö —Å–ø–∏—Å–∫—É —Ç–µ–Ω–∞–Ω—Ç–æ–≤": "tenant_not_selected"}]

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Ç–µ–Ω–∞–Ω—Ç–∞
invalid_tenant_number:
  description: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–≤–µ—Ä–Ω–æ–º –≤—ã–±–æ—Ä–µ —Ç–µ–Ω–∞–Ω—Ç–∞"
  
  step:
    - action: "send_message"
      params:
        text: |
          ‚ö†Ô∏è <b>–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ–Ω–∞–Ω—Ç–∞</b>
          
          –í—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
          
          –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å —Ç–µ–Ω–∞–Ω—Ç —Å–Ω–æ–≤–∞.
        inline:
          - [{"üîô –ö —Å–ø–∏—Å–∫—É —Ç–µ–Ω–∞–Ω—Ç–æ–≤": "tenant_not_selected"}]

# ============================================
# –ë–õ–û–ö 4: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
# ============================================

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞
sync_tenant_data:
  description: "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞ (–±–æ—Ç + —Å—Ü–µ–Ω–∞—Ä–∏–∏ + storage)"

  trigger:
    - event_type: "callback"
      callback_data: "sync_tenant_data"

  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    - action: "send_message"
      params:
        text: |
          ‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–∞...
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id|fallback:–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π}</code>
    
    # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞ (pull –∏–∑ GitHub + —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö)
    - action: "sync_tenant"
      params:
        tenant_id: "{_cache.active_tenant_id}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "default_error"

    # –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
    - action: "send_message"
      params:
        text: |
          ‚úÖ –î–∞–Ω–Ω—ã–µ —Ç–µ–Ω–∞–Ω—Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
      transition:
        - action_result: "any"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_menu"

# ============================================
# –ë–õ–û–ö 5: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞
# ============================================

# –ó–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞
set_bot_token_input:
  description: "–ó–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏"

  trigger:
    - event_type: "callback"
      callback_data: "set_bot_token_input"

  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
    - action: "send_message"
      params:
        text: |
          üîë <b>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞</b>
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
          
          –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏.
          
          –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –≤–≤–µ–¥–∏—Ç–µ <code>null</code> –∏–ª–∏ <code>none</code> (–≤ –ª—é–±–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ).
          
          ‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ:</b> –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Ç–æ–∫–µ–Ω–∞.
        inline:
          - [{"‚ùå –û—Ç–º–µ–Ω–∞": "tenant"}]
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞
    - action: "set_user_state"
      params:
        state: "set_bot_token"
        expires_in_seconds: 300

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ç–æ–∫–µ–Ω–∞
set_bot_token_handler:
  description: "–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞"

  trigger:
    - event_type: "message"
      user_state: "set_bot_token"

  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤–≤–æ–¥ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π
    - action: "execute_scenario"
      params:
        scenario: "check_message"
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    - action: "clear_user_state"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–≤–æ–¥ null/none (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞)
    - action: "validate"
      params:
        condition: '{event_text|lower} == "null" or {event_text|lower} == "none"'
      transition:
        - action_result: "success"
          transition_action: "jump_to_scenario"
          transition_value: "set_bot_token_delete"
        - action_result: "failed"
          transition_action: "continue"
        - action_result: "error"
          transition_action: "continue"
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–æ–∫–µ–Ω–∞ (—á–∏—Å–ª–æ:—Å—Ç—Ä–æ–∫–∞)
    - action: "validate"
      params:
        condition: '$event_text regex "^\\d+:[A-Za-z0-9_-]+$"'
      transition:
        - action_result: "success"
          transition_action: "continue"
        - action_result: "failed"
          transition_action: "jump_to_scenario"
          transition_value: "set_bot_token_invalid_format"
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "set_bot_token_invalid_format"
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–∞—á–∞–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    - action: "send_message"
      params:
        text: |
          ‚è≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞...
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
    - action: "set_bot_token"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        bot_token: "{event_text}"
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "set_bot_token_error"
    
    # –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
    - action: "send_message"
      params:
        text: |
          ‚úÖ –¢–æ–∫–µ–Ω –±–æ—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
          
          –¢–æ–∫–µ–Ω –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—É–ª–∏–Ω–≥–∞.
        message_edit: "{_cache.last_message_id}"
      transition:
        - action_result: "any"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_menu"

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–æ–∫–µ–Ω–∞
set_bot_token_invalid_format:
  description: "–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–æ–∫–µ–Ω–∞"

  step:
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞</b>
          
          –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —Ñ–æ—Ä–º–∞—Ç: <code>—á–∏—Å–ª–æ:—Å—Ç—Ä–æ–∫–∞</code>
          
          –ü—Ä–∏–º–µ—Ä: <code>123456789:ABCdefGHIjklMNOpqrsTUVwxyz</code>
          
          –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.
        inline:
          - [{"üîô –ö –º–µ–Ω—é —Ç–µ–Ω–∞–Ω—Ç–∞": "tenant"}]

# –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ (—á–µ—Ä–µ–∑ –≤–≤–æ–¥ null/none)
set_bot_token_delete:
  description: "–£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ –≤–≤–æ–¥ null/none"

  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check"
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–∑ User Storage
    - action: "get_user_storage"
      params:
        key: "active_tenant_id"
        _response_key: "active_tenant_id"
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–∞—á–∞–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
    - action: "send_message"
      params:
        text: |
          ‚è≥ –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞...
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
    
    # –£–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ (–ø–µ—Ä–µ–¥–∞–µ–º null)
    - action: "set_bot_token"
      params:
        tenant_id: "{_cache.active_tenant_id}"
        bot_token: null
      transition:
        - action_result: "error"
          transition_action: "jump_to_scenario"
          transition_value: "set_bot_token_error"
    
    # –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
    - action: "send_message"
      params:
        text: |
          ‚úÖ –¢–æ–∫–µ–Ω –±–æ—Ç–∞ —É–¥–∞–ª–µ–Ω
          
          –¢–µ–Ω–∞–Ω—Ç: <code>{_cache.active_tenant_id}</code>
          
          –¢–æ–∫–µ–Ω –±—ã–ª —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞. –ü—É–ª–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
        message_edit: "{_cache.last_message_id}"
      transition:
        - action_result: "any"
          transition_action: "jump_to_scenario"
          transition_value: "tenant_menu"

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ–∫–µ–Ω–∞
set_bot_token_error:
  description: "–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ–∫–µ–Ω–∞"

  step:
    - action: "send_message"
      params:
        text: |
          ‚ùå <b>–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ–∫–µ–Ω–∞</b>
          
          –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
          ‚Ä¢ –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
          ‚Ä¢ –¢–æ–∫–µ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º

          ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <code>{user_id}</code>
          –õ–æ–≥ –æ—à–∏–±–∫–∏: <code>{last_error.message|fallback:–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞}</code>
        inline:
          - [{"üîô –ö –º–µ–Ω—é —Ç–µ–Ω–∞–Ω—Ç–∞": "tenant"}]

