# –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
# –°–∫—Ä—ã—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞ /mail - –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ –∫–æ–º–∞–Ω–¥

# –ö–æ–º–∞–Ω–¥–∞ /mail - –ø–µ—Ä–µ—Ö–æ–¥ –≤ –º–µ–Ω—é —Ä–∞—Å—Å—ã–ª–∫–∏
mail:
  description: "–°–∫—Ä—ã—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π"
  
  trigger:
    - event_type: "message"
      event_text: "/mail"

  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check_admin"

    # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –º–µ–Ω—é —Ä–∞—Å—Å—ã–ª–∫–∏
    - action: "execute_scenario"
      params:
        scenario: "mailing_menu"

# –ú–µ–Ω—é —Ä–∞—Å—Å—ã–ª–∫–∏ —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Å–ø–∏—Å–∫–æ–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
mailing_menu:
  description: "–ú–µ–Ω—é —Ä–∞—Å—Å—ã–ª–∫–∏ —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Å–ø–∏—Å–∫–æ–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π"

  step:
    # –ü–æ–ª—É—á–∞–µ–º –≥—Ä—É–ø–ø—É mailing –∏–∑ storage
    - action: "get_storage"
      params:
        group_key: "mailing"
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏ (–∫–∞–∫ –æ–Ω–æ –±—É–¥–µ—Ç —É—Ö–æ–¥–∏—Ç—å)
    - action: "send_message"
      params:
        text: "{_cache.storage_values.text}"
        attachment: "{_cache.storage_values.attachment|fallback:}"
        message_edit: false
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è—Ö –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    - action: "send_message"
      params:
        text: |
          <b>–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:</b>
          {_cache.storage_values.recipients|list}
          
          <b>–í—Å–µ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π:</b> <code>{_cache.storage_values.recipients|length}</code>
        inline:
          - [{"‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å": "mailing_send"}]
          - [{"üîô –ù–∞–∑–∞–¥": "start"}]
        message_edit: false

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏
mailing_send:
  description: "–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ –≤—Å–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º"
  
  trigger:
    - event_type: "callback"
      callback_data: "mailing_send"

  step:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    - action: "execute_scenario"
      params:
        scenario: "access_check_admin"
    
    # –ü–æ–ª—É—á–∞–µ–º –≥—Ä—É–ø–ø—É mailing –∏–∑ storage
    - action: "get_storage"
      params:
        group_key: "mailing"
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ —Ä–∞—Å—Å—ã–ª–∫–∏
    - action: "send_message"
      params:
        text: |
          ‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏...
          
          –ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π: <code>{_cache.storage_values.recipients|length}</code>
        message_edit: false
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º
    - action: "send_message"
      params:
        target_chat_id: "{_cache.storage_values.recipients}"
        text: "{_cache.storage_values.text}"
        attachment: "{_cache.storage_values.attachment|fallback:}"
        message_edit: false
    
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ
    - action: "send_message"
      params:
        text: |
          ‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!
          
          –ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π: <code>{_cache.storage_values.recipients|length}</code>
        message_edit: false
